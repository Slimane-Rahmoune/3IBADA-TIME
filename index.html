<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>جدول إدارة الوقت</title>
<style>
  :root{
    --bg:#eef6ff;--card:#fff;--text:#1b2a41;--muted:#5f6b7a;--shadow:0 1px 4px rgba(0,0,0,.12);
    --brand:#1e88e5;--now:#13b38b;--accent:#0ea5e9;
  }
  html,body{height:100%}
  body{margin:14px;background:var(--bg);font-family:Tahoma,Arial,sans-serif;color:var(--text)}
  .wrap{max-width:1000px;margin:0 auto}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .row{display:flex;gap:10px;align-items:center}
  select,button,input[type="text"],input[type="number"]{border:1px solid #cfd8e3;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
  .primary{background:var(--brand);color:#fff;border:none}
  .card{background:var(--card);box-shadow:var(--shadow);border-radius:12px;padding:12px;margin:12px 0}
  .muted{color:var(--muted);font-size:12px}

  /* nav */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid #cfd8e3;background:#fff;cursor:pointer}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

  /* tasks */
  .task{display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid #e9eef5;border-radius:10px;margin:8px 0}
  .left{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .time{font-weight:bold;min-width:150px}
  .badge{font-size:12px;background:#e8f1ff;border:1px solid #cfe0ff;border-radius:999px;padding:4px 8px}
  .now{border-color:var(--now);box-shadow:0 0 0 2px rgba(19,179,139,.15)}
  .now .badge{background:#e9fff7;border-color:#b9f1df}
  .nowTag{font-size:12px;color:#0f8a6a;margin-inline-start:6px}
  .done{text-decoration:line-through;color:#777}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-bottom:8px}
  .status{min-height:18px;margin-top:6px}
  input[type="checkbox"]{width:20px;height:20px;accent-color:var(--brand)}
  @media (max-width:560px){.time{min-width:auto}}

  /* adhkar */
  .dhk{border:1px solid #e6ebf2;border-radius:10px;padding:12px;margin:10px 0}
  .dhk h4{margin:0 0 8px 0;font-size:16px}
  .dhk p{margin:6px 0}
  .dhk .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .counter{min-width:40px;text-align:center;border-radius:8px;border:1px solid #cfd8e3;padding:4px 8px}
  .tag{display:inline-block;font-size:12px;background:#fafafa;border:1px solid #e8e8e8;border-radius:999px;padding:2px 8px;margin-inline-start:6px}

  /* quran */
  .qrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  iframe{width:100%;height:70vh;border:none;border-radius:12px;box-shadow:var(--shadow)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="title">🕰️ جدول إدارة الوقت على منهج النبي ﷺ</h1>
    <div class="row">
      <label for="lang" id="langLabel">اللغة:</label>
      <select id="lang">
        <option value="ar">العربية</option>
        <option value="fr">Français</option>
        <option value="en">English</option>
      </select>
      <button id="notifyBtn" class="primary">🔔 فعل الإشعارات</button>
    </div>
  </header>

  <!-- NAV -->
  <div class="tabs">
    <button class="tab active" data-page="plan" id="tab-plan">📋 التخطيط</button>
    <button class="tab" data-page="adhkar" id="tab-adhkar">🕯️ الأذكار</button>
    <button class="tab" data-page="quran" id="tab-quran">📖 القرآن</button>
  </div>

  <!-- PAGE: PLAN -->
  <section id="page-plan" class="card">
    <div class="toolbar">
      <button id="checkAll" class="primary">✅ تحديد الكل</button>
      <button id="uncheckAll">↩️ إلغاء تحديد الكل</button>
      <button id="resetDay">🗓️ تصفير هذا اليوم</button>
    </div>
    <div id="tasks"></div>
    <div id="progress" class="status muted"></div>
  </section>

  <!-- PAGE: ADHKAR -->
  <section id="page-adhkar" class="card" style="display:none">
    <div class="qrow">
      <label for="slotSel" id="slotLabel">اختر الفترة:</label>
      <select id="slotSel"></select>
      <button id="resetAdhkar" class="primary">↺ تصفير العدادات</button>
    </div>
    <div id="adhkarList"></div>
    <p class="muted" id="adhkarHint">يتم حفظ العدادات محليًا لكل فترة ولغة.</p>
  </section>

  <!-- PAGE: QURAN -->
  <section id="page-quran" class="card" style="display:none">
    <div class="qrow">
      <label id="qLabel1">سورة:</label>
      <select id="surahSel"></select>
      <label id="qLabel2">جزء (Juz):</label>
      <select id="juzSel"></select>
      <button id="openSurah" class="primary">فتح</button>
      <button id="markRead">✅ تمّت القراءة</button>
      <button id="resetRead">↺ تصفير</button>
    </div>
    <div class="muted" id="readStatus"></div>
    <iframe id="qFrame" title="Quran"></iframe>
    <p class="muted" id="qHint">ملاحظة: يتم تضمين قارئ من quran.com. قد يطلب المتصفح السماح بالتضمين.</p>
  </section>

  <p class="muted" id="hint">
    ملاحظة: يتم حفظ إنجازاتك محليًا يوميًا. تغيّر اللغة يغيّر أيضًا اتجاه الصفحة ونصوص المهام.
  </p>
</div>

<script>
/* ======================= I18N & DATA ======================= */
const T = {
  ar:{
    title:"🕰️ جدول إدارة الوقت على منهج النبي ﷺ",
    lang:"اللغة:",
    notify:"🔔 فعل الإشعارات",
    tabs:{plan:"📋 التخطيط", adhkar:"🕯️ الأذكار", quran:"📖 القرآن"},
    // plan
    checkAll:"✅ تحديد الكل", uncheckAll:"↩️ إلغاء تحديد الكل", resetDay:"🗓️ تصفير هذا اليوم",
    hint:"ملاحظة: يتم حفظ إنجازاتك محليًا يوميًا. تغيّر اللغة يغيّر أيضًا اتجاه الصفحة ونصوص المهام.",
    notified:"✅ تم تفعيل الإشعارات", noNotif:"🚫 متصفحك لا يدعم الإشعارات",
    now:"أنت الآن هنا", interval:(a,b)=>`${a} – ${b}`,
    tasks:[
      {start:"04:30", end:"05:30", time:"قبل الفجر", action:"قيام الليل وذكر الله"},
      {start:"05:30", end:"07:00", time:"الفجر – الشروق", action:"صلاة الفجر + ذكر وقرآن"},
      {start:"07:00", end:"10:00", time:"الصباح", action:"عمل/دراسة بنية لله"},
      {start:"10:00", end:"12:30", time:"الضحى", action:"ركعتان أو أربع"},
      {start:"12:30", end:"15:30", time:"الظهر", action:"صلاة + قيلولة"},
      {start:"15:30", end:"18:30", time:"العصر – المغرب", action:"عمل/علم + رياضة"},
      {start:"18:30", end:"21:00", time:"المغرب – العشاء", action:"جلسة عائلية + قرآن"},
      {start:"21:00", end:"23:00", time:"العشاء", action:"صلاة + راحة/مطالعة"},
      {start:"23:00", end:"04:30", time:"الليل", action:"نوم مبكر + قيام الليل"}
    ],
    progress:(d,t)=>`إنجاز اليوم: ${d}/${t} (${Math.round(d*100/t)}%)`,
    // adhkar
    slotLabel:"اختر الفترة:",
    adhkarHint:"يتم حفظ العدادات محليًا لكل فترة ولغة.",
    resetAdhkar:"↺ تصفير العدادات",
    slots:[
      {key:"morning", name:"أذكار الصباح"},
      {key:"afterPrayer", name:"بعد الصلوات"},
      {key:"evening", name:"أذكار المساء"},
      {key:"sleep", name:"قبل النوم"}
    ],
    adhkar:{
      morning:[
        {txt:"أصبحنا وأصبح الملك لله…", count:1, ref:"مسلم"},
        {txt:"سيد الاستغفار: اللهم أنت ربي لا إله إلا أنت…", count:1, ref:"البخاري"},
        {txt:"سبحان الله وبحمده", count:100, ref:"مسلم"}
      ],
      afterPrayer:[
        {txt:"أستغفر الله (٣) ثم: اللهم أنت السلام ومنك السلام…", count:1, ref:"مسلم"},
        {txt:"التسبيح 33، التحميد 33، التكبير 33، تمام المئة: لا إله إلا الله…", count:1, ref:"مسلم"}
      ],
      evening:[
        {txt:"أمسينا وأمسى الملك لله…", count:1, ref:"مسلم"},
        {txt:"آية الكرسي", count:1, ref:"النسائي"},
        {txt:"قل هو الله أحد + المعوذتان", count:3, ref:"أبو داود"}
      ],
      sleep:[
        {txt:"باسمك اللهم أموت وأحيا", count:1, ref:"البخاري"},
        {txt:"آية الكرسي", count:1, ref:"البخاري"},
        {txt:"قل هو الله أحد + المعوذتان", count:1, ref:"البخاري"}
      ]
    },
    // quran
    qLabel1:"سورة:", qLabel2:"جزء (Juz):",
    open:"فتح", markRead:"✅ تمّت القراءة", resetRead:"↺ تصفير",
    readSaved:(s)=>`آخر قراءة محفوظة: ${s}`
  },
  fr:{
    title:"🕰️ Planning d’adorations – Méthode prophétique ﷺ",
    lang:"Langue :",
    notify:"🔔 Activer les notifications",
    tabs:{plan:"📋 Planning", adhkar:"🕯️ Adhkâr", quran:"📖 Coran"},
    checkAll:"✅ Tout cocher", uncheckAll:"↩️ Tout décocher", resetDay:"🗓️ Réinitialiser la journée",
    hint:"Astuce : vos données sont enregistrées localement. Le changement de langue adapte aussi l’orientation et les textes.",
    notified:"✅ Notifications activées", noNotif:"🚫 Notifications non supportées",
    now:"Vous êtes ici", interval:(a,b)=>`${a} – ${b}`,
    tasks:[
      {start:"04:30", end:"05:30", time:"Avant l’aube", action:"Qiyâm & rappels"},
      {start:"05:30", end:"07:00", time:"Fajr – Lever du soleil", action:"Prière du Fajr + Coran & invocations"},
      {start:"07:00", end:"10:00", time:"Matin", action:"Travail/Études avec intention sincère"},
      {start:"10:00", end:"12:30", time:"Duha", action:"2 à 4 unités de prière"},
      {start:"12:30", end:"15:30", time:"Dhuhr", action:"Prière + petite sieste"},
      {start:"15:30", end:"18:30", time:"‘Asr – Maghrib", action:"Travail/Savoir + Sport"},
      {start:"18:30", end:"21:00", time:"Maghrib – ‘Isha", action:"Temps en famille + Coran"},
      {start:"21:00", end:"23:00", time:"‘Isha", action:"Prière + Lecture/Repos"},
      {start:"23:00", end:"04:30", time:"Nuit", action:"Coucher tôt + Qiyâm"}
    ],
    progress:(d,t)=>`Progression du jour : ${d}/${t} (${Math.round(d*100/t)}%)`,
    slotLabel:"Choisir un créneau :", adhkarHint:"Les compteurs sont enregistrés localement par créneau et langue.",
    resetAdhkar:"↺ Réinitialiser",
    slots:[
      {key:"morning", name:"Adhkâr du matin"},
      {key:"afterPrayer", name:"Après les prières"},
      {key:"evening", name:"Adhkâr du soir"},
      {key:"sleep", name:"Avant de dormir"}
    ],
    adhkar:{
      morning:[
        {txt:"Nous entrons au matin et la royauté appartient à Allah…", count:1, ref:"Muslim"},
        {txt:"Sayyid al-Istighfâr", count:1, ref:"Bukhari"},
        {txt:"SubhânAllâh wa bi-hamdih", count:100, ref:"Muslim"}
      ],
      afterPrayer:[
        {txt:"Istighfar (3) puis « Allahumma anta as-Salâm… »", count:1, ref:"Muslim"},
        {txt:"33 tasbîh, 33 tahmîd, 33 takbîr + tamâm 100", count:1, ref:"Muslim"}
      ],
      evening:[
        {txt:"Nous entrons au soir et la royauté appartient à Allah…", count:1, ref:"Muslim"},
        {txt:"Ayat al-Kursî", count:1, ref:"Nasa'i"},
        {txt:"Ikhlâs + Falaq + Nâs", count:3, ref:"Abu Dawud"}
      ],
      sleep:[
        {txt:"« Bismika Allâhumma amûtu wa ahyâ »", count:1, ref:"Bukhari"},
        {txt:"Ayat al-Kursî", count:1, ref:"Bukhari"},
        {txt:"Ikhlâs + Falaq + Nâs", count:1, ref:"Bukhari"}
      ]
    },
    qLabel1:"Sourate :", qLabel2:"Juz :", open:"Ouvrir", markRead:"✅ Lu", resetRead:"↺ Réinitialiser",
    readSaved:(s)=>`Dernière lecture sauvegardée : ${s}`
  },
  en:{
    title:"🕰️ Time Management – Prophetic Way ﷺ",
    lang:"Language:",
    notify:"🔔 Enable notifications",
    tabs:{plan:"📋 Plan", adhkar:"🕯️ Adhkar", quran:"📖 Quran"},
    checkAll:"✅ Check all", uncheckAll:"↩️ Uncheck all", resetDay:"🗓️ Reset today",
    hint:"Tip: your data is stored locally per day. Language also flips layout and texts.",
    notified:"✅ Notifications enabled", noNotif:"🚫 Notifications not supported",
    now:"You are here", interval:(a,b)=>`${a} – ${b}`,
    tasks:[
      {start:"04:30", end:"05:30", time:"Before Fajr", action:"Qiyam & remembrance"},
      {start:"05:30", end:"07:00", time:"Fajr – Sunrise", action:"Fajr + Qur’an & adhkar"},
      {start:"07:00", end:"10:00", time:"Morning", action:"Work/Study with sincere intention"},
      {start:"10:00", end:"12:30", time:"Duha", action:"2–4 units of prayer"},
      {start:"12:30", end:"15:30", time:"Dhuhr", action:"Prayer + short nap"},
      {start:"15:30", end:"18:30", time:"Asr – Maghrib", action:"Work/Knowledge + Exercise"},
      {start:"18:30", end:"21:00", time:"Maghrib – Isha", action:"Family time + Qur’an"},
      {start:"21:00", end:"23:00", time:"Isha", action:"Prayer + Reading/Rest"},
      {start:"23:00", end:"04:30", time:"Night", action:"Sleep early + Qiyam"}
    ],
    progress:(d,t)=>`Today’s progress: ${d}/${t} (${Math.round(d*100/t)}%)`,
    slotLabel:"Choose slot:", adhkarHint:"Counters are saved locally for each slot and language.",
    resetAdhkar:"↺ Reset counters",
    slots:[
      {key:"morning", name:"Morning adhkar"},
      {key:"afterPrayer", name:"After prayers"},
      {key:"evening", name:"Evening adhkar"},
      {key:"sleep", name:"Before sleep"}
    ],
    adhkar:{
      morning:[
        {txt:"We enter the morning and the dominion belongs to Allah…", count:1, ref:"Muslim"},
        {txt:"Sayyid al-Istighfar", count:1, ref:"Bukhari"},
        {txt:"SubhanAllah wa bi-hamdih", count:100, ref:"Muslim"}
      ],
      afterPrayer:[
        {txt:"Istighfar (3) then: Allahumma anta as-Salam…", count:1, ref:"Muslim"},
        {txt:"33 Tasbih, 33 Tahmid, 33 Takbir + completion to 100", count:1, ref:"Muslim"}
      ],
      evening:[
        {txt:"We enter the evening and the dominion belongs to Allah…", count:1, ref:"Muslim"},
        {txt:"Ayat al-Kursi", count:1, ref:"Nasa'i"},
        {txt:"Ikhlas + Falaq + Nas", count:3, ref:"Abu Dawud"}
      ],
      sleep:[
        {txt:"Bismika Allahumma amutu wa ahya", count:1, ref:"Bukhari"},
        {txt:"Ayat al-Kursi", count:1, ref:"Bukhari"},
        {txt:"Ikhlas + Falaq + Nas", count:1, ref:"Bukhari"}
      ]
    },
    qLabel1:"Surah:", qLabel2:"Juz:", open:"Open", markRead:"✅ Mark read", resetRead:"↺ Reset",
    readSaved:(s)=>`Last saved reading: ${s}`
  }
};

// Simple list of 114 surahs
const SURAH_NAMES = [
  "Al-Fātiḥah","Al-Baqarah","Āl ‘Imrān","An-Nisā’","Al-Mā’idah","Al-An‘ām","Al-A‘rāf","Al-Anfāl","At-Tawbah","Yūnus",
  "Hūd","Yūsuf","Ar-Ra‘d","Ibrāhīm","Al-Ḥijr","An-Naḥl","Al-Isrā’","Al-Kahf","Maryam","Ṭā Hā",
  "Al-Anbiyā’","Al-Ḥajj","Al-Mu’minūn","An-Nūr","Al-Furqān","Ash-Shu‘arā’","An-Naml","Al-Qaṣaṣ","Al-‘Ankabūt","Ar-Rūm",
  "Luqmān","As-Sajdah","Al-Aḥzāb","Saba’","Fāṭir","Yā Sīn","As-Ṣāffāt","Ṣād","Az-Zumar","Ghāfir",
  "Fuṣṣilat","Ash-Shūrā","Az-Zukhruf","Ad-Dukhān","Al-Jāthiyah","Al-Aḥqāf","Muḥammad","Al-Fatḥ","Al-Ḥujurāt","Qāf",
  "Adh-Dhāriyāt","Aṭ-Ṭūr","An-Najm","Al-Qamar","Ar-Raḥmān","Al-Wāqi‘ah","Al-Ḥadīd","Al-Mujādilah","Al-Ḥashr","Al-Mumtaḥanah",
  "Aṣ-Ṣaff","Al-Jumu‘ah","Al-Munāfiqūn","At-Taghābun","Aṭ-Ṭalāq","At-Taḥrīm","Al-Mulk","Al-Qalam","Al-Ḥāqqah","Al-Ma‘ārij",
  "Nūḥ","Al-Jinn","Al-Muzzammil","Al-Muddaththir","Al-Qiyāmah","Al-Insān","Al-Mursalāt","An-Naba’","An-Nāzi‘āt","‘Abasa",
  "At-Takwīr","Al-Infiṭār","Al-Muṭaffifīn","Al-Inshiqāq","Al-Burūj","Aṭ-Ṭāriq","Al-A‘lā","Al-Ghāshiyah","Al-Fajr","Al-Balad",
  "Ash-Shams","Al-Layl","Aḍ-Ḍuḥā","Ash-Sharḥ","At-Tīn","Al-‘Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-‘Ādiyāt",
  "Al-Qāri‘ah","At-Takāthur","Al-‘Aṣr","Al-Humazah","Al-Fīl","Quraysh","Al-Mā‘ūn","Al-Kawthar","Al-Kāfirūn","An-Naṣr",
  "Al-Masad","Al-Ikhlāṣ","Al-Falaq","An-Nās"
];

/* ======================= HELPERS ======================= */
const $ = s => document.querySelector(s);
const todayKey = () => new Date().toISOString().slice(0,10);
const prefLangKey = "pref_lang";
const planStoreKey = lang => `done_${todayKey()}_${lang}`;
const adhkarStoreKey = (lang,slot) => `adhkar_${todayKey()}_${lang}_${slot}`;
const quranStoreKey = lang => `qread_${todayKey()}_${lang}`;

function loadJSON(k){ try{return JSON.parse(localStorage.getItem(k)||"{}");}catch{return {}} }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ======================= ELEMENTS ======================= */
const titleEl=$("#title"), langSel=$("#lang"), notifyBtn=$("#notifyBtn"),
      tabPlan=$("#tab-plan"), tabAdhkar=$("#tab-adhkar"), tabQuran=$("#tab-quran"),
      pagePlan=$("#page-plan"), pageAdhkar=$("#page-adhkar"), pageQuran=$("#page-quran"),
      hintEl=$("#hint");

const checkAllBtn=$("#checkAll"), uncheckAllBtn=$("#uncheckAll"), resetDayBtn=$("#resetDay"),
      tasksEl=$("#tasks"), progressEl=$("#progress");

const slotLabel=$("#slotLabel"), slotSel=$("#slotSel"), adhkarList=$("#adhkarList"),
      resetAdhkar=$("#resetAdhkar"), adhkarHint=$("#adhkarHint");

const qLabel1=$("#qLabel1"), qLabel2=$("#qLabel2"), surahSel=$("#surahSel"),
      juzSel=$("#juzSel"), openSurah=$("#openSurah"), qFrame=$("#qFrame"),
      markRead=$("#markRead"), resetRead=$("#resetRead"), readStatus=$("#readStatus"),
      qHint=$("#qHint");

/* ======================= TIME UTILS ======================= */
function timeToDate(hhmm){
  const [h,m]=hhmm.split(":").map(n=>parseInt(n,10));
  const n=new Date();
  return new Date(n.getFullYear(),n.getMonth(),n.getDate(),h,m,0,0);
}
function isNowInInterval(start,end){
  const now=new Date();
  let s=timeToDate(start), e=timeToDate(end);
  if(e<=s){ e=new Date(e.getTime()+24*60*60*1000); }
  let n=now;
  if(now<s && e-s>12*60*60*1000) n=new Date(now.getTime()+24*60*60*1000);
  return n>=s && n<e;
}

/* ======================= RENDER: PLAN ======================= */
function renderPlan(lang, L){
  $("#tab-plan").textContent=L.tabs.plan;
  checkAllBtn.textContent=L.checkAll;
  uncheckAllBtn.textContent=L.uncheckAll;
  resetDayBtn.textContent=L.resetDay;

  const doneMap=loadJSON(planStoreKey(lang));
  tasksEl.innerHTML="";
  L.tasks.forEach((t,i)=>{
    const checked=!!doneMap[i];
    const row=document.createElement("div");
    row.className="task";
    const nowTag=isNowInInterval(t.start,t.end)?`<span class="nowTag">• ${L.now}</span>`:"";
    if(nowTag) row.classList.add("now");
    row.innerHTML=`
      <div class="left">
        <input type="checkbox" id="chk-${i}" ${checked?"checked":""} />
        <span class="time">${t.time}:</span>
        <span id="txt-${i}" class="${checked?"done":""}">${t.action}</span>
        <span class="badge">${L.interval(t.start,t.end)}</span>
        ${nowTag}
      </div>
      <div></div>
    `;
    tasksEl.appendChild(row);
  });
  L.tasks.forEach((_,i)=>{
    $("#chk-"+i).addEventListener("change", e=>{
      const dm=loadJSON(planStoreKey(lang));
      dm[i]=e.target.checked;
      saveJSON(planStoreKey(lang), dm);
      $("#txt-"+i).classList.toggle("done", e.target.checked);
      updateProgress(lang,L);
    });
  });
  updateProgress(lang,L);
}
function updateProgress(lang,L){
  const dm=loadJSON(planStoreKey(lang));
  const total=L.tasks.length, done=Object.values(dm).filter(Boolean).length;
  progressEl.textContent=L.progress(done,total);
}

/* ======================= RENDER: ADHKAR ======================= */
function renderAdhkar(lang, L){
  $("#tab-adhkar").textContent=L.tabs.adhkar;
  slotLabel.textContent=L.slotLabel;
  resetAdhkar.textContent=L.resetAdhkar;
  adhkarHint.textContent=L.adhkarHint;

  // slots dropdown
  slotSel.innerHTML="";
  L.slots.forEach(s=>{
    const opt=document.createElement("option");
    opt.value=s.key; opt.textContent=s.name;
    slotSel.appendChild(opt);
  });
  const current=localStorage.getItem("adh_slot_"+lang) || L.slots[0].key;
  slotSel.value=current;

  const list = L.adhkar[current] || [];
  drawAdhkarList(lang, current, list);

  slotSel.onchange=()=>{
    localStorage.setItem("adh_slot_"+lang, slotSel.value);
    drawAdhkarList(lang, slotSel.value, L.adhkar[slotSel.value]||[]);
  };
  resetAdhkar.onclick=()=>{
    localStorage.removeItem(adhkarStoreKey(lang, slotSel.value));
    drawAdhkarList(lang, slotSel.value, L.adhkar[slotSel.value]||[]);
  };
}
function drawAdhkarList(lang, slotKey, list){
  adhkarList.innerHTML="";
  const counts=loadJSON(adhkarStoreKey(lang,slotKey));
  list.forEach((d,idx)=>{
    const need = d.count || 1;
    const cur = counts[idx] || 0;
    const div=document.createElement("div");
    div.className="dhk";
    div.innerHTML=`
      <h4>${d.txt}</h4>
      <p class="muted">${d.ref ? `<span class="tag">${d.ref}</span>` : ""}<span class="tag">x${need}</span></p>
      <div class="controls">
        <button class="primary" id="plus-${idx}">+1</button>
        <button id="minus-${idx}">-1</button>
        <span class="counter" id="count-${idx}">${cur}/${need}</span>
        <button id="done-${idx}">✅</button>
        <button id="reset-${idx}">↺</button>
      </div>
    `;
    adhkarList.appendChild(div);

    const update=(v)=>{
      const c=Math.max(0, Math.min(need, v));
      counts[idx]=c; saveJSON(adhkarStoreKey(lang,slotKey), counts);
      $("#count-"+idx).textContent=`${c}/${need}`;
    };
    $("#plus-"+idx).onclick=()=>update( (counts[idx]||0) + 1 );
    $("#minus-"+idx).onclick=()=>update( (counts[idx]||0) - 1 );
    $("#done-"+idx).onclick=()=>update( need );
    $("#reset-"+idx).onclick=()=>update( 0 );
  });
}

/* ======================= RENDER: QURAN ======================= */
function renderQuran(lang, L){
  $("#tab-quran").textContent=L.tabs.quran;
  qLabel1.textContent=L.qLabel1;
  qLabel2.textContent=L.qLabel2;
  openSurah.textContent=L.open;
  markRead.textContent=L.markRead;
  resetRead.textContent=L.resetRead;

  // surah list
  surahSel.innerHTML="";
  SURAH_NAMES.forEach((name,i)=>{
    const o=document.createElement("option");
    o.value=String(i+1);
    o.textContent=`${i+1}. ${name}`;
    surahSel.appendChild(o);
  });

  // juz list 1..30
  juzSel.innerHTML="";
  for(let j=1;j<=30;j++){
    const o=document.createElement("option");
    o.value=String(j); o.textContent=`Juz ${j}`;
    juzSel.appendChild(o);
  }

  const saved = localStorage.getItem(quranStoreKey(lang));
  readStatus.textContent = saved ? L.readSaved(saved) : "";

  openSurah.onclick=()=>{
    const s=surahSel.value;
    // URL du lecteur (quran.com) — change locale par langue si souhaité
    const url=`https://quran.com/${s}?reading=false&translations=131&locale=${lang==='ar'?'ar':(lang==='fr'?'fr':'en')}`;
    qFrame.src=url;
  };
  markRead.onclick=()=>{
    const label = `Surah ${surahSel.value} / Juz ${juzSel.value}`;
    localStorage.setItem(quranStoreKey(lang), label);
    readStatus.textContent=L.readSaved(label);
  };
  resetRead.onclick=()=>{
    localStorage.removeItem(quranStoreKey(lang));
    readStatus.textContent="";
  };
}

/* ======================= NOTIFICATIONS ======================= */
function enableNotifications(L){
  if(!("Notification" in window)){ alert(L.noNotif); return; }
  if(Notification.permission==="granted"){
    new Notification(L.notified);
  }else if(Notification.permission!=="denied"){
    Notification.requestPermission().then(p=>{ if(p==="granted") new Notification(L.notified); });
  }
}

/* ======================= PAGES / LANG / INIT ======================= */
function showPage(key){
  [pagePlan,pageAdhkar,pageQuran].forEach(p=>p.style.display="none");
  [tabPlan,tabAdhkar,tabQuran].forEach(t=>t.classList.remove("active"));
  if(key==="plan"){ pagePlan.style.display="block"; tabPlan.classList.add("active"); }
  if(key==="adhkar"){ pageAdhkar.style.display="block"; tabAdhkar.classList.add("active"); }
  if(key==="quran"){ pageQuran.style.display="block"; tabQuran.classList.add("active"); }
  localStorage.setItem("last_page", key);
}

function renderAll(lang){
  const rtl = (lang==="ar");
  document.documentElement.lang=lang;
  document.documentElement.dir=rtl?"rtl":"ltr";
  document.body.style.direction=rtl?"rtl":"ltr";

  const L=T[lang];
  titleEl.textContent=L.title;
  $("#langLabel").textContent=L.lang;
  notifyBtn.textContent=L.notify;
  hintEl.textContent=L.hint;

  renderPlan(lang,L);
  renderAdhkar(lang,L);
  renderQuran(lang,L);
}

document.addEventListener("DOMContentLoaded", ()=>{
  const initLang = localStorage.getItem(prefLangKey) || "ar";
  langSel.value=initLang;
  renderAll(initLang);

  // page from memory
  showPage(localStorage.getItem("last_page") || "plan");

  // timers for “now” highlighting (every minute)
  setInterval(()=>renderPlan(langSel.value, T[langSel.value]), 60*1000);

  langSel.addEventListener("change", ()=>{
    const lang=langSel.value;
    localStorage.setItem(prefLangKey, lang);
    renderAll(lang);
  });
  notifyBtn.addEventListener("click", ()=> enableNotifications(T[langSel.value]));
  checkAllBtn.addEventListener("click", ()=>{
    const L=T[langSel.value], map={};
    L.tasks.forEach((_,i)=>{ map[i]=true; });
    saveJSON(planStoreKey(langSel.value), map); renderPlan(langSel.value,L);
  });
  uncheckAllBtn.addEventListener("click", ()=>{
    const L=T[langSel.value], map={};
    L.tasks.forEach((_,i)=>{ map[i]=false; });
    saveJSON(planStoreKey(langSel.value), map); renderPlan(langSel.value,L);
  });
  resetDayBtn.addEventListener("click", ()=>{
    localStorage.removeItem(planStoreKey(langSel.value)); renderPlan(langSel.value,T[langSel.value]);
  });

  tabPlan.onclick=()=>showPage("plan");
  tabAdhkar.onclick=()=>showPage("adhkar");
  tabQuran.onclick=()=>showPage("quran");
});
</script>
</body>
</html>
