<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Accueil ‚Ä¢ Planning ‚Ä¢ Adhk√¢r ‚Ä¢ Coran ‚Ä¢ Qibla 3D</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --text:#0f1a2b; --muted:#6b7280;
    --brand:#1e88e5; --now:#10b981; --shadow:0 1px 4px rgba(0,0,0,.12);
    --accent:#0ea5e9;
  }
  html,body{height:100%}
  body{
    margin:16px; background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
  }
  .wrap{max-width:1000px;margin:0 auto}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#eef6ff;border:1px solid #cfe0ff;color:#0f2a4a;border-radius:999px;padding:6px 12px}
  .status{color:var(--muted);font-size:14px;margin:6px 0}

  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid #cfd8e3;background:#fff;cursor:pointer}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

  .card{background:var(--card);box-shadow:var(--shadow);border-radius:12px;padding:12px;margin:12px 0}
  .legend{font-size:13px;color:var(--muted);margin-bottom:6px}

  /* Home */
  .hero{display:flex;flex-direction:column;gap:8px}
  .cta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{border:1px solid #cfd8e3;background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border:none}

  /* Planning */
  .task{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid #e7edf6;border-radius:10px;padding:10px;margin:8px 0}
  .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .time{font-weight:600}
  .badge{font-size:12px;background:#e8f1ff;border:1px solid #cfe0ff;border-radius:999px;padding:2px 8px}
  .ltr{direction:ltr; unicode-bidi:embed}
  .now{border-color:var(--now); box-shadow:0 0 0 2px rgba(16,185,129,.16)}
  .now .badge{background:#e9fff7; border-color:#b9f1df}
  .nowTag{font-size:12px;color:#0f8a6a;margin-left:6px}
  .done{text-decoration:line-through;color:#808a98}
  input[type="checkbox"]{width:20px;height:20px;accent-color:var(--brand)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:8px 0}

  /* Adhk√¢r */
  .adh-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .sectionHead{display:flex;align-items:center;justify-content:space-between;margin:10px 0 6px 0}
  .catTitle{font-weight:600}
  .sectionActions{display:flex;gap:6px}
  .dhk{border:1px solid #e6ebf2;border-radius:10px;padding:10px;margin:8px 0}
  .dhk .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .counter{min-width:46px;text-align:center;border-radius:8px;border:1px solid #cfd8e3;padding:4px 8px}
  .tag{display:inline-block;font-size:12px;background:#fafafa;border:1px solid #e8e8e8;border-radius:999px;padding:2px 8px;margin-inline-start:6px}
  .divider{height:1px;background:#e9eef5;margin:8px 0}

  /* Quran */
  .qrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  select,button,input[type="text"]{border:1px solid #cfd8e3;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
  iframe{width:100%;height:70vh;border:none;border-radius:12px;box-shadow:var(--shadow)}

  /* QIBLA 3D */
  .q3d-top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .q3d-info{font-size:14px;color:var(--muted)}
  .q3d-stage{perspective:900px;display:flex;justify-content:center;align-items:center}
  .q3d-scene{
    width:320px;height:320px;position:relative;
    transform-style:preserve-3d;
    transition:transform .15s ease-out;
  }
  .q3d-disk{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:260px;height:260px;border-radius:50%;
    background:radial-gradient(circle at 50% 50%, #fdfefe 0 35%, #e8eef6 36% 37%, #fdfefe 38% 100%);
    border:10px solid #e7edf6; box-shadow:var(--shadow);
  }
  .q3d-ring::before, .q3d-ring::after{
    content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:260px; height:260px; border-radius:50%;
    box-shadow:inset 0 0 0 2px #d6e2f0, inset 0 0 0 18px transparent;
  }
  .q3d-north{
    position:absolute; left:50%; top:22px; transform:translateX(-50%);
    font-weight:700; color:#0f2a4a;
  }
  .q3d-needle{
    position:absolute; left:50%; top:50%;
    width:8px; height:140px; transform-origin:50% 100%;
    transform:translate(-50%,-100%) rotateZ(0deg);
  }
  .q3d-needle .shaft{
    width:8px;height:105px;background:#1e293b;border-radius:4px 4px 0 0;
    box-shadow:0 0 10px rgba(0,0,0,.08);
  }
  .q3d-needle .head{
    width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:28px solid #e53935;
    margin-left:-8px;
  }
  /* Qibla arrow (green) rotating relative to heading) */
  .q3d-qibla{
    position:absolute; left:50%; top:50%;
    width:0;height:0; transform-origin:50% 100%;
    transform:translate(-50%,-100%) rotateZ(0deg);
  }
  .q3d-qibla .body{
    width:10px;height:100px;background:#10b981;border-radius:6px 6px 0 0; margin-left:-5px;
    box-shadow:0 0 10px rgba(16,185,129,.25);
  }
  .q3d-qibla .tip{
    width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:30px solid #10b981;
    margin-left:-9px;
  }
  .q3d-label{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-160%);
    background:#e7f8f2;border:1px solid #b9f1df;color:#065f46;font-size:12px;border-radius:999px;padding:2px 8px;
  }
  .q3d-hint{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="title">üè† Accueil ‚Ä¢ üï∞Ô∏è Planning ‚Ä¢ üïØÔ∏è Adhk√¢r ‚Ä¢ üìñ Coran ‚Ä¢ üß≠ Qibla 3D</h1>
    <div class="right">
      <label for="lang" id="langLabel">Langue :</label>
      <select id="lang">
        <option value="fr">Fran√ßais</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="en">English</option>
      </select>
      <div class="pill" title="Ville d√©tect√©e automatiquement">üèôÔ∏è <span id="cityLabel">Ville :</span> <strong id="cityName">‚Äî</strong></div>
    </div>
  </header>

  <div class="status" id="status">‚è≥ Demande de g√©olocalisation‚Ä¶</div>

  <div class="tabs">
    <button class="tab active" id="tab-home">üè† Accueil</button>
    <button class="tab" id="tab-plan">üìã Planning</button>
    <button class="tab" id="tab-adhkar">üïØÔ∏è Adhk√¢r</button>
    <button class="tab" id="tab-quran">üìñ Coran</button>
    <button class="tab" id="tab-qibla">üß≠ Qibla 3D</button>
  </div>

  <!-- HOME -->
  <section class="card" id="page-home">
    <div class="hero" id="homeHero"></div>
    <div class="cta">
      <button class="btn primary" id="goPlan">‚û°Ô∏è Aller au Planning</button>
      <button class="btn" id="goAdhkar">üïØÔ∏è Ouvrir Adhk√¢r</button>
      <button class="btn" id="goQuran">üìñ Ouvrir Coran</button>
      <button class="btn" id="goQibla">üß≠ Qibla 3D</button>
    </div>
  </section>

  <!-- PLANNING -->
  <section class="card" id="page-plan" style="display:none">
    <div class="legend" id="legend">
      Cr√©neaux calcul√©s depuis Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha (Aladhan, m√©thode 4 = Egypt). Mise √† jour de l‚Äôindicateur ¬´ en cours ¬ª chaque minute.
    </div>
    <div class="toolbar">
      <button id="retry" class="btn">‚Üª Re-demander la g√©olocalisation</button>
      <button id="resetDay" class="btn">‚Ü∫ R√©initialiser la progression du jour</button>
    </div>
    <div id="tasks"></div>
  </section>

  <!-- ADHKAR -->
  <section class="card" id="page-adhkar" style="display:none">
    <div class="adh-toolbar">
      <label for="slotSel" id="slotLabel">Cr√©neau :</label>
      <select id="slotSel"></select>
      <input type="text" id="adhSearch" placeholder="Recherche‚Ä¶" />
      <button id="resetAdhkar" class="btn primary">‚Ü∫ R√©initialiser les compteurs</button>
    </div>
    <div id="adhkarList"></div>
    <p class="status" id="adhHint">Les compteurs sont sauvegard√©s localement, par jour et par cr√©neau.</p>
  </section>

  <!-- QURAN -->
  <section class="card" id="page-quran" style="display:none">
    <div class="qrow">
      <label id="qLabel1">Sourate :</label>
      <select id="surahSel"></select>
      <label id="qLabel2">Juz :</label>
      <select id="juzSel"></select>
      <button id="openSurah" class="btn primary">Ouvrir</button>
      <button id="markRead" class="btn">‚úÖ Marquer lu</button>
      <button id="resetRead" class="btn">‚Ü∫ R√©initialiser</button>
    </div>
    <div class="status" id="readStatus"></div>
    <iframe id="qFrame" title="Quran"></iframe>
    <p class="status" id="qHint">Lecteur int√©gr√© depuis quran.com (peut demander l‚Äôautorisation d‚Äôint√©gration).</p>
  </section>

  <!-- QIBLA 3D -->
  <section class="card" id="page-qibla" style="display:none">
    <div class="q3d-top">
      <button class="btn primary" id="enableCompass">üß≠ Activer la boussole</button>
      <div class="q3d-info" id="qiblaInfo">Qibla : ‚Äî¬∞ ‚Ä¢ Cap : ‚Äî¬∞</div>
    </div>
    <div class="q3d-stage">
      <div class="q3d-scene" id="q3dScene">
        <div class="q3d-disk q3d-ring"></div>
        <div class="q3d-north">N</div>
        <div class="q3d-needle" id="needle3d">
          <div class="shaft"></div><div class="head"></div>
        </div>
        <div class="q3d-qibla" id="qArrow">
          <div class="body"></div><div class="tip"></div>
        </div>
        <div class="q3d-label" id="qLabel">Kaaba</div>
      </div>
    </div>
    <div class="q3d-hint" id="qiblaHint">Sur iPhone/iPad, il faut autoriser l‚Äôacc√®s au capteur apr√®s un appui sur ‚ÄúActiver la boussole‚Äù.</div>
  </section>
</div>

<script>
/* =================== I18N (inclut la page Accueil) =================== */
const T = {
  fr:{
    title:"üè† Accueil ‚Ä¢ üï∞Ô∏è Planning ‚Ä¢ üïØÔ∏è Adhk√¢r ‚Ä¢ üìñ Coran ‚Ä¢ üß≠ Qibla 3D",
    lang:"Langue :", city:"Ville :", statusGeo:"‚è≥ Demande de g√©olocalisation‚Ä¶",
    tabs:{home:"üè† Accueil", plan:"üìã Planning", adhkar:"üïØÔ∏è Adhk√¢r", quran:"üìñ Coran", qibla:"üß≠ Qibla 3D"},
    home:{
      h1:"Bienvenue !",
      p1:"Je m‚Äôappelle <strong>Slimane Rahmoune</strong>. Je vous partage ici des cr√©neaux d‚Äôadorations inspir√©s de la sunnah du Proph√®te Ô∑∫.",
      p2:"Vous pouvez aussi lire le Coran, r√©citer les adhk√¢r, et suivre votre progression gr√¢ce √† une checklist simple.",
      ded:"<strong>Cette application est une <em>sadaqa j√¢riya</em> d√©di√©e √† ma d√©funte et ch√®re tante BEN BOURENANE TOUNSIA</strong> ‚Äî qu‚ÄôAllah lui fasse mis√©ricorde. <br>Merci de l‚Äôutiliser pour √©couter et lire le Coran, r√©citer les adhk√¢r et suivre les adorations du Proph√®te Ô∑∫.",
      p3:"Faites de votre mieux, r√©guli√®rement, avec sinc√©rit√© ‚Äî pour devenir, inch√¢‚ÄôAllah, des musulman(e)s exemplaires.",
      note:"Les cr√©neaux s‚Äôadaptent automatiquement √† votre g√©olocalisation."
    },
    legend:"Cr√©neaux calcul√©s depuis Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha (Aladhan, m√©thode 4 = Egypt). Mise √† jour de l‚Äôindicateur ¬´ en cours ¬ª chaque minute.",
    retry:"‚Üª Re-demander la g√©olocalisation", resetDay:"‚Ü∫ R√©initialiser la progression du jour",
    now:"Cr√©neau en cours",
    tasks:[
      {name:"Avant Fajr", action:"Qiy√¢m & adhk√¢r"},
      {name:"Fajr ‚Üí +30 min apr√®s lever", action:"Fajr + Coran & invocations"},
      {name:"Matin (apr√®s lever+30)", action:"Travail/√âtudes avec intention"},
      {name:"Duha", action:"2‚Äì4 unit√©s de pri√®re"},
      {name:"Dhuhr", action:"Pri√®re + sieste courte"},
      {name:"‚ÄòAsr ‚Üí Maghrib", action:"Travail/Savoir + Sport"},
      {name:"Maghrib ‚Üí ‚ÄòIsha", action:"Famille + Coran"},
      {name:"‚ÄòIsha", action:"Pri√®re + Lecture/Repos"},
      {name:"Nuit", action:"Dormir t√¥t + Qiy√¢m"}
    ],
    adh:{slot:"Cr√©neau :", reset:"‚Ü∫ R√©initialiser les compteurs", hint:"Les compteurs sont sauvegard√©s localement, par jour et par cr√©neau.",
         groups:{all:"Tous", morning:"Matin", afterPrayer:"Apr√®s les pri√®res", evening:"Soir", sleep:"Avant de dormir", home:"Maison"}},
    q:{s:"Sourate :", j:"Juz :", open:"Ouvrir", mark:"‚úÖ Marquer lu", reset:"‚Ü∫ R√©initialiser", last:(s)=>`Derni√®re lecture : ${s}`},
    geoOk:"‚úÖ Cr√©neaux mis √† jour selon ta localisation.",
    geoDenied:"‚ö†Ô∏è Acc√®s √† la g√©olocalisation refus√©. Autorise la localisation puis clique ¬´ Re-demander la g√©olocalisation ¬ª.",
    geoNo:"‚ùå G√©olocalisation non support√©e par ce navigateur.",
    loadErr:"‚ö†Ô∏è Erreur lors de la r√©cup√©ration des horaires. V√©rifie ta connexion et r√©essaie.",
    qibla:{hint:"Sur iPhone/iPad, appuie sur ¬´ Activer la boussole ¬ª pour donner l‚Äôautorisation.", label:"Kaaba"}
  },
  ar:{
    title:"üè† ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ‚Ä¢ üï∞Ô∏è ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ‚Ä¢ üïØÔ∏è ÿßŸÑÿ£ÿ∞ŸÉÿßÿ± ‚Ä¢ üìñ ÿßŸÑŸÇÿ±ÿ¢ŸÜ ‚Ä¢ üß≠ ÿßŸÑŸÇÿ®ŸÑÿ© ÿ´ŸÑÿßÿ´Ÿäÿ© ÿßŸÑÿ£ÿ®ÿπÿßÿØ",
    lang:"ÿßŸÑŸÑÿ∫ÿ©:", city:"ÿßŸÑŸÖÿØŸäŸÜÿ©:", statusGeo:"‚è≥ ÿ¨ÿßÿ±Ÿê ÿ∑ŸÑÿ® ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ‚Ä¶",
    tabs:{home:"üè† ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©", plan:"üìã ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑", adhkar:"üïØÔ∏è ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±", quran:"üìñ ÿßŸÑŸÇÿ±ÿ¢ŸÜ", qibla:"üß≠ ÿßŸÑŸÇÿ®ŸÑÿ© 3D"},
    home:{
      h1:"ŸÖÿ±ÿ≠ÿ®Ÿãÿß!",
      p1:"ÿ£ŸÜÿß <strong>ÿ≥ŸÑŸäŸÖÿßŸÜ ÿ±ÿ≠ŸÖŸàŸÜ</strong>ÿå ÿ£ÿ¥ÿßÿ±ŸÉŸÉŸÖ ŸáŸÜÿß ŸÅÿ™ÿ±ÿßÿ™Ÿç ŸÑŸÑÿπÿ®ÿßÿØÿßÿ™ ÿπŸÑŸâ ŸÖŸÜŸáÿ¨ ÿßŸÑÿ≥ŸÜÿ© ŸÑŸÑŸÜÿ®Ÿä Ô∑∫.",
      p2:"ŸäŸÖŸÉŸÜŸÉŸÖ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÇÿ±ÿ¢ŸÜÿå Ÿàÿ∞ŸÉÿ± ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±ÿå ŸàŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ ÿπÿ®ÿ± ŸÇÿßÿ¶ŸÖÿ© ÿ™ÿ≠ŸÇŸÇ ÿ®ÿ≥Ÿäÿ∑ÿ©.",
      ded:"<strong>Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿµÿØŸÇÿ© ÿ¨ÿßÿ±Ÿäÿ© ŸÑÿπŸÖŸëÿ™Ÿä ÿßŸÑÿ≠ÿ®Ÿäÿ®ÿ© ÿßŸÑŸÖÿ±ÿ≠ŸàŸÖÿ© BEN BOURENANE TOUNSIA</strong> ‚Äî ÿ±ÿ≠ŸÖŸáÿß ÿßŸÑŸÑŸá. <br>ŸÜÿ±ÿ¨Ÿà ÿßÿ≥ÿ™ÿπŸÖÿßŸÑŸá ŸÑÿ≥ŸÖÿßÿπ ŸàŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÇÿ±ÿ¢ŸÜÿå Ÿàÿ∞ŸÉÿ± ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±ÿå Ÿàÿßÿ™ÿ®ÿßÿπ ÿπÿ®ÿßÿØÿßÿ™ ÿßŸÑŸÜÿ®Ÿä Ô∑∫.",
      p3:"ÿßÿ®ÿ∞ŸÑŸàÿß ÿ¨ŸáÿØŸÉŸÖ ÿ®ÿßŸÜÿ™ÿ∏ÿßŸÖ Ÿàÿ•ÿÆŸÑÿßÿµ ‚Äî ŸÑÿ™ŸÉŸàŸÜŸàÿß ÿ®ÿ•ÿ∞ŸÜ ÿßŸÑŸÑŸá ŸÖÿ≥ŸÑŸÖŸäŸÜ ŸàŸÖÿ≥ŸÑŸÖÿßÿ™ ŸÇÿØŸàÿ©.",
      note:"ÿ™ÿ™ŸÉŸäŸëŸÅ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ÿ®ÿ≠ÿ≥ÿ® ŸÖŸàŸÇÿπŸÉŸÖ ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸä."
    },
    legend:"Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ŸÖŸÜ ÿßŸÑŸÅÿ¨ÿ±ÿå ÿßŸÑÿ¥ÿ±ŸàŸÇÿå ÿßŸÑÿ∏Ÿáÿ±ÿå ÿßŸÑÿπÿµÿ±ÿå ÿßŸÑŸÖÿ∫ÿ±ÿ®ÿå ÿßŸÑÿπÿ¥ÿßÿ° (Aladhanÿå ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© 4=ŸÖÿµÿ±). ŸäŸèÿ≠ÿØŸëŸéÿ´ ŸÖÿ§ÿ¥ÿ± ¬´ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸáŸÜÿß¬ª ŸÉŸÑ ÿØŸÇŸäŸÇÿ©.",
    retry:"‚Üª ÿ•ÿπÿßÿØÿ© ÿ∑ŸÑÿ® ÿßŸÑŸÖŸàŸÇÿπ", resetDay:"‚Ü∫ ÿ™ÿµŸÅŸäÿ± ÿ•ŸÜÿ¨ÿßÿ≤ ÿßŸÑŸäŸàŸÖ",
    now:"ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸáŸÜÿß",
    tasks:[
      {name:"ŸÇÿ®ŸÑ ÿßŸÑŸÅÿ¨ÿ±", action:"ŸÇŸäÿßŸÖ ÿßŸÑŸÑŸäŸÑ Ÿàÿ∞ŸÉÿ± ÿßŸÑŸÑŸá"},
      {name:"ÿßŸÑŸÅÿ¨ÿ± ‚Üí +30 ÿ®ÿπÿØ ÿßŸÑÿ¥ÿ±ŸàŸÇ", action:"ÿµŸÑÿßÿ© ÿßŸÑŸÅÿ¨ÿ± + ŸÇÿ±ÿ¢ŸÜ Ÿàÿ£ÿ∞ŸÉÿßÿ±"},
      {name:"ÿßŸÑÿµÿ®ÿßÿ≠", action:"ÿπŸÖŸÑ/ÿØÿ±ÿßÿ≥ÿ© ÿ®ŸÜŸäÿ© ŸÑŸÑŸá"},
      {name:"ÿßŸÑÿ∂ÿ≠Ÿâ", action:"ÿ±ŸÉÿπÿ™ÿßŸÜ ÿ•ŸÑŸâ ÿ£ÿ±ÿ®ÿπ"},
      {name:"ÿßŸÑÿ∏Ÿáÿ±", action:"ÿµŸÑÿßÿ© + ŸÇŸäŸÑŸàŸÑÿ©"},
      {name:"ÿßŸÑÿπÿµÿ± ‚Üí ÿßŸÑŸÖÿ∫ÿ±ÿ®", action:"ÿπŸÖŸÑ/ÿπŸÑŸÖ + ÿ±Ÿäÿßÿ∂ÿ©"},
      {name:"ÿßŸÑŸÖÿ∫ÿ±ÿ® ‚Üí ÿßŸÑÿπÿ¥ÿßÿ°", action:"ÿ¨ŸÑÿ≥ÿ© ÿπÿßÿ¶ŸÑŸäÿ© + ŸÇÿ±ÿ¢ŸÜ"},
      {name:"ÿßŸÑÿπÿ¥ÿßÿ°", action:"ÿµŸÑÿßÿ© + ŸÇÿ±ÿßÿ°ÿ©/ÿ±ÿßÿ≠ÿ©"},
      {name:"ÿßŸÑŸÑŸäŸÑ", action:"ŸÜŸàŸÖ ŸÖÿ®ŸÉÿ± + ŸÇŸäÿßŸÖ"}
    ],
    adh:{slot:"ÿßŸÑŸÅÿ™ÿ±ÿ©:", reset:"‚Ü∫ ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿπÿØÿßÿØÿßÿ™", hint:"ŸäŸèÿ≠ŸÅÿ∏ ÿßŸÑÿπÿØŸë ŸÖÿ≠ŸÑŸäŸãÿß ŸÑŸÉŸÑ ŸÅÿ™ÿ±ÿ© ŸàŸäŸàŸÖ.",
         groups:{all:"ÿßŸÑŸÉŸÑ", morning:"ÿ£ÿ∞ŸÉÿßÿ± ÿßŸÑÿµÿ®ÿßÿ≠", afterPrayer:"ÿ®ÿπÿØ ÿßŸÑÿµŸÑŸàÿßÿ™", evening:"ÿ£ÿ∞ŸÉÿßÿ± ÿßŸÑŸÖÿ≥ÿßÿ°", sleep:"ŸÇÿ®ŸÑ ÿßŸÑŸÜŸàŸÖ", home:"ÿßŸÑÿ®Ÿäÿ™"}},
    q:{s:"ÿ≥Ÿàÿ±ÿ©:", j:"ÿ¨ÿ≤ÿ°:", open:"ŸÅÿ™ÿ≠", mark:"‚úÖ ÿ™ŸÖŸëÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©", reset:"‚Ü∫ ÿ™ÿµŸÅŸäÿ±", last:(s)=>`ÿ¢ÿÆÿ± ŸÇÿ±ÿßÿ°ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©: ${s}`},
    geoOk:"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿ≠ÿ≥ÿ® ŸÖŸàŸÇÿπŸÉ.",
    geoDenied:"‚ö†Ô∏è ÿ±ŸèŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ ÿ®ÿßŸÑŸÖŸàŸÇÿπ.", geoNo:"‚ùå ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ.", loadErr:"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ¨ŸÑÿ®.",
    qibla:{hint:"ŸÅŸä ÿ£ÿ¨Ÿáÿ≤ÿ© Appleÿå ÿßÿ∂ÿ∫ÿ∑ ¬´ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®ŸàÿµŸÑÿ©¬ª ŸÑŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸÖÿ≥ÿ™ÿ¥ÿπÿ±.", label:"ÿßŸÑŸÉÿπÿ®ÿ©"}
  },
  en:{
    title:"üè† Home ‚Ä¢ üï∞Ô∏è Plan ‚Ä¢ üïØÔ∏è Adhkar ‚Ä¢ üìñ Quran ‚Ä¢ üß≠ Qibla 3D",
    lang:"Language:", city:"City:", statusGeo:"‚è≥ Requesting geolocation‚Ä¶",
    tabs:{home:"üè† Home", plan:"üìã Plan", adhkar:"üïØÔ∏è Adhkar", quran:"üìñ Quran", qibla:"üß≠ Qibla 3D"},
    home:{
      h1:"Welcome!",
      p1:"I‚Äôm <strong>Slimane Rahmoune</strong>. I‚Äôm sharing worship time slots inspired by the Prophetic Ô∑∫ way.",
      p2:"Read the Qur‚Äôan, recite adhkƒÅr, and track progress with a simple checklist.",
      ded:"<strong>This app is a <em>sadaqah jariyah</em> dedicated to my beloved late aunt BEN BOURENANE TOUNSIA</strong> ‚Äî may Allah have mercy on her. <br>Please use it to listen to and read the Qur‚Äôan, recite adhkƒÅr, and follow the Prophet‚Äôs Ô∑∫ worship.",
      p3:"Do your best, consistently and sincerely ‚Äî to become exemplary Muslims, in shƒÅ‚Äô AllƒÅh.",
      note:"Slots adapt automatically to your geolocation."
    },
    legend:"Slots from Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha (Aladhan, method 4 = Egypt). ‚ÄòNow‚Äô indicator updates every minute.",
    retry:"‚Üª Request geolocation again", resetDay:"‚Ü∫ Reset today‚Äôs progress",
    now:"You are here",
    tasks:[
      {name:"Before Fajr", action:"Qiyam & adhkar"},
      {name:"Fajr ‚Üí +30 after sunrise", action:"Fajr + Qur‚Äôan & invocations"},
      {name:"Morning", action:"Work/Study with intention"},
      {name:"Duha", action:"2‚Äì4 units of prayer"},
      {name:"Dhuhr", action:"Prayer + short nap"},
      {name:"Asr ‚Üí Maghrib", action:"Work/Knowledge + Exercise"},
      {name:"Maghrib ‚Üí Isha", action:"Family + Qur‚Äôan"},
      {name:"Isha", action:"Prayer + Reading/Rest"},
      {name:"Night", action:"Sleep early + Qiyam"}
    ],
    adh:{slot:"Slot:", reset:"‚Ü∫ Reset counters", hint:"Counters saved locally per day/slot.",
         groups:{all:"All", morning:"Morning", afterPrayer:"After prayers", evening:"Evening", sleep:"Before sleep", home:"Home"}},
    q:{s:"Surah:", j:"Juz:", open:"Open", mark:"‚úÖ Mark read", reset:"‚Ü∫ Reset", last:(s)=>`Last reading: ${s}`},
    geoOk:"‚úÖ Slots updated based on your location.", geoDenied:"‚ö†Ô∏è Geolocation denied.", geoNo:"‚ùå Not supported.", loadErr:"‚ö†Ô∏è Error fetching timings.",
    qibla:{hint:"On iOS, press ‚ÄúEnable compass‚Äù to grant sensor permission.", label:"Kaaba"}
  }
};

/* ====== Adhkar datasets (abr√©g√©) ====== */
const ADH_DB={ /* (identique √† ta version pr√©c√©dente) */ 
  ar:{morning:[{txt:"ÿ£ÿµÿ®ÿ≠ŸÜÿß Ÿàÿ£ÿµÿ®ÿ≠ ÿßŸÑŸÖŸÑŸÉ ŸÑŸÑŸá‚Ä¶",count:1,ref:"ŸÖÿ≥ŸÑŸÖ"}],afterPrayer:[{txt:"ÿ£ÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá (Ÿ£)‚Ä¶",count:1,ref:"ŸÖÿ≥ŸÑŸÖ"}],evening:[{txt:"ÿ£ŸÖÿ≥ŸäŸÜÿß‚Ä¶",count:1,ref:"ŸÖÿ≥ŸÑŸÖ"}],sleep:[{txt:"ÿ®ÿßÿ≥ŸÖŸÉ ÿßŸÑŸÑŸáŸÖ‚Ä¶",count:1,ref:"ÿßŸÑÿ®ÿÆÿßÿ±Ÿä"}],home:[{txt:"ÿØÿπÿßÿ° ÿØÿÆŸàŸÑ ÿßŸÑÿ®Ÿäÿ™‚Ä¶",count:1,ref:"ÿ£ÿ®Ÿà ÿØÿßŸàÿØ"}]},
  fr:{morning:[{txt:"Nous entrons au matin‚Ä¶",count:1,ref:"Muslim"}],afterPrayer:[{txt:"Istighfar (3)‚Ä¶",count:1,ref:"Muslim"}],evening:[{txt:"Nous entrons au soir‚Ä¶",count:1,ref:"Muslim"}],sleep:[{txt:"Bismika All√¢humma‚Ä¶",count:1,ref:"Bukhari"}],home:[{txt:"Entrer √† la maison",count:1,ref:"Abu Dawud"}]},
  en:{morning:[{txt:"We enter the morning‚Ä¶",count:1,ref:"Muslim"}],afterPrayer:[{txt:"Istighfar (3)‚Ä¶",count:1,ref:"Muslim"}],evening:[{txt:"We enter the evening‚Ä¶",count:1,ref:"Muslim"}],sleep:[{txt:"Bismika Allahumma‚Ä¶",count:1,ref:"Bukhari"}],home:[{txt:"Entering home",count:1,ref:"Abu Dawud"}]}
};

/* =================== Utils & State =================== */
const $q = s => document.querySelector(s);
const toMin = s => { const [h,m] = s.split(":").map(Number); return h*60+m; };
const fromMin = m => { m=((m%1440)+1440)%1440; const h=Math.floor(m/60),mi=m%60; return `${String(h).padStart(2,"0")}:${String(mi).padStart(2,"0")}`; };
const addMin = (t,mins)=>fromMin(toMin(t)+mins);
const mid = (a,b)=>fromMin(Math.floor((toMin(a)+toMin(b))/2));
const todayKey = ()=>new Date().toISOString().slice(0,10);
const prefLangKey="pref_lang";

let CURRENT_SLOTS=null;
let CURR_LANG="fr";
let USER_POS=null;           // lat/lon
let QIBLA_BRG=null;          // bearing to Kaaba
let compassActive=false;

/* =================== Geoloc + APIs =================== */
async function getCityName(lat, lon, lang){
  try{
    const resp=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=${lang==='ar'?'ar':lang==='fr'?'fr':'en'}`);
    const j=await resp.json();
    return j.city || j.locality || j.principalSubdivision || j.countryName || "‚Äî";
  }catch{return "‚Äî";}
}
async function getPrayerTimings(lat, lon){
  const r=await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=4`);
  const j=await r.json();
  const t=j?.data?.timings; if(!t) throw new Error("Invalid Aladhan response");
  const clean=v=>(v||"").split(" ")[0].slice(0,5);
  return {Fajr:clean(t.Fajr),Sunrise:clean(t.Sunrise),Dhuhr:clean(t.Dhuhr),Asr:clean(t.Asr),Maghrib:clean(t.Maghrib),Isha:clean(t.Isha)};
}
function buildSlots({Fajr,Sunrise,Dhuhr,Asr,Maghrib,Isha}){
  const fajrEnd=fromMin(Math.min(toMin(addMin(Fajr,60)), toMin(Sunrise)));
  const afterSunrise=addMin(Sunrise,30);
  const midMorning=mid(afterSunrise,Dhuhr);
  const midIshaFajr=mid(Isha, addMin(Fajr,24*60));
  return [
    {start:Fajr,end:fajrEnd},
    {start:fajrEnd,end:afterSunrise},
    {start:afterSunrise,end:midMorning},
    {start:midMorning,end:Dhuhr},
    {start:Dhuhr,end:Asr},
    {start:Asr,end:Maghrib},
    {start:Maghrib,end:Isha},
    {start:Isha,end:midIshaFajr},
    {start:midIshaFajr,end:addMin(Fajr,24*60)}
  ];
}
function nowIn(start,end){
  const cur=new Date(); let c=cur.getHours()*60+cur.getMinutes();
  let s=toMin(start),e=toMin(end); if(e<=s)e+=1440; if(c<s)c+=1440; return c>=s && c<e;
}

/* ===== Qibla bearing (great-circle) ===== */
function computeQiblaBearing(lat,lon){
  const œÜ1=lat*Math.PI/180, œÜ2=21.4225*Math.PI/180;       // Kaaba lat
  const ŒîŒª=(39.8262-lon)*Math.PI/180;                     // Kaaba lon
  const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  let Œ∏=Math.atan2(y,x)*180/Math.PI;
  return (Œ∏+360)%360;
}

/* =================== Rendering: Home =================== */
function renderHome(){
  const L=T[CURR_LANG];
  const hero=$q("#homeHero");
  hero.innerHTML=`
    <h2>${L.home.h1}</h2>
    <p>${L.home.p1}</p>
    <p>${L.home.p2}</p>
    ${L.home.ded ? `<p>${L.home.ded}</p>` : ""}
    <p>${L.home.p3}</p>
    <p class="status">üí° ${L.home.note}</p>
  `;
  $q("#goPlan").textContent = (CURR_LANG==="ar")?"‚û°Ô∏è ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑":(CURR_LANG==="fr")?"‚û°Ô∏è Aller au Planning":"‚û°Ô∏è Go to Planning";
  $q("#goAdhkar").textContent = (CURR_LANG==="ar")?"üïØÔ∏è ŸÅÿ™ÿ≠ ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±":(CURR_LANG==="fr")?"üïØÔ∏è Ouvrir Adhk√¢r":"üïØÔ∏è Open Adhkar";
  $q("#goQuran").textContent = (CURR_LANG==="ar")?"üìñ ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿ±ÿ¢ŸÜ":(CURR_LANG==="fr")?"üìñ Ouvrir Coran":"üìñ Open Quran";
  $q("#goQibla").textContent = (CURR_LANG==="ar")?"üß≠ ÿßŸÑŸÇÿ®ŸÑÿ© 3D":(CURR_LANG==="fr")?"üß≠ Qibla 3D":"üß≠ Qibla 3D";
}

/* =================== Rendering: Planning =================== */
function renderPlan(){
  const L=T[CURR_LANG];
  $q("#tab-plan").textContent=L.tabs.plan;
  $q("#legend").textContent=L.legend;
  $q("#retry").textContent=L.retry; $q("#resetDay").textContent=L.resetDay;

  const tasksDef=L.tasks;
  const box=$q("#tasks"); box.innerHTML="";
  if(!CURRENT_SLOTS){ return; }

  CURRENT_SLOTS.forEach((slot,i)=>{
    const key=`done_${todayKey()}_${i}`;
    const checked=localStorage.getItem(key)==="1";
    const isNow=nowIn(slot.start,slot.end);

    const row=document.createElement("div");
    row.className="task"+(isNow?" now":"");
    row.innerHTML=`
      <div class="left">
        <input type="checkbox" id="chk-${i}" ${checked?"checked":""}/>
        <span class="time">${tasksDef[i].name}</span>
        <span id="txt-${i}" class="${checked?"done":""}">${tasksDef[i].action}</span>
        <span class="badge"><span class="ltr">${slot.start} ‚Äì ${slot.end}</span></span>
        ${isNow?`<span class="nowTag">‚Ä¢ ${L.now}</span>`:""}
      </div>
      <div></div>`;
    box.appendChild(row);

    $q("#chk-"+i).addEventListener("change",e=>{
      localStorage.setItem(key, e.target.checked?"1":"0");
      $q("#txt-"+i).classList.toggle("done", e.target.checked);
    });
  });
}

/* =================== Rendering: Adhkar (identique logique) =================== */
function adhStoreKey(slot){ return `adh_${todayKey()}_${CURR_LANG}_${slot}`; }
function renderAdhkar(){
  const L=T[CURR_LANG];
  $q("#tab-adhkar").textContent=L.tabs.adhkar;
  $q("#slotLabel").textContent=L.adh.slot;
  $q("#resetAdhkar").textContent=L.adh.reset;
  $q("#adhHint").textContent=L.adh.hint;

  const groups = [
    {key:"all", name:L.adh.groups.all},
    {key:"morning", name:L.adh.groups.morning},
    {key:"afterPrayer", name:L.adh.groups.afterPrayer},
    {key:"evening", name:L.adh.groups.evening},
    {key:"sleep", name:L.adh.groups.sleep},
    {key:"home", name:L.adh.groups.home}
  ];
  const slotSel=$q("#slotSel");
  slotSel.innerHTML="";
  groups.forEach(g=>{ const o=document.createElement("option"); o.value=g.key; o.textContent=g.name; slotSel.appendChild(o); });
  slotSel.value=localStorage.getItem("adh_sel_"+CURR_LANG)||"all";

  const draw=(slot,query)=>{
    const db=ADH_DB[CURR_LANG];
    const box=$q("#adhkarList"); box.innerHTML="";
    const renderList=(key,title,list)=>{
      if(!list||!list.length)return;
      if(title){
        const head=document.createElement("div");
        head.className="sectionHead";
        head.innerHTML=`<div class="catTitle">${title}</div>
          <div class="sectionActions">
            <button class="btn primary" id="${key}-all">‚úÖ</button>
            <button class="btn" id="${key}-reset">${L.adh.reset}</button>
          </div>`;
        box.appendChild(head);
        const divi=document.createElement("div"); divi.className="divider"; box.appendChild(divi);
        head.querySelector(`#${key}-all`).onclick=()=>{
          const counts=JSON.parse(localStorage.getItem(adhStoreKey(key))||"{}");
          list.forEach((d,i)=>counts[i]=d.count||1);
          localStorage.setItem(adhStoreKey(key),JSON.stringify(counts));
          draw(slotSel.value, $q("#adhSearch").value.trim());
        };
        head.querySelector(`#${key}-reset`).onclick=()=>{
          localStorage.removeItem(adhStoreKey(key));
          draw(slotSel.value, $q("#adhSearch").value.trim());
        };
      }
      const counts=JSON.parse(localStorage.getItem(adhStoreKey(key))||"{}");
      list.forEach((d,idx)=>{
        if(query && !d.txt.toLowerCase().includes(query.toLowerCase())) return;
        const need=d.count||1, cur=counts[idx]||0;
        const div=document.createElement("div");
        div.className="dhk";
        div.innerHTML=`
          <div><strong>${d.txt}</strong></div>
          <div class="status">${d.ref?`<span class="tag">${d.ref}</span>`:""}<span class="tag">x${need}</span></div>
          <div class="controls">
            <button class="btn primary" id="${key}-plus-${idx}">+1</button>
            <button class="btn" id="${key}-minus-${idx}">-1</button>
            <span class="counter" id="${key}-count-${idx}">${cur}/${need}</span>
            <button class="btn" id="${key}-done-${idx}">‚úÖ</button>
            <button class="btn" id="${key}-clear-${idx}">‚Ü∫</button>
          </div>`;
        box.appendChild(div);
        const upd=(v)=>{
          const c=Math.max(0, Math.min(need, v));
          counts[idx]=c; localStorage.setItem(adhStoreKey(key),JSON.stringify(counts));
          $q(`#${key}-count-${idx}`).textContent=`${c}/${need}`;
        };
        $q(`#${key}-plus-${idx}`).onclick=()=>upd((counts[idx]||0)+1);
        $q(`#${key}-minus-${idx}`).onclick=()=>upd((counts[idx]||0)-1);
        $q(`#${key}-done-${idx}`).onclick=()=>upd(need);
        $q(`#${key}-clear-${idx}`).onclick=()=>upd(0);
      });
    };

    if(slot==="all"){
      renderList("morning",L.adh.groups.morning,db.morning);
      renderList("afterPrayer",L.adh.groups.afterPrayer,db.afterPrayer);
      renderList("evening",L.adh.groups.evening,db.evening);
      renderList("sleep",L.adh.groups.sleep,db.sleep);
      renderList("home",L.adh.groups.home,db.home);
    }else{
      const title = groups.find(g=>g.key===slot)?.name || "";
      renderList(slot,title,db[slot]);
    }
  };

  draw(slotSel.value,$q("#adhSearch").value.trim());
  slotSel.onchange=()=>{localStorage.setItem("adh_sel_"+CURR_LANG,slotSel.value);draw(slotSel.value,$q("#adhSearch").value.trim());};
  $q("#adhSearch").oninput=()=>draw(slotSel.value,$q("#adhSearch").value.trim());
  $q("#resetAdhkar").onclick=()=>{
    ["morning","afterPrayer","evening","sleep","home"].forEach(s=>localStorage.removeItem(adhStoreKey(s)));
    draw(slotSel.value,$q("#adhSearch").value.trim());
  };
}

/* =================== Rendering: Quran =================== */
const SURAH_NAMES=["Al-FƒÅti·∏•ah","Al-Baqarah","ƒÄl ‚ÄòImrƒÅn","An-NisƒÅ‚Äô","Al-MƒÅ‚Äôidah","Al-An‚ÄòƒÅm","Al-A‚ÄòrƒÅf","Al-AnfƒÅl","At-Tawbah","Y≈´nus","H≈´d","Y≈´suf","Ar-Ra‚Äòd","IbrƒÅhƒ´m","Al-·∏§ijr","An-Na·∏•l","Al-IsrƒÅ‚Äô","Al-Kahf","Maryam","·π¨ƒÅ HƒÅ","Al-AnbiyƒÅ‚Äô","Al-·∏§ajj","Al-Mu‚Äômin≈´n","An-N≈´r","Al-FurqƒÅn","Ash-Shu‚ÄòarƒÅ‚Äô","An-Naml","Al-Qa·π£a·π£","Al-‚ÄòAnkab≈´t","Ar-R≈´m","LuqmƒÅn","As-Sajdah","Al-A·∏•zƒÅb","Saba‚Äô","FƒÅ·π≠ir","YƒÅ Sƒ´n","As-·π¢ƒÅffƒÅt","·π¢ƒÅd","Az-Zumar","GhƒÅfir","Fu·π£·π£ilat","Ash-Sh≈´rƒÅ","Az-Zukhruf","Ad-DukhƒÅn","Al-JƒÅÿ´iyah","Al-A·∏•qƒÅf","Mu·∏•ammad","Al-Fat·∏•","Al-·∏§ujurƒÅt","QƒÅf","Adh-DhƒÅriyƒÅt","A·π≠-·π¨≈´r","An-Najm","Al-Qamar","Ar-Ra·∏•mƒÅn","Al-WƒÅqi‚Äòah","Al-·∏§adƒ´d","Al-MujƒÅdilah","Al-·∏§ashr","Al-Mumta·∏•anah","A·π£-·π¢aff","Al-Jumu‚Äòah","Al-MunƒÅfiŸÇ≈´n","At-TaghƒÅbun","A·π≠-·π¨alƒÅŸÇ","At-Ta·∏•rƒ´m","Al-Mulk","Al-Qalam","Al-·∏§ƒÅqqah","Al-Ma‚ÄòƒÅrij","N≈´·∏•","Al-Jinn","Al-Muzzammil","Al-Muddathÿ´ir","Al-QiyƒÅmah","Al-InsƒÅn","Al-MursalƒÅt","An-Naba‚Äô","An-NƒÅzi‚ÄòƒÅt","‚ÄòAbasa","At-TakŸàŸäÿ±","Al-Infi·π≠ƒÅr","Al-Mu·π≠affifƒ´n","Al-InshiqƒÅq","Al-Bur≈´j","A·π≠-·π¨ƒÅriq","Al-A‚ÄòlƒÅ","Al-GhƒÅshiyah","Al-Fajr","Al-Balad","Ash-Shams","Al-Layl","A·∏ç-·∏åu·∏•ƒÅ","Ash-Shar·∏•","At-Tƒ´n","Al-‚ÄòAlaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-‚ÄòƒÄdiyƒÅt","Al-QƒÅri‚Äòah","At-TakƒÅthur","Al-‚ÄòA·π£r","Al-Humazah","Al-Fƒ´ŸÑ","Quraysh","Al-MƒÅ‚Äò≈´n","Al-Kawthar","Al-KƒÅfir≈´n","An-Na·π£r","Al-Masad","Al-IkhlƒÅ·π£","Al-Falaq","An-NƒÅs"];
function quranStoreKey(){ return `qread_${todayKey()}_${CURR_LANG}`; }
function renderQuran(){
  const L=T[CURR_LANG];
  $q("#tab-quran").textContent=L.tabs.quran;
  $q("#qLabel1").textContent=L.q.s; $q("#qLabel2").textContent=L.q.j;
  $q("#openSurah").textContent=L.q.open; $q("#markRead").textContent=L.q.mark; $q("#resetRead").textContent=L.q.reset;

  const sSel=$q("#surahSel"); sSel.innerHTML="";
  SURAH_NAMES.forEach((n,i)=>{const o=document.createElement("option");o.value=String(i+1);o.textContent=`${i+1}. ${n}`;sSel.appendChild(o);});

  const jSel=$q("#juzSel"); jSel.innerHTML="";
  for(let j=1;j<=30;j++){const o=document.createElement("option");o.value=String(j);o.textContent=`Juz ${j}`;jSel.appendChild(o);}

  const saved=localStorage.getItem(quranStoreKey());
  $q("#readStatus").textContent=saved?L.q.last(saved):"";

  $q("#openSurah").onclick=()=>{
    const s=sSel.value;
    const url=`https://quran.com/${s}?reading=false&locale=${CURR_LANG==='ar'?'ar':(CURR_LANG==='fr'?'fr':'en')}`;
    $q("#qFrame").src=url;
  };
  $q("#markRead").onclick=()=>{
    const label=`Surah ${sSel.value} / Juz ${jSel.value}`;
    localStorage.setItem(quranStoreKey(),label);
    $q("#readStatus").textContent=L.q.last(label);
  };
  $q("#resetRead").onclick=()=>{localStorage.removeItem(quranStoreKey());$q("#readStatus").textContent="";};
}

/* =================== QIBLA 3D =================== */
function applyQiblaTexts(){
  const L=T[CURR_LANG];
  $q("#tab-qibla").textContent=L.tabs.qibla;
  $q("#enableCompass").textContent = (CURR_LANG==="ar") ? "üß≠ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®ŸàÿµŸÑÿ©" : (CURR_LANG==="fr") ? "üß≠ Activer la boussole" : "üß≠ Enable compass";
  $q("#qiblaHint").textContent=L.qibla.hint;
  $q("#qLabel").textContent=L.qibla.label;
}
function startCompass(){
  const enableBtn=$q("#enableCompass");
  enableBtn.onclick=async ()=>{
    const needPerm = typeof DeviceOrientationEvent!=="undefined" && typeof DeviceOrientationEvent.requestPermission==="function";
    if(needPerm){
      try{
        const res = await DeviceOrientationEvent.requestPermission();
        if(res!=="granted") return;
      }catch{ return; }
    }
    if(!compassActive){
      window.addEventListener('deviceorientation', onOrient, true);
      compassActive=true;
    }
  };
}
function onOrient(e){
  // heading
  let heading;
  if(e.webkitCompassHeading!==undefined) heading = e.webkitCompassHeading; // iOS: 0=N
  else if(e.absolute && e.alpha!=null) heading = 360 - e.alpha;            // alpha: 0=E
  else return;
  // tilt for 3D feel
  const beta = e.beta ?? 0;  // front-back (-180..180)
  const gamma= e.gamma?? 0;  // left-right (-90..90)

  // rotate needle to north
  $q("#needle3d").style.transform = `translate(-50%,-100%) rotateZ(${heading}deg)`;
  // rotate qibla arrow relative to heading
  if(QIBLA_BRG!=null){
    const diff = ((QIBLA_BRG - heading + 540)%360)-180; // (-180..180)
    $q("#qArrow").style.transform = `translate(-50%,-100%) rotateZ(${diff}deg)`;
    $q("#qiblaInfo").textContent = `Qibla : ${Math.round(QIBLA_BRG)}¬∞ ‚Ä¢ Cap : ${Math.round(heading)}¬∞`;
  }
  // tilt scene
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const tiltX = clamp(gamma, -30, 30);
  const tiltY = clamp(beta,  -30, 30);
  $q("#q3dScene").style.transform = `rotateX(${-tiltY}deg) rotateY(${tiltX}deg)`;
}

/* =================== Language & Layout =================== */
function applyLanguage(){
  const L=T[CURR_LANG];
  document.documentElement.lang=CURR_LANG;
  document.documentElement.dir = (CURR_LANG==="ar") ? "rtl" : "ltr";
  document.body.style.direction = (CURR_LANG==="ar") ? "rtl" : "ltr";

  $q("#title").textContent=L.title;
  $q("#langLabel").textContent=L.lang;
  $q("#cityLabel").textContent=L.city;
  $q("#status").textContent=L.statusGeo;

  $q("#tab-home").textContent=L.tabs.home;
  $q("#tab-plan").textContent=L.tabs.plan;
  $q("#tab-adhkar").textContent=L.tabs.adhkar;
  $q("#tab-quran").textContent=L.tabs.quran;
  applyQiblaTexts();

  renderHome();
  renderPlan();
  renderAdhkar();
  renderQuran();
}

/* =================== Page navigation =================== */
function showPage(key){
  ["page-home","page-plan","page-adhkar","page-quran","page-qibla"].forEach(id=>{$q("#"+id).style.display="none";});
  ["tab-home","tab-plan","tab-adhkar","tab-quran","tab-qibla"].forEach(id=>$q("#"+id).classList.remove("active"));
  $q("#page-"+key).style.display="block"; $q("#tab-"+key).classList.add("active");
  localStorage.setItem("last_page", key);
}

/* =================== Geolocation bootstrap =================== */
async function locateAndBuild(){
  const L=T[CURR_LANG];
  $q("#status").textContent=L.statusGeo;
  if(!("geolocation" in navigator)){ $q("#status").textContent=L.geoNo; return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude,longitude}=pos.coords;
    USER_POS={lat:latitude, lon:longitude};
    $q("#status").textContent="üìç ‚Ä¶";
    try{
      const [city, timings]=await Promise.all([
        getCityName(latitude,longitude,CURR_LANG),
        getPrayerTimings(latitude,longitude)
      ]);
      $q("#cityName").textContent=city;
      CURRENT_SLOTS=buildSlots(timings);
      renderPlan();
      // Qibla bearing:
      QIBLA_BRG = computeQiblaBearing(latitude, longitude);
      $q("#qiblaInfo").textContent = `Qibla : ${Math.round(QIBLA_BRG)}¬∞ ‚Ä¢ Cap : ‚Äî¬∞`;
      $q("#status").textContent=L.geoOk;
      setInterval(renderPlan, 60*1000);
    }catch(e){
      console.error(e); $q("#status").textContent=L.loadErr;
    }
  }, err=>{
    console.warn(err); $q("#status").textContent=L.geoDenied; $q("#cityName").textContent="‚Äî";
  }, {enableHighAccuracy:true, timeout:15000});
}

/* =================== Events =================== */
document.addEventListener("DOMContentLoaded", ()=>{
  CURR_LANG = localStorage.getItem(prefLangKey) || "fr";
  $q("#lang").value = CURR_LANG;
  applyLanguage();

  showPage(localStorage.getItem("last_page") || "home");
  locateAndBuild();
  startCompass();

  $q("#lang").addEventListener("change", ()=>{
    CURR_LANG = $q("#lang").value;
    localStorage.setItem(prefLangKey, CURR_LANG);
    applyLanguage();
    locateAndBuild();
  });

  // nav
  $q("#tab-home").onclick=()=>showPage("home");
  $q("#tab-plan").onclick=()=>showPage("plan");
  $q("#tab-adhkar").onclick=()=>showPage("adhkar");
  $q("#tab-quran").onclick=()=>showPage("quran");
  $q("#tab-qibla").onclick=()=>showPage("qibla");

  // home CTAs
  $q("#goPlan").onclick=()=>showPage("plan");
  $q("#goAdhkar").onclick=()=>showPage("adhkar");
  $q("#goQuran").onclick=()=>showPage("quran");
  $q("#goQibla").onclick=()=>showPage("qibla");

  // planning actions
  $q("#retry").onclick=locateAndBuild;
  $q("#resetDay").onclick=()=>{
    for(let i=0;i<9;i++) localStorage.removeItem(`done_${todayKey()}_${i}`);
    renderPlan();
  };
});
</script>
</body>
</html>
