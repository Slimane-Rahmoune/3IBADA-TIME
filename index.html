<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planning adapt√© √† ma g√©olocalisation</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --text:#0f1a2b; --muted:#6b7280;
    --brand:#1e88e5; --now:#10b981; --shadow:0 1px 4px rgba(0,0,0,.12);
  }
  html,body{height:100%}
  body{margin:16px;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
  .wrap{max-width:900px;margin:0 auto}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#eef6ff;border:1px solid #cfe0ff;color:#0f2a4a;border-radius:999px;padding:6px 12px}
  .status{color:var(--muted);font-size:14px;margin:6px 0}
  .card{background:var(--card);box-shadow:var(--shadow);border-radius:12px;padding:12px;margin:12px 0}
  .task{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid #e7edf6;border-radius:10px;padding:10px;margin:8px 0}
  .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .time{font-weight:600}
  .badge{font-size:12px;background:#e8f1ff;border:1px solid #cfe0ff;border-radius:999px;padding:2px 8px}
  .ltr{direction:ltr; unicode-bidi:embed}
  .now{border-color:var(--now); box-shadow:0 0 0 2px rgba(16,185,129,.16)}
  .now .badge{background:#e9fff7; border-color:#b9f1df}
  .nowTag{font-size:12px;color:#0f8a6a;margin-left:6px}
  .done{text-decoration:line-through;color:#808a98}
  input[type="checkbox"]{width:20px;height:20px;accent-color:var(--brand)}
  .legend{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üï∞Ô∏è Planning (adapt√© √† ta position)</h1>
    <div class="pill" id="cityPill">üèôÔ∏è Ville : <strong id="cityName">‚Äî</strong></div>
  </header>

  <div class="status" id="status">‚è≥ Demande de g√©olocalisation‚Ä¶</div>

  <section class="card">
    <div class="legend">Les cr√©neaux sont calcul√©s √† partir de Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha (m√©thode Aladhan : Egypt). Mise √† jour du cr√©neau en cours toutes les minutes.</div>
    <div id="tasks"></div>
  </section>
</div>

<script>
/* ========= Libs utilitaires ========= */
const $ = s => document.querySelector(s);
const toMin = s => { const [h,m] = s.split(":").map(Number); return h*60 + m; }
const fromMin = m => { m=((m%1440)+1440)%1440; const h=Math.floor(m/60), mi=m%60; return String(h).padStart(2,"0")+":"+String(mi).padStart(2,"0"); }
const mid = (a,b) => fromMin(Math.floor((toMin(a)+toMin(b))/2));
const addMin = (hhmm, mins) => fromMin(toMin(hhmm)+mins);

/* ========= T√¢ches (FR) ========= */
const TASKS = [
  { name:"Avant Fajr", action:"Qiy√¢m & adhk√¢r" },            // 1
  { name:"Fajr ‚Üí +30 min apr√®s lever", action:"Fajr + Coran & invocations" }, // 2
  { name:"Matin (apr√®s lever+30)", action:"Travail/√âtudes avec intention" },   // 3
  { name:"Duha", action:"2‚Äì4 unit√©s de pri√®re" },            // 4
  { name:"Dhuhr", action:"Pri√®re + sieste courte" },         // 5
  { name:"‚ÄòAsr ‚Üí Maghrib", action:"Travail/Savoir + Sport" },// 6
  { name:"Maghrib ‚Üí ‚ÄòIsha", action:"Famille + Coran" },      // 7
  { name:"‚ÄòIsha", action:"Pri√®re + Lecture/Repos" },         // 8
  { name:"Nuit", action:"Dormir t√¥t + Qiy√¢m" }               // 9
];

/* ========= Calcul des cr√©neaux √† partir des horaires ========= */
function buildSlots({Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha}){
  // 1) Avant Fajr (fen√™tre autour de Fajr jusqu‚Äô√† Sunrise, max 60 min)
  const fajrEnd = fromMin(Math.min(toMin(addMin(Fajr,60)), toMin(Sunrise)));
  // 2) Fajr ‚Üí Sunrise+30
  const afterSunrise = addMin(Sunrise, 30);
  // 3) Matin (entre Sunrise+30 et milieu vers Dhuhr)
  const midMorning   = mid(afterSunrise, Dhuhr);
  // 8/9) Nuit d√©coup√©e autour du milieu entre Isha et Fajr+24h
  const midIshaFajr  = mid(Isha, addMin(Fajr, 24*60));

  return [
    {start:Fajr,     end:fajrEnd},         // 1 Avant Fajr
    {start:fajrEnd,  end:afterSunrise},    // 2 Fajr ‚Üí +30m
    {start:afterSunrise, end:midMorning},  // 3 Matin
    {start:midMorning,   end:Dhuhr},       // 4 Duha
    {start:Dhuhr,    end:Asr},             // 5 Dhuhr
    {start:Asr,      end:Maghrib},         // 6 Asr ‚Üí Maghrib
    {start:Maghrib,  end:Isha},            // 7 Maghrib ‚Üí Isha
    {start:Isha,     end:midIshaFajr},     // 8 Isha
    {start:midIshaFajr, end:addMin(Fajr,24*60)} // 9 Nuit
  ];
}

/* ========= D√©tection si ‚Äúmaintenant‚Äù ‚àà [start,end[ (g√®re minuit) ========= */
function nowIn(start, end){
  const cur = new Date(); let c = cur.getHours()*60 + cur.getMinutes();
  let s = toMin(start), e = toMin(end);
  if (e <= s) e += 1440;  // intervalle qui traverse minuit
  if (c < s) c += 1440;   // d√©placer ‚Äúmaintenant‚Äù si besoin
  return c >= s && c < e;
}

/* ========= Rendu ========= */
let CURRENT_SLOTS = null;
function renderSlots(){
  if(!CURRENT_SLOTS){ return; }
  const box = $("#tasks");
  box.innerHTML = "";

  CURRENT_SLOTS.forEach((slot, i) => {
    const dateKey = new Date().toISOString().slice(0,10);
    const key = `done_${dateKey}_${i}`;
    const checked = localStorage.getItem(key) === "1";
    const isNow = nowIn(slot.start, slot.end);

    const row = document.createElement("div");
    row.className = "task" + (isNow ? " now" : "");
    row.innerHTML = `
      <div class="left">
        <input type="checkbox" id="chk-${i}" ${checked ? "checked": ""}/>
        <span class="time">${TASKS[i].name}</span>
        <span id="txt-${i}" class="${checked?"done":""}">${TASKS[i].action}</span>
        <span class="badge"><span class="ltr">${slot.start} ‚Äì ${slot.end}</span></span>
        ${isNow ? `<span class="nowTag">‚Ä¢ Cr√©neau en cours</span>` : ""}
      </div>
      <div></div>
    `;
    box.appendChild(row);

    $("#chk-"+i).addEventListener("change", (e) => {
      localStorage.setItem(key, e.target.checked ? "1" : "0");
      $("#txt-"+i).classList.toggle("done", e.target.checked);
    });
  });
}

/* ========= Appels API (g√©oloc + reverse + timings) ========= */
async function getCityName(lat, lon){
  try{
    const resp = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=fr`);
    const j = await resp.json();
    return j.city || j.locality || j.principalSubdivision || j.countryName || "‚Äî";
  }catch{
    return "‚Äî";
  }
}

async function getPrayerTimings(lat, lon, method=4){
  const r = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=${method}`);
  const j = await r.json();
  const t = j.data.timings;
  // nettoyer HH:MM
  const clean = v => (v||"").split(" ")[0].slice(0,5);
  return {
    Fajr:    clean(t.Fajr),
    Sunrise: clean(t.Sunrise),
    Dhuhr:   clean(t.Dhuhr),
    Asr:     clean(t.Asr),
    Maghrib: clean(t.Maghrib),
    Isha:    clean(t.Isha)
  };
}

/* ========= Initialisation ========= */
async function init(){
  $("#status").textContent = "‚è≥ Demande de g√©olocalisation‚Ä¶";
  if(!("geolocation" in navigator)){
    $("#status").textContent = "‚ùå G√©olocalisation non support√©e par ce navigateur.";
    return;
  }
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    $("#status").textContent = "üìç Position d√©tect√©e. R√©cup√©ration des horaires‚Ä¶";

    try{
      const [city, timings] = await Promise.all([
        getCityName(latitude, longitude),
        getPrayerTimings(latitude, longitude, 4) // Egypt (bon compromis)
      ]);

      $("#cityName").textContent = city;

      CURRENT_SLOTS = buildSlots(timings);
      renderSlots();
      $("#status").textContent = "‚úÖ Cr√©neaux mis √† jour selon ta localisation.";

      // Mettre √† jour l‚Äôindicateur ¬´ en cours ¬ª chaque minute
      setInterval(renderSlots, 60*1000);

    }catch(err){
      console.error(err);
      $("#status").textContent = "‚ö†Ô∏è Erreur lors de la r√©cup√©ration des horaires.";
    }
  }, err => {
    console.warn(err);
    $("#status").textContent = "‚ö†Ô∏è Acc√®s √† la g√©olocalisation refus√©. Autorise la localisation et recharge la page.";
    $("#cityName").textContent = "‚Äî";
  }, { enableHighAccuracy:true, timeout:15000 });
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
