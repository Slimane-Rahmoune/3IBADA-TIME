
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>جدول إدارة الوقت + تنبيهات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Tahoma, Arial; background:#eef6ff; margin:14px; direction:rtl; }
    h2, h3 { text-align:center; color:#1b2a41; }
    .card { background:white; padding:12px; margin:10px 0; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
    .task { padding:8px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
    .task:last-child { border-bottom:none; }
    .done { text-decoration: line-through; color:gray; }
    button, input[type="time"] { padding:8px 10px; border-radius:8px; border:1px solid #cfd8e3; background:#fff; }
    button { cursor:pointer; }
    .primary { background:#1e88e5; color:white; border:none; }
    .muted { color:#5f6b7a; font-size:12px; }
    label { display:block; margin:6px 0 4px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; }
    .col { flex:1; min-width:180px; }
    .tiny { font-size:12px; color:#6d7a89; }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align:middle;}
    .switch input {display:none;}
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .2s; border-radius:24px;}
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius:50%;}
    input:checked + .slider { background-color: #1e88e5;}
    input:checked + .slider:before { transform: translateX(20px); }
    .header-actions { display:flex; justify-content:center; gap:10px; margin-bottom:10px; }
  </style>
</head>
<body>
  <h2>🕰️ جدول إدارة الوقت على منهج النبي ﷺ</h2>

  <div class="header-actions">
    <button class="primary" id="btnNotify">🔔 فعّل الإشعارات</button>
    <button id="btnInstall">⬇️ أضِف للشاشة الرئيسية</button>
    <span class="tiny">ملاحظة: تعمل الإشعارات عند فتح الصفحة أو بقائها بالخلفية في بعض المتصفحات.</span>
  </div>

  <div class="card" id="tasksCard">
    <h3>قائمة اليوم</h3>
    <div id="tasks"></div>
  </div>

  <div class="card">
    <h3>التنبيهات (اضبط الأوقات حسب مدينتك)</h3>
    <div class="row" id="reminders"></div>
    <div style="margin-top:10px; text-align:center;">
      <button class="primary" id="saveTimes">💾 حفظ الأوقات وإعادة الجدولة</button>
      <div class="muted" id="status"></div>
    </div>
    <p class="tiny">تلميح: يمكنك استخدام تطبيق أوقات الصلاة لحساب المواقيت، ثم ضعها هنا يدويًا.</p>
  </div>

  <script>
    // --- بيانات المهام ---
    const TASKS = [
      {key:"qiyam", name:"قبل الفجر", action:"قيام الليل وذكر الله", default:"04:30"},
      {key:"fajr", name:"الفجر – الشروق", action:"صلاة الفجر + ذكر وقرآن", default:"05:30"},
      {key:"sabah", name:"الصباح", action:"عمل/دراسة بنيّة لله", default:"08:00"},
      {key:"duha", name:"الضحى", action:"ركعتان أو أربع", default:"10:30"},
      {key:"dhuhr", name:"الظهر", action:"صلاة + قيلولة", default:"13:30"},
      {key:"asr", name:"العصر – المغرب", action:"عمل/علم + رياضة", default:"17:00"},
      {key:"maghrib", name:"المغرب – العشاء", action:"جلسة عائلية + قرآن", default:"20:00"},
      {key:"isha", name:"العشاء", action:"صلاة + راحة/مطالعة", default:"21:30"},
      {key:"night", name:"الليل", action:"نوم مبكر + قيام الليل", default:"23:00"}
    ];

    // --- رسم قائمة المهام ---
    const tasksDiv = document.getElementById('tasks');
    TASKS.forEach((t,i)=>{
      const row = document.createElement('div');
      row.className = 'task';
      row.innerHTML = \`
        <div>
          <b>\${t.name}:</b> <span id="txt\${t.key}">\${t.action}</span>
        </div>
        <div>
          <button onclick="toggleDone('\${t.key}')">✅</button>
        </div>
      \`;
      tasksDiv.appendChild(row);
    });

    function toggleDone(key){
      document.getElementById('txt'+key).classList.toggle('done');
      // حفظ إنجاز اليوم (يوميًا)
      const dayKey = new Date().toISOString().slice(0,10);
      const done = JSON.parse(localStorage.getItem('done_'+dayKey) || '{}');
      done[key] = document.getElementById('txt'+key).classList.contains('done');
      localStorage.setItem('done_'+dayKey, JSON.stringify(done));
    }

    // استرجاع إنجازات اليوم عند التحميل
    (function restoreDone(){
      const dayKey = new Date().toISOString().slice(0,10);
      const done = JSON.parse(localStorage.getItem('done_'+dayKey) || '{}');
      Object.keys(done).forEach(k=>{
        if(done[k]) document.getElementById('txt'+k).classList.add('done');
      });
    })();

    // --- قسم التنبيهات ---
    const remindersDiv = document.getElementById('reminders');
    function loadTimes(){
      const saved = JSON.parse(localStorage.getItem('times') || '{}');
      remindersDiv.innerHTML = '';
      TASKS.forEach(t=>{
        const val = saved[t.key] || t.default;
        const enabled = (saved[t.key+'_en'] !== undefined) ? !!saved[t.key+'_en'] : true;
        const col = document.createElement('div');
        col.className = 'col';
        col.innerHTML = \`
          <label><b>\${t.name}</b></label>
          <input type="time" id="time_\${t.key}" value="\${val}">
          <label class="tiny">تفعيل التنبيه
            <span class="switch">
              <input type="checkbox" id="en_\${t.key}" \${enabled ? 'checked' : ''}>
              <span class="slider"></span>
            </span>
          </label>
        \`;
        remindersDiv.appendChild(col);
      });
    }
    loadTimes();

    document.getElementById('saveTimes').addEventListener('click', ()=>{
      const data = {};
      TASKS.forEach(t=>{
        data[t.key] = document.getElementById('time_'+t.key).value || t.default;
        data[t.key+'_en'] = document.getElementById('en_'+t.key).checked;
      });
      localStorage.setItem('times', JSON.stringify(data));
      cancelAllSchedules();
      scheduleAll();
      setStatus('✅ تم الحفظ وإعادة جدولة التنبيهات');
    });

    function setStatus(msg){
      document.getElementById('status').textContent = msg;
      setTimeout(()=> document.getElementById('status').textContent = '', 4000);
    }

    // --- إشعارات المتصفح ---
    function notify(title, body){
      if ('Notification' in window && Notification.permission === 'granted'){
        new Notification(title, { body });
      } else {
        alert(title + "\n" + body);
      }
    }

    document.getElementById('btnNotify').addEventListener('click', async ()=>{
      if (!('Notification' in window)){
        alert('متصفحك لا يدعم الإشعارات. سيُستخدم التنبيه داخل الصفحة فقط.');
        return;
      }
      let perm = Notification.permission;
      if (perm !== 'granted'){
        try {
          perm = await Notification.requestPermission();
        } catch(e){}
      }
      if (perm === 'granted'){
        notify('تم تفعيل الإشعارات ✅','ستتلقى تنبيهات حسب الأوقات المحددة.');
        scheduleAll();
      } else {
        alert('لم تُفعّل الإشعارات من المتصفح. سنستخدم تنبيهات داخل الصفحة فقط.');
      }
    });

    // --- جدولة التنبيهات (طالما الصفحة مفتوحة/في الخلفية) ---
    const timers = [];
    function cancelAllSchedules(){
      while(timers.length){
        const id = timers.pop();
        clearTimeout(id);
      }
    }

    function parseTimeToTodayHHMM(str){
      const [h,m] = str.split(':').map(x=>parseInt(x,10));
      const now = new Date();
      const t = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0, 0);
      return t;
    }

    function msUntilNext(timeStr){
      const now = new Date();
      let t = parseTimeToTodayHHMM(timeStr);
      if (t <= now){ // مرّ الوقت اليوم -> غدًا
        t = new Date(t.getTime() + 24*60*60*1000);
      }
      return t.getTime() - now.getTime();
    }

    function scheduleOne(t){
      const saved = JSON.parse(localStorage.getItem('times') || '{}');
      const timeStr = saved[t.key] || t.default;
      const enabled = (saved[t.key+'_en'] !== undefined) ? !!saved[t.key+'_en'] : true;
      if (!enabled) return;
      const ms = msUntilNext(timeStr);
      const id = setTimeout(()=>{
        notify('⏰ تنبيه: '+t.name, t.action);
        // بعد الإطلاق، أعد الجدولة لليوم التالي
        scheduleOne(t);
      }, ms);
      timers.push(id);
    }

    function scheduleAll(){
      TASKS.forEach(scheduleOne);
    }

    // جدولة تلقائية عند فتح الصفحة إذا كانت الأذونات مفعّلة
    if ('Notification' in window && Notification.permission === 'granted'){
      scheduleAll();
    }

    // --- إضافة للشاشة الرئيسية (PWA دون خادم خارجي) ---
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('btnInstall').style.display = 'inline-block';
    });

    document.getElementById('btnInstall').addEventListener('click', async ()=>{
      if (!deferredPrompt){ alert('إذا لم يظهر زر التثبيت، استخدم "إضافة إلى الشاشة الرئيسية" من قائمة المتصفح.'); return; }
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });
  </script>
</body>
</html>
