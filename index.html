<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Accueil â€¢ Planning â€¢ AdhkÃ¢r â€¢ Coran â€¢ Qibla 3D â€¢ AdhÃ¢n</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --text:#0f1a2b; --muted:#6b7280;
    --brand:#1e88e5; --now:#10b981; --shadow:0 1px 4px rgba(0,0,0,.12);
    --accent:#0ea5e9; --danger:#ef4444;
  }
  html,body{height:100%}
  body{margin:16px;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#eef6ff;border:1px solid #cfe0ff;color:#0f2a4a;border-radius:999px;padding:6px 12px}
  .status{color:var(--muted);font-size:14px;margin:6px 0}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid #cfd8e3;background:#fff;cursor:pointer}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

  .card{background:var(--card);box-shadow:var(--shadow);border-radius:12px;padding:12px;margin:12px 0}
  .legend{font-size:13px;color:var(--muted);margin-bottom:6px}

  .hero{display:flex;flex-direction:column;gap:8px}
  .cta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{border:1px solid #cfd8e3;background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border:none}
  .btn.danger{background:var(--danger);color:#fff;border:none}
  select,button,input[type="text"]{border:1px solid #cfd8e3;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}

  .task{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid #e7edf6;border-radius:10px;padding:10px;margin:8px 0}
  .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .time{font-weight:600}
  .badge{font-size:12px;background:#e8f1ff;border:1px solid #cfe0ff;border-radius:999px;padding:2px 8px}
  .ltr{direction:ltr;unicode-bidi:embed}
  .now{border-color:var(--now);box-shadow:0 0 0 2px rgba(16,185,129,.16)}
  .now .badge{background:#e9fff7;border-color:#b9f1df}
  .nowTag{font-size:12px;color:#0f8a6a;margin-inline-start:6px}
  .done{text-decoration:line-through;color:#808a98}
  input[type="checkbox"]{width:20px;height:20px;accent-color:var(--brand)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:8px 0}

  /* AdhkÃ¢r */
  .adh-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .sectionHead{display:flex;align-items:center;justify-content:space-between;margin:10px 0 6px}
  .catTitle{font-weight:600}
  .sectionActions{display:flex;gap:6px}
  .dhk{border:1px solid #e6ebf2;border-radius:10px;padding:10px;margin:8px 0}
  .dhk .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .counter{min-width:46px;text-align:center;border-radius:8px;border:1px solid #cfd8e3;padding:4px 8px}
  .tag{display:inline-block;font-size:12px;background:#fafafa;border:1px solid #e8e8e8;border-radius:999px;padding:2px 8px;margin-inline-start:6px}
  .divider{height:1px;background:#e9eef5;margin:8px 0}

  /* Quran */
  .qrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  iframe{width:100%;height:70vh;border:none;border-radius:12px;box-shadow:var(--shadow)}

  /* Qibla 3D */
  .q3d-top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .q3d-stage{perspective:900px;display:flex;justify-content:center;align-items:center}
  .q3d-scene{width:320px;height:320px;position:relative;transform-style:preserve-3d;transition:transform .15s ease-out}
  .q3d-disk{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:260px;height:260px;border-radius:50%;background:radial-gradient(circle at 50% 50%, #fdfefe 0 35%, #e8eef6 36% 37%, #fdfefe 38% 100%);border:10px solid #e7edf6;box-shadow:var(--shadow)}
  .q3d-ring::before,.q3d-ring::after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:260px;height:260px;border-radius:50%;box-shadow:inset 0 0 0 2px #d6e2f0,inset 0 0 0 18px transparent}
  .q3d-north{position:absolute;left:50%;top:22px;transform:translateX(-50%);font-weight:700;color:#0f2a4a}
  .q3d-needle{position:absolute;left:50%;top:50%;width:8px;height:140px;transform-origin:50% 100%;transform:translate(-50%,-100%) rotateZ(0deg)}
  .q3d-needle .shaft{width:8px;height:105px;background:#1e293b;border-radius:4px 4px 0 0;box-shadow:0 0 10px rgba(0,0,0,.08)}
  .q3d-needle .head{width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:28px solid #e53935;margin-left:-8px}
  .q3d-qibla{position:absolute;left:50%;top:50%;width:0;height:0;transform-origin:50% 100%;transform:translate(-50%,-100%) rotateZ(0deg)}
  .q3d-qibla .body{width:10px;height:100px;background:#10b981;border-radius:6px 6px 0 0;margin-left:-5px;box-shadow:0 0 10px rgba(16,185,129,.25)}
  .q3d-qibla .tip{width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:30px solid #10b981;margin-left:-9px}
  .q3d-label{position:absolute;left:50%;top:50%;transform:translate(-50%,-160%);background:#e7f8f2;border:1px solid #b9f1df;color:#065f46;font-size:12px;border-radius:999px;padding:2px 8px}
  .q3d-hint{font-size:12px;color:var(--muted);margin-top:6px}

  /* Horaires & AdhÃ¢n */
  .adhan-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .adhan-table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .adhan-table th{font-weight:600;color:#475569;text-align:left;padding:6px 8px}
  .adhan-row{background:#fff;border:1px solid #e7edf6;border-radius:12px;box-shadow:var(--shadow)}
  .adhan-row td{padding:10px 8px;vertical-align:middle}
  .pill-small{font-size:12px;background:#eef6ff;border:1px solid #cfe0ff;border-radius:999px;padding:2px 8px;display:inline-block}
  .sel{min-width:180px}
  .mute{opacity:.5}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="title">ğŸ  Accueil â€¢ ğŸ•°ï¸ Planning â€¢ ğŸ•¯ï¸ AdhkÃ¢r â€¢ ğŸ“– Coran â€¢ ğŸ§­ Qibla 3D â€¢ ğŸ”” AdhÃ¢n</h1>
    <div class="right">
      <label for="lang" id="langLabel">Langue :</label>
      <select id="lang">
        <option value="fr">FranÃ§ais</option>
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="en">English</option>
      </select>
      <div class="pill">ğŸ™ï¸ <span id="cityLabel">Ville :</span> <strong id="cityName">â€”</strong></div>
    </div>
  </header>

  <div class="status" id="status">â³ Demande de gÃ©olocalisationâ€¦</div>

  <div class="tabs">
    <button class="tab active" id="tab-home">ğŸ  Accueil</button>
    <button class="tab" id="tab-plan">ğŸ“‹ Planning</button>
    <button class="tab" id="tab-adhkar">ğŸ•¯ï¸ AdhkÃ¢r</button>
    <button class="tab" id="tab-quran">ğŸ“– Coran</button>
    <button class="tab" id="tab-qibla">ğŸ§­ Qibla 3D</button>
    <button class="tab" id="tab-adhan">ğŸ”” Horaires & AdhÃ¢n</button>
  </div>

  <!-- HOME -->
  <section class="card" id="page-home">
    <div class="hero" id="homeHero"></div>
    <div class="cta">
      <button class="btn primary" id="goPlan">â¡ï¸ Planning</button>
      <button class="btn" id="goAdhkar">ğŸ•¯ï¸ AdhkÃ¢r</button>
      <button class="btn" id="goQuran">ğŸ“– Coran</button>
      <button class="btn" id="goQibla">ğŸ§­ Qibla 3D</button>
      <button class="btn" id="goAdhan">ğŸ”” Horaires & AdhÃ¢n</button>
    </div>
  </section>

  <!-- PLANNING -->
  <section class="card" id="page-plan" style="display:none">
    <div class="legend" id="legend"></div>
    <div class="toolbar">
      <button id="retry" class="btn">â†» Re-demander la gÃ©olocalisation</button>
      <button id="resetDay" class="btn">â†º RÃ©initialiser la progression du jour</button>
    </div>
    <div id="tasks"></div>
  </section>

  <!-- ADHKAR -->
  <section class="card" id="page-adhkar" style="display:none">
    <div class="adh-toolbar">
      <label for="slotSel" id="slotLabel">CrÃ©neau :</label>
      <select id="slotSel"></select>
      <input type="text" id="adhSearch" placeholder="Rechercheâ€¦" />
      <button id="resetAdhkar" class="btn primary">â†º RÃ©initialiser les compteurs</button>
    </div>
    <div id="adhkarList"></div>
    <p class="status" id="adhHint"></p>
  </section>

  <!-- QURAN -->
  <section class="card" id="page-quran" style="display:none">
    <div class="qrow">
      <label id="qLabel1">Sourate :</label>
      <select id="surahSel"></select>
      <label id="qLabel2">Juz :</label>
      <select id="juzSel"></select>
      <label id="reciterLabel">RÃ©citateur :</label>
      <select id="reciterSel"></select>
      <button id="openSurah" class="btn primary"></button>
      <button id="playAudio" class="btn">â–¶ï¸ Audio</button>
      <button id="markRead" class="btn"></button>
      <button id="resetRead" class="btn"></button>
    </div>
    <div class="status" id="readStatus"></div>
    <audio id="qAudio" preload="none" controls style="width:100%;margin:8px 0"></audio>
    <iframe id="qFrame" title="Quran"></iframe>
  </section>

  <!-- QIBLA 3D -->
  <section class="card" id="page-qibla" style="display:none">
    <div class="q3d-top">
      <button class="btn primary" id="enableCompass">ğŸ§­ Activer la boussole</button>
      <div class="status" id="qiblaInfo">Qibla : â€”Â° â€¢ Cap : â€”Â°</div>
    </div>
    <div class="q3d-stage">
      <div class="q3d-scene" id="q3dScene">
        <div class="q3d-disk q3d-ring"></div>
        <div class="q3d-north">N</div>
        <div class="q3d-needle" id="needle3d"><div class="shaft"></div><div class="head"></div></div>
        <div class="q3d-qibla" id="qArrow"><div class="body"></div><div class="tip"></div></div>
        <div class="q3d-label" id="qLabel">Kaaba</div>
      </div>
    </div>
    <div class="q3d-hint" id="qiblaHint"></div>
  </section>

  <!-- HORAIRES & ADHAN -->
  <section class="card" id="page-adhan" style="display:none">
    <div class="adhan-bar">
      <button class="btn primary" id="reqNotify">ğŸ”” Autoriser les notifications</button>
      <button class="btn" id="resync">â†» Reprogrammer les adhÃ¢n</button>
      <span class="status" id="nextAdhanMsg"></span>
    </div>
    <div class="legend" id="legendAdhan"></div>
    <table class="adhan-table">
      <thead>
        <tr>
          <th>ğŸ“¿ PriÃ¨re</th>
          <th>â° Horaire</th>
          <th>ğŸ”” Mode</th>
          <th>ğŸ—£ï¸ Muezzin</th>
          <th>â–¶ï¸ Test</th>
        </tr>
      </thead>
      <tbody id="adhanRows"></tbody>
    </table>
    <audio id="adhanAudio" preload="auto"></audio>
  </section>
</div>

<script>
/* =================== I18N =================== */
const T={
  fr:{title:"ğŸ  Accueil â€¢ ğŸ•°ï¸ Planning â€¢ ğŸ•¯ï¸ AdhkÃ¢r â€¢ ğŸ“– Coran â€¢ ğŸ§­ Qibla 3D â€¢ ğŸ”” AdhÃ¢n",
      lang:"Langue :", city:"Ville :", statusGeo:"â³ Demande de gÃ©olocalisationâ€¦",
      tabs:{home:"ğŸ  Accueil",plan:"ğŸ“‹ Planning",adhkar:"ğŸ•¯ï¸ AdhkÃ¢r",quran:"ğŸ“– Coran",qibla:"ğŸ§­ Qibla 3D",adhan:"ğŸ”” Horaires & AdhÃ¢n"},
      home:{h1:"Bienvenue !",
        p1:"Je mâ€™appelle <strong>Slimane Rahmoune</strong>. Je vous partage ici des crÃ©neaux dâ€™adorations inspirÃ©s de la sunnah du ProphÃ¨te ï·º.",
        p2:"Vous pouvez lire le Coran, rÃ©citer les adhkÃ¢r, et suivre votre progression via une checklist simple.",
        ded:"<strong>Cette application est une <em>sadaqa jÃ¢riya</em> dÃ©diÃ©e Ã  ma dÃ©funte et chÃ¨re tante BEN BOURENANE TOUNSIA</strong> â€” quâ€™Allah lui fasse misÃ©ricorde. Merci de lâ€™utiliser pour Ã©couter et lire le Coran, rÃ©citer les adhkÃ¢r et suivre les adorations du ProphÃ¨te ï·º.",
        p3:"Faites de votre mieux, rÃ©guliÃ¨rement et sincÃ¨rement â€” pour devenir, in chÃ¢â€™ AllÃ¢h, des musulman(e)s exemplaires.",
        note:"Les crÃ©neaux sâ€™adaptent automatiquement Ã  votre gÃ©olocalisation."
      },
      legend:"CrÃ©neaux calculÃ©s via Aladhan (mÃ©thode 4 = Egypt). Indicateur Â« en cours Â» actualisÃ© chaque minute.",
      retry:"â†» Re-demander la gÃ©olocalisation", resetDay:"â†º RÃ©initialiser la progression du jour", now:"CrÃ©neau en cours",
      tasks:[
        { name:"Avant Fajr",        action:"QiyÃ¢m & adhkÃ¢r" },
        { name:"Fajr â†’ +30 min",    action:"Fajr + Coran & invocations" },
        { name:"Matin",             action:"Travail/Ã‰tudes avec intention" },
        { name:"Duha",              action:"2â€“4 unitÃ©s de priÃ¨re" },
        { name:"Dhuhr",             action:"PriÃ¨re + sieste courte" },
        { name:"â€˜Asr â†’ Maghrib",    action:"Travail/Savoir + Sport" },
        { name:"Maghrib â†’ â€˜Isha",   action:"Famille + Coran" },
        { name:"â€˜Isha",             action:"PriÃ¨re + Lecture/Repos" },
        { name:"Nuit",              action:"Dormir tÃ´t + QiyÃ¢m" }
      ],
      adh:{slot:"CrÃ©neau :",reset:"â†º RÃ©initialiser les compteurs",hint:"Les compteurs sont sauvegardÃ©s localement (par jour et par crÃ©neau).",
           groups:{all:"Tous", morning:"Matin", afterPrayer:"AprÃ¨s les priÃ¨res", evening:"Soir", sleep:"Avant de dormir", home:"Maison"}},
      q:{s:"Sourate :",j:"Juz :",open:"Ouvrir",mark:"âœ… Marquer lu",reset:"â†º RÃ©initialiser",last:s=>`DerniÃ¨re lecture : ${s}`, reciter:"RÃ©citateur :"},
      qibla:{hint:"Sur iPhone/iPad, appuyez sur Â« Activer la boussole Â» pour autoriser le capteur.", label:"Kaaba"},
      adhan:{legend:"RÃ©glez lâ€™adhÃ¢n par priÃ¨re : DÃ©sactivÃ© / Son / Vibreur. Choisissez aussi le muezzin.",
             off:"DÃ©sactivÃ©", sound:"AdhÃ¢n (son)", vibrate:"Vibreur",
             notifAsk:"ğŸ”” Autoriser les notifications",
             muezzin:"Muezzin :", next:t=>`Prochain adhÃ¢n programmÃ© : ${t}`}
  },
  ar:{title:"ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€¢ ğŸ•°ï¸ Ø§Ù„ØªØ®Ø·ÙŠØ· â€¢ ğŸ•¯ï¸ Ø§Ù„Ø£Ø°ÙƒØ§Ø± â€¢ ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† â€¢ ğŸ§­ Ø§Ù„Ù‚Ø¨Ù„Ø© 3D â€¢ ğŸ”” Ø§Ù„Ø£Ø°Ø§Ù†",
      lang:"Ø§Ù„Ù„ØºØ©:", city:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:", statusGeo:"â³ Ø¬Ø§Ø±Ù Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦",
      tabs:{home:"ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",plan:"ğŸ“‹ Ø§Ù„ØªØ®Ø·ÙŠØ·",adhkar:"ğŸ•¯ï¸ Ø§Ù„Ø£Ø°ÙƒØ§Ø±",quran:"ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù†",qibla:"ğŸ§­ Ø§Ù„Ù‚Ø¨Ù„Ø© 3D",adhan:"ğŸ”” Ø§Ù„Ø£ÙˆÙ‚Ø§Øª ÙˆØ§Ù„Ø£Ø°Ø§Ù†"},
      home:{h1:"Ù…Ø±Ø­Ø¨Ù‹Ø§!",
        p1:"Ø£Ù†Ø§ <strong>Ø³Ù„ÙŠÙ…Ø§Ù† Ø±Ø­Ù…ÙˆÙ†</strong>. Ø£Ø´Ø§Ø±ÙƒÙƒÙ… ÙØªØ±Ø§ØªÙ Ù„Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ù†Ø© Ù„Ù„Ù†Ø¨ÙŠ ï·º.",
        p2:"ÙŠÙ…ÙƒÙ†ÙƒÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†ØŒ ÙˆØ°ÙƒØ± Ø§Ù„Ø£Ø°ÙƒØ§Ø±ØŒ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø¹Ø¨Ø± Ù‚Ø§Ø¦Ù…Ø© ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·Ø©.",
        ded:"<strong>  Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØµØ¯Ù‚Ø© Ø¬Ø§Ø±ÙŠØ© Ù„Ø®Ø§Ù„ØªÙŠ Ø§Ù„Ø­Ø¨ÙŠØ¨Ø© Ø§Ù„Ù…ØªÙˆÙØ§Ø© Ø¨Ù† Ø¨ÙˆØ±Ù†Ø§Ù† ØªÙˆÙ†Ø³ÙŠØ© </strong> â€” Ù†Ø³Ø£Ù„ Ø§Ù„Ù„Ù‡ Ø£Ù† ÙŠØ±Ø­Ù…Ù‡Ø§. Ù†Ø±Ø¬Ùˆ Ø§Ø³ØªØ¹Ù…Ø§Ù„Ù‡ Ù„Ø³Ù…Ø§Ø¹ ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†ØŒ ÙˆØ°ÙƒØ± Ø§Ù„Ø£Ø°ÙƒØ§Ø±ØŒ ÙˆØ§ØªØ¨Ø§Ø¹ Ø¹Ø¨Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¨ÙŠ ï·º.",
        p3:"Ø§Ø¨Ø°Ù„ÙˆØ§ Ø¬Ù‡Ø¯ÙƒÙ… Ø¨Ø§Ù†ØªØ¸Ø§Ù… ÙˆØ¥Ø®Ù„Ø§ØµÙ‹ Ù„ØªÙƒÙˆÙ†ÙˆØ§ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡ Ù…Ø³Ù„Ù…ÙŠÙ† ÙˆÙ‚Ø¯ÙˆØ§Øª.",
        note:"ØªØªÙƒÙŠÙ‘Ù Ø§Ù„ÙØªØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹ÙƒÙ…."
      },
      legend:"Ø­ÙØ³ÙØ¨Øª Ø§Ù„ÙØªØ±Ø§Øª Ø¹Ø¨Ø± Aladhan (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ù¤ = Ù…ØµØ±). ÙŠÙØ­Ø¯Ù‘Ø« Ù…Ø¤Ø´Ø± Â«Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù‡Ù†Ø§Â» ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©.",
      retry:"â†» Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹", resetDay:"â†º ØªØµÙÙŠØ± Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…", now:"Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù‡Ù†Ø§",
      tasks:[
        { name:"Ù‚Ø¨Ù„ Ø§Ù„ÙØ¬Ø±",        action:"Ù‚ÙŠØ§Ù… Ø§Ù„Ù„ÙŠÙ„ ÙˆØ°ÙƒØ± Ø§Ù„Ù„Ù‡" },
        { name:"Ø§Ù„ÙØ¬Ø± â†’ +30 Ø¯Ù‚ÙŠÙ‚Ø©", action:"ÙØ¬Ø± + Ù‚Ø±Ø¢Ù† ÙˆØ£Ø¯Ø¹ÙŠØ©" },
        { name:"Ø§Ù„ØµØ¨Ø§Ø­",           action:"Ø¹Ù…Ù„/Ø¯Ø±Ø§Ø³Ø© Ø¨Ù†ÙŠØ©" },
        { name:"Ø§Ù„Ø¶Ø­Ù‰",            action:"Ø±ÙƒØ¹ØªØ§Ù† Ø¥Ù„Ù‰ Ø£Ø±Ø¨Ø¹" },
        { name:"Ø§Ù„Ø¸Ù‡Ø±",            action:"ØµÙ„Ø§Ø© + Ù‚ÙŠÙ„ÙˆÙ„Ø©" },
        { name:"Ø§Ù„Ø¹ØµØ± â†’ Ø§Ù„Ù…ØºØ±Ø¨",   action:"Ø¹Ù…Ù„/Ø¹Ù„Ù… + Ø±ÙŠØ§Ø¶Ø©" },
        { name:"Ø§Ù„Ù…ØºØ±Ø¨ â†’ Ø§Ù„Ø¹Ø´Ø§Ø¡",  action:"Ø¬Ù„Ø³Ø© Ø¹Ø§Ø¦Ù„ÙŠØ© + Ù‚Ø±Ø¢Ù†" },
        { name:"Ø§Ù„Ø¹Ø´Ø§Ø¡",           action:"ØµÙ„Ø§Ø© + Ù‚Ø±Ø§Ø¡Ø©/Ø±Ø§Ø­Ø©" },
        { name:"Ø§Ù„Ù„ÙŠÙ„",            action:"Ù†ÙˆÙ… Ù…Ø¨ÙƒØ± + Ù‚ÙŠØ§Ù…" }
      ],
      adh:{slot:"Ø§Ù„ÙØªØ±Ø©:",reset:"â†º ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª",hint:"ÙŠÙØ­ÙØ¸ Ø§Ù„Ø¹Ø¯Ù‘ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ù„ÙƒÙ„ ÙŠÙˆÙ… ÙˆÙØªØ±Ø©).",
           groups:{all:"Ø§Ù„ÙƒÙ„", morning:"Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­", afterPrayer:"Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„ÙˆØ§Øª", evening:"Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡", sleep:"Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…", home:"Ø§Ù„Ø¨ÙŠØª"}},
      q:{s:"Ø³ÙˆØ±Ø©:",j:"Ø¬Ø²Ø¡:",open:"ÙØªØ­",mark:"âœ… ØªÙ…Ù‘Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©",reset:"â†º ØªØµÙÙŠØ±",last:s=>`Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©: ${s}`, reciter:"Ø§Ù„Ù‚Ø§Ø±Ø¦:"},
      qibla:{hint:"Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© Apple Ø§Ø¶ØºØ· Â«ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØµÙ„Ø©Â».", label:"Ø§Ù„ÙƒØ¹Ø¨Ø©"},
      adhan:{legend:"Ø§Ø¶Ø¨Ø· Ø§Ù„Ø£Ø°Ø§Ù† Ù„ÙƒÙ„ ØµÙ„Ø§Ø©: Ø¥ÙŠÙ‚Ø§Ù / ØµÙˆØª / Ø§Ù‡ØªØ²Ø§Ø²ØŒ ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…Ø¤Ø°Ù‘Ù†.",
             off:"Ø¥ÙŠÙ‚Ø§Ù", sound:"Ø§Ù„Ø£Ø°Ø§Ù† (ØµÙˆØª)", vibrate:"Ø§Ù‡ØªØ²Ø§Ø²",
             notifAsk:"ğŸ”” Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª",
             muezzin:"Ø§Ù„Ù…Ø¤Ø°Ù‘Ù†:", next:t=>`Ø§Ù„Ø£Ø°Ø§Ù† Ø§Ù„Ù‚Ø§Ø¯Ù…: ${t}`}
  },
  en:{title:"ğŸ  Home â€¢ ğŸ•°ï¸ Plan â€¢ ğŸ•¯ï¸ Adhkar â€¢ ğŸ“– Quran â€¢ ğŸ§­ Qibla 3D â€¢ ğŸ”” Adhan",
      lang:"Language:", city:"City:", statusGeo:"â³ Requesting geolocationâ€¦",
      tabs:{home:"ğŸ  Home",plan:"ğŸ“‹ Plan",adhkar:"ğŸ•¯ï¸ Adhkar",quran:"ğŸ“– Quran",qibla:"ğŸ§­ Qibla 3D",adhan:"ğŸ”” Timings & Adhan"},
      home:{h1:"Welcome!",
        p1:"Iâ€™m <strong>Slimane Rahmoune</strong>. I share worship time slots inspired by the Prophetic ï·º way.",
        p2:"You can read Qurâ€™an, recite adhkÄr, and track progress with a simple checklist.",
        ded:"<strong>This app is a sadaqah jariyah dedicated to my beloved late aunt BEN BOURENANE TOUNSIA</strong>. Please use it to listen to and read the Qurâ€™an, recite adhkÄr, and follow the Prophetâ€™s ï·º acts of worship.",
        p3:"Do your best, consistently and sincerely â€” to become exemplary Muslims, in shÄâ€™ AllÄh.",
        note:"Slots adapt automatically to your geolocation."
      },
      legend:"Slots via Aladhan (method 4 = Egypt). Current-slot indicator updates every minute.",
      retry:"â†» Request geolocation again", resetDay:"â†º Reset todayâ€™s progress", now:"You are here",
      tasks:[
        { name:"Before Fajr",        action:"QiyÄm & adhkÄr" },
        { name:"Fajr â†’ +30 min",     action:"Fajr + Qurâ€™an & invocations" },
        { name:"Morning",            action:"Work/Study with intention" },
        { name:"Duha",               action:"2â€“4 rakâ€˜Ät" },
        { name:"Dhuhr",              action:"Prayer + short nap" },
        { name:"â€˜Asr â†’ Maghrib",     action:"Work/Knowledge + Exercise" },
        { name:"Maghrib â†’ â€˜Isha",    action:"Family + Qurâ€™an" },
        { name:"â€˜Isha",              action:"Prayer + Reading/Rest" },
        { name:"Night",              action:"Sleep early + QiyÄm" }
      ],
      adh:{slot:"Slot:",reset:"â†º Reset counters",hint:"Counters are saved locally (per day and slot).",
           groups:{all:"All", morning:"Morning", afterPrayer:"After prayers", evening:"Evening", sleep:"Before sleep", home:"Home"}},
      q:{s:"Surah:",j:"Juz:",open:"Open",mark:"âœ… Mark read",reset:"â†º Reset",last:s=>`Last reading: ${s}`, reciter:"Reciter:"},
      qibla:{hint:"On iOS, tap â€œEnable compassâ€.", label:"Kaaba"},
      adhan:{legend:"Set adhan per prayer: Off / Sound / Vibrate. Choose the muezzin too.",
             off:"Off", sound:"Adhan (sound)", vibrate:"Vibrate",
             notifAsk:"ğŸ”” Allow notifications",
             muezzin:"Muezzin:", next:t=>`Next adhan scheduled: ${t}`}
  }
};

/* ====== AdhkÃ¢r datasets (sÃ©lection complÃ¨te et utile) ====== */
const ADH_DB={
  ar:{
    morning:[
      {txt:"Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ£ØµØ¨Ø­ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡ØŒ ÙˆØ§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡... Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø®ÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…...",count:1,ref:"Ù…Ø³Ù„Ù…"},
      {txt:"Ø³ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØºÙØ§Ø±: Ø§Ù„Ù„Ù‡Ù… Ø£Ù†Øª Ø±Ø¨ÙŠ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†ØªØŒ Ø®Ù„Ù‚ØªÙ†ÙŠ ÙˆØ£Ù†Ø§ Ø¹Ø¨Ø¯Ùƒ...",count:1,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"},
      {txt:"Ø§Ù„Ù„Ù‡Ù… Ø¨Ùƒ Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ¨Ùƒ Ø£Ù…Ø³ÙŠÙ†Ø§ ÙˆØ¨Ùƒ Ù†Ø­ÙŠØ§ ÙˆØ¨Ùƒ Ù†Ù…ÙˆØª ÙˆØ¥Ù„ÙŠÙƒ Ø§Ù„Ù†Ø´ÙˆØ±",count:1,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},
      {txt:"Ø­Ø³Ø¨ÙŠ Ø§Ù„Ù„Ù‡ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ù‡Ùˆ Ø¹Ù„ÙŠÙ‡ ØªÙˆÙƒÙ„Øª ÙˆÙ‡Ùˆ Ø±Ø¨ Ø§Ù„Ø¹Ø±Ø´ Ø§Ù„Ø¹Ø¸ÙŠÙ…",count:7,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},
      {txt:"Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡",count:100,ref:"Ù…Ø³Ù„Ù…"},
      {txt:"Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±",count:100,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"}
    ],
    afterPrayer:[
      {txt:"Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡ (Ù£) Ø«Ù…: Ø§Ù„Ù„Ù‡Ù… Ø£Ù†Øª Ø§Ù„Ø³Ù„Ø§Ù… ÙˆÙ…Ù†Ùƒ Ø§Ù„Ø³Ù„Ø§Ù… ØªØ¨Ø§Ø±ÙƒØª ÙŠØ§ Ø°Ø§ Ø§Ù„Ø¬Ù„Ø§Ù„ ÙˆØ§Ù„Ø¥ÙƒØ±Ø§Ù…",count:1,ref:"Ù…Ø³Ù„Ù…"},
      {txt:"Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ 33ØŒ Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ 33ØŒ Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø± 33ØŒ ØªÙ…Ø§Ù… Ø§Ù„Ù…Ø¦Ø©: Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡...",count:1,ref:"Ù…Ø³Ù„Ù…"},
      {txt:"Ø¢ÙŠØ© Ø§Ù„ÙƒØ±Ø³ÙŠ",count:1,ref:"ØµØ­ÙŠØ­"}
    ],
    evening:[
      {txt:"Ø£Ù…Ø³ÙŠÙ†Ø§ ÙˆØ£Ù…Ø³Ù‰ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡... Ø§Ù„Ù„Ù‡Ù… Ù…Ø§ Ø£Ù…Ø³Ù‰ Ø¨ÙŠ Ù…Ù† Ù†Ø¹Ù…Ø© ÙÙ…Ù†Ùƒ ÙˆØ­Ø¯Ùƒ...",count:1,ref:"Ù…Ø³Ù„Ù…"},
      {txt:"Ù‚Ù„ Ù‡Ùˆ Ø§Ù„Ù„Ù‡ Ø£Ø­Ø¯ØŒ Ù‚Ù„ Ø£Ø¹ÙˆØ° Ø¨Ø±Ø¨ Ø§Ù„ÙÙ„Ù‚ØŒ Ù‚Ù„ Ø£Ø¹ÙˆØ° Ø¨Ø±Ø¨ Ø§Ù„Ù†Ø§Ø³ (Ù£ Ù…Ø±Ø§Øª)",count:3,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},
      {txt:"Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡",count:100,ref:"Ù…Ø³Ù„Ù…"}
    ],
    sleep:[
      {txt:"Ø¨Ø§Ø³Ù…Ùƒ Ø§Ù„Ù„Ù‡Ù… Ø£Ù…ÙˆØª ÙˆØ£Ø­ÙŠØ§",count:1,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"},
      {txt:"Ø§Ù„Ù„Ù‡Ù… Ù‚Ù†ÙŠ Ø¹Ø°Ø§Ø¨Ùƒ ÙŠÙˆÙ… ØªØ¨Ø¹Ø« Ø¹Ø¨Ø§Ø¯Ùƒ",count:1,ref:"Ø§Ù„ØªØ±Ù…Ø°ÙŠ"},
      {txt:"Ø¢ÙŠØ© Ø§Ù„ÙƒØ±Ø³ÙŠ",count:1,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"},
      {txt:"Ø¢Ø®Ø± Ø¢ÙŠØªÙŠÙ† Ù…Ù† Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©",count:1,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"}
    ],
    home:[
      {txt:"Ø°ÙƒØ± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¨ÙŠØª: Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ØŒ Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø®ÙŠØ± Ø§Ù„Ù…ÙˆÙ„Ø¬...",count:1,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},
      {txt:"Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø·Ø¹Ø§Ù…: Ø§Ù„Ù„Ù‡Ù… Ø¨Ø§Ø±Ùƒ Ù„Ù†Ø§ ÙÙŠÙ‡ ÙˆØ£Ø·Ø¹Ù…Ù†Ø§ Ø®ÙŠØ±Ø§ Ù…Ù†Ù‡ / Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø§Ù„Ø°ÙŠ Ø£Ø·Ø¹Ù…Ù†Ø§...",count:1,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},
      {txt:"Ù„Ø¨Ø³ Ø§Ù„Ø«ÙˆØ¨: Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø§Ù„Ø°ÙŠ ÙƒØ³Ø§Ù†ÙŠ...",count:1,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},
      {txt:"Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø³ÙØ±: Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ø°ÙŠ Ø³Ø®Ø± Ù„Ù†Ø§ Ù‡Ø°Ø§...",count:1,ref:"Ù…Ø³Ù„Ù…"}
    ]
  },
  fr:{
    morning:[
      {txt:"Nous entrons au matin et la royautÃ© appartient Ã  Allah... Ã” Allah, je Te demande le bien de ce jour...",count:1,ref:"Muslim"},
      {txt:"Sayyid al-IstighfÃ¢r : Ã” Allah, Tu es mon Seigneur, nul dieu sauf Toi...",count:1,ref:"Bukhari"},
      {txt:"Par Ta grÃ¢ce nous entrons au matin...",count:1,ref:"Abu Dawud"},
      {txt:"Â« Hasbiya-llÃ¢h lÃ¢ ilÃ¢ha illÃ¢ Huwa... Â»",count:7,ref:"Abu Dawud"},
      {txt:"SubhÃ¢nAllÃ¢h wa bihamdih",count:100,ref:"Muslim"},
      {txt:"LÃ¢ ilÃ¢ha illÃ¢ AllÃ¢h waá¸¥dahu lÃ¢ sharÃ®ka lah...",count:100,ref:"Bukhari"}
    ],
    afterPrayer:[
      {txt:"IstighfÃ¢r (3) puis : AllÃ¢humma anta as-SalÃ¢m wa minka as-SalÃ¢m...",count:1,ref:"Muslim"},
      {txt:"33 TasbÃ®h, 33 Taá¸¥mÃ®d, 33 TakbÃ®r + complÃ©ment Ã  100",count:1,ref:"Muslim"},
      {txt:"Ã‚yat al-KursÃ®",count:1,ref:"SahÃ®h"}
    ],
    evening:[
      {txt:"Nous entrons au soir et la royautÃ© appartient Ã  Allah...",count:1,ref:"Muslim"},
      {txt:"Al-IkhlÃ¢s, Al-Falaq, An-NÃ¢s (Ã—3)",count:3,ref:"Abu Dawud"},
      {txt:"SubhÃ¢nAllÃ¢h wa bihamdih",count:100,ref:"Muslim"}
    ],
    sleep:[
      {txt:"Bismika AllÃ¢humma amÃ»tu wa aá¸¥yÃ¢",count:1,ref:"Bukhari"},
      {txt:"ProtÃ¨ge-moi de Ton chÃ¢timent le Jour oÃ¹ Tu ressusciteras Tes serviteurs",count:1,ref:"TirmidhÃ®"},
      {txt:"Ã‚yat al-KursÃ®",count:1,ref:"Bukhari"},
      {txt:"Les deux derniÃ¨res versets dâ€™Al-Baqarah",count:1,ref:"Bukhari"}
    ],
    home:[
      {txt:"En entrant Ã  la maison...",count:1,ref:"Abu Dawud"},
      {txt:"Avant/aprÃ¨s le repasâ€¦",count:1,ref:"Abu Dawud"},
      {txt:"Mettre un vÃªtementâ€¦",count:1,ref:"Abu Dawud"},
      {txt:"Invocation du voyageâ€¦",count:1,ref:"Muslim"}
    ]
  },
  en:{
    morning:[
      {txt:"We enter the morning and the dominion is Allahâ€™s... O Allah, I ask You the good of this day...",count:1,ref:"Muslim"},
      {txt:"Sayyid al-Istighfar: O Allah, You are my Lord; none has the right to be worshipped but You...",count:1,ref:"Bukhari"},
      {txt:"By Your grace we enter the morning...",count:1,ref:"Abu Dawud"},
      {txt:"HasbiyallÄh lÄ ilÄha illÄ Huwa...",count:7,ref:"Abu Dawud"},
      {txt:"SubhanAllÄh wa bihamdih",count:100,ref:"Muslim"},
      {txt:"LÄ ilÄha illÄ AllÄh waá¸¥dahu lÄ sharÄ«ka lah...",count:100,ref:"Bukhari"}
    ],
    afterPrayer:[
      {txt:"Istighfar (3) then: AllÄhumma anta as-SalÄm wa minka as-SalÄm...",count:1,ref:"Muslim"},
      {txt:"33 Tasbih, 33 Tahmid, 33 Takbir + completion to 100",count:1,ref:"Muslim"},
      {txt:"Ayat al-Kursi",count:1,ref:"Sahih"}
    ],
    evening:[
      {txt:"We enter the evening and the dominion is Allahâ€™s...",count:1,ref:"Muslim"},
      {txt:"IkhlÄs, Falaq, NÄs (Ã—3)",count:3,ref:"Abu Dawud"},
      {txt:"SubhanAllÄh wa bihamdih",count:100,ref:"Muslim"}
    ],
    sleep:[
      {txt:"Bismika AllÄhumma amÅ«tu wa aá¸¥yÄ",count:1,ref:"Bukhari"},
      {txt:"O Allah, protect me from Your punishment on the Day You resurrect Your servants",count:1,ref:"Tirmidhi"},
      {txt:"Ayat al-Kursi",count:1,ref:"Bukhari"},
      {txt:"Last two verses of Al-Baqarah",count:1,ref:"Bukhari"}
    ],
    home:[
      {txt:"Entering home dhikrâ€¦",count:1,ref:"Abu Dawud"},
      {txt:"Before/after mealâ€¦",count:1,ref:"Abu Dawud"},
      {txt:"Wearing a garmentâ€¦",count:1,ref:"Abu Dawud"},
      {txt:"Travel supplicationâ€¦",count:1,ref:"Muslim"}
    ]
  }
};

/* =================== Utils / Time =================== */
const $=s=>document.querySelector(s);
const todayKey=()=>new Date().toISOString().slice(0,10);
const toMin=s=>{const [h,m]=s.split(":").map(Number);return h*60+m;}
const fromMin=m=>{m=((m%1440)+1440)%1440;const h=Math.floor(m/60),mi=m%60;return `${String(h).padStart(2,"0")}:${String(mi).padStart(2,"0")}`;}
const addMin=(t,mins)=>fromMin(toMin(t)+mins);
const mid=(a,b)=>fromMin(Math.floor((toMin(a)+toMin(b))/2));
function nowIn(start,end){const d=new Date();let c=d.getHours()*60+d.getMinutes();let s=toMin(start),e=toMin(end);if(e<=s)e+=1440;if(c<s)c+=1440;return c>=s&&c<e;}

/* =================== Global state =================== */
let CURR_LANG=localStorage.getItem("pref_lang")||"fr";
let CURRENT_SLOTS=null;
let QIBLA_BRG=null;
let PRAYER_TIMINGS=null;
let ADHAN_TIMER=null;

/* =================== APIs =================== */
// reverse geocode
async function reverseCity(lat, lon, lang){
  try{
    const u=`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=${lang==='ar'?'ar':lang==='fr'?'fr':'en'}`;
    const r=await fetch(u,{cache:"no-store"}); const j=await r.json();
    return {city:j.city||j.locality||j.principalSubdivision||j.countryName||"â€”", country:j.countryName||""};
  }catch{return {city:"â€”", country:""};}
}
// timings with fallback
async function getTimings(lat, lon, cityGuess=null, countryGuess=null){
  const clean=v=>(v||"").split(" ")[0].slice(0,5);
  const tryCoords=async()=>{
    const r=await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=4`,{cache:"no-store"});
    const j=await r.json(); const t=j?.data?.timings; if(!t) throw 0;
    return {Fajr:clean(t.Fajr),Sunrise:clean(t.Sunrise),Dhuhr:clean(t.Dhuhr),Asr:clean(t.Asr),Maghrib:clean(t.Maghrib),Isha:clean(t.Isha)};
  };
  const tryCity=async()=>{
    if(!cityGuess) throw 0;
    const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(cityGuess)}${countryGuess?`&country=${encodeURIComponent(countryGuess)}`:''}&method=4`,{cache:"no-store"});
    const j=await r.json(); const t=j?.data?.timings; if(!t) throw 0;
    return {Fajr:clean(t.Fajr),Sunrise:clean(t.Sunrise),Dhuhr:clean(t.Dhuhr),Asr:clean(t.Asr),Maghrib:clean(t.Maghrib),Isha:clean(t.Isha)};
  };
  try{ return await tryCoords(); } catch{ return await tryCity(); }
}
function buildSlots({Fajr,Sunrise,Dhuhr,Asr,Maghrib,Isha}){
  const fajrEnd=fromMin(Math.min(toMin(addMin(Fajr,60)),toMin(Sunrise)));
  const afterSunrise=addMin(Sunrise,30);
  const midMorning=mid(afterSunrise,Dhuhr);
  const midIshaFajr=mid(Isha,addMin(Fajr,24*60));
  return [
    {start:Fajr,end:fajrEnd},
    {start:fajrEnd,end:afterSunrise},
    {start:afterSunrise,end:midMorning},
    {start:midMorning,end:Dhuhr},
    {start:Dhuhr,end:Asr},
    {start:Asr,end:Maghrib},
    {start:Maghrib,end:Isha},
    {start:Isha,end:midIshaFajr},
    {start:midIshaFajr,end:addMin(Fajr,24*60)}
  ];
}

/* =================== Home =================== */
function renderHome(){
  const L=T[CURR_LANG];
  $("#homeHero").innerHTML=`<h2>${L.home.h1}</h2>
    <p>${L.home.p1}</p>
    <p>${L.home.p2}</p>
    <p>${L.home.ded}</p>
    <p>${L.home.p3}</p>
    <p class="status">ğŸ’¡ ${L.home.note}</p>`;
  $("#goPlan").textContent=L.tabs.plan.replace("ğŸ“‹ ","â¡ï¸ ");
  $("#goAdhkar").textContent=L.tabs.adhkar;
  $("#goQuran").textContent=L.tabs.quran;
  $("#goQibla").textContent=L.tabs.qibla;
  $("#goAdhan").textContent=L.tabs.adhan;
}

/* =================== Planning =================== */
function renderPlan(){
  const L=T[CURR_LANG];
  $("#legend").textContent=L.legend; $("#retry").textContent=L.retry; $("#resetDay").textContent=L.resetDay;
  const tasks=L.tasks; const box=$("#tasks"); box.innerHTML="";
  if(!CURRENT_SLOTS) return;
  CURRENT_SLOTS.forEach((slot,i)=>{
    const key=`done_${todayKey()}_${i}`; const checked=localStorage.getItem(key)==="1"; const active=nowIn(slot.start,slot.end);
    const row=document.createElement("div"); row.className="task"+(active?" now":"");
    row.innerHTML=`<div class="left">
      <input type="checkbox" id="chk-${i}" ${checked?"checked":""}/>
      <span class="time">${tasks[i].name}</span>
      <span id="txt-${i}" class="${checked?"done":""}">${tasks[i].action}</span>
      <span class="badge"><span class="ltr">${slot.start} â€“ ${slot.end}</span></span>
      ${active?`<span class="nowTag">â€¢ ${L.now}</span>`:""}</div>`;
    box.appendChild(row);
    row.querySelector(`#chk-${i}`).addEventListener("change",e=>{
      localStorage.setItem(key,e.target.checked?"1":"0");
      row.querySelector(`#txt-${i}`).classList.toggle("done",e.target.checked);
    });
  });
}

/* =================== AdhkÃ¢r =================== */
function adhKey(slot){return `adh_${todayKey()}_${CURR_LANG}_${slot}`;}
function renderAdhkar(){
  const L=T[CURR_LANG];
  $("#slotLabel").textContent=L.adh.slot; $("#resetAdhkar").textContent=L.adh.reset; $("#adhHint").textContent=L.adh.hint;
  const groups=[{key:"all",name:L.adh.groups.all},{key:"morning",name:L.adh.groups.morning},{key:"afterPrayer",name:L.adh.groups.afterPrayer},{key:"evening",name:L.adh.groups.evening},{key:"sleep",name:L.adh.groups.sleep},{key:"home",name:L.adh.groups.home}];
  const sel=$("#slotSel"); sel.innerHTML=""; groups.forEach(g=>{const o=document.createElement("option");o.value=g.key;o.textContent=g.name;sel.appendChild(o);});
  sel.value=localStorage.getItem("adh_sel_"+CURR_LANG)||"all";

  const draw=(slot,q)=>{
    const db=ADH_DB[CURR_LANG]; const box=$("#adhkarList"); box.innerHTML="";
    const render=(key,title,list)=>{
      if(!list?.length)return;
      const head=document.createElement("div"); head.className="sectionHead";
      head.innerHTML=`<div class="catTitle">${title}</div>
      <div class="sectionActions"><button class="btn primary" id="${key}-all">âœ…</button><button class="btn" id="${key}-reset">${L.adh.reset}</button></div>`;
      box.appendChild(head); const hr=document.createElement("div"); hr.className="divider"; box.appendChild(hr);
      head.querySelector(`#${key}-all`).onclick=()=>{const c=JSON.parse(localStorage.getItem(adhKey(key))||"{}");list.forEach((d,i)=>c[i]=d.count||1);localStorage.setItem(adhKey(key),JSON.stringify(c));draw(sel.value,$("#adhSearch").value.trim());}
      head.querySelector(`#${key}-reset`).onclick=()=>{localStorage.removeItem(adhKey(key));draw(sel.value,$("#adhSearch").value.trim());}
      const counts=JSON.parse(localStorage.getItem(adhKey(key))||"{}");
      list.forEach((d,i)=>{if(q && !d.txt.toLowerCase().includes(q.toLowerCase()))return;
        const need=d.count||1,cur=counts[i]||0;
        const div=document.createElement("div"); div.className="dhk";
        div.innerHTML=`<div><strong>${d.txt}</strong></div>
        <div class="status">${d.ref?`<span class="tag">${d.ref}</span>`:""}<span class="tag">x${need}</span></div>
        <div class="controls"><button class="btn primary" id="${key}-p-${i}">+1</button><button class="btn" id="${key}-m-${i}">-1</button>
        <span class="counter" id="${key}-c-${i}">${cur}/${need}</span><button class="btn" id="${key}-d-${i}">âœ…</button><button class="btn" id="${key}-z-${i}">â†º</button></div>`;
        box.appendChild(div);
        const upd=v=>{const nv=Math.max(0,Math.min(need,v));counts[i]=nv;localStorage.setItem(adhKey(key),JSON.stringify(counts));$(`#${key}-c-${i}`).textContent=`${nv}/${need}`;}
        $(`#${key}-p-${i}`).onclick=()=>upd((counts[i]||0)+1);
        $(`#${key}-m-${i}`).onclick=()=>upd((counts[i]||0)-1);
        $(`#${key}-d-${i}`).onclick=()=>upd(need);
        $(`#${key}-z-${i}`).onclick=()=>upd(0);
      });
    };
    if(slot==="all"){render("morning",L.adh.groups.morning,db.morning);render("afterPrayer",L.adh.groups.afterPrayer,db.afterPrayer);render("evening",L.adh.groups.evening,db.evening);render("sleep",L.adh.groups.sleep,db.sleep);render("home",L.adh.groups.home,db.home);}
    else{const title=groups.find(g=>g.key===slot)?.name||"";render(slot,title,db[slot]);}
  };
  draw(sel.value,$("#adhSearch").value.trim());
  sel.onchange=()=>{localStorage.setItem("adh_sel_"+CURR_LANG,sel.value);draw(sel.value,$("#adhSearch").value.trim());};
  $("#adhSearch").oninput=()=>draw(sel.value,$("#adhSearch").value.trim());
  $("#resetAdhkar").onclick=()=>{["morning","afterPrayer","evening","sleep","home"].forEach(s=>localStorage.removeItem(adhKey(s)));draw(sel.value,$("#adhSearch").value.trim());};
}

/* =================== Quran =================== */
const SURAH_NAMES=[ /* 1..114 clean list (abrÃ©gÃ© ici pour la place) */
"Al-FÄtiá¸¥ah","Al-Baqarah","Ä€l â€˜ImrÄn","An-NisÄâ€™","Al-MÄâ€™idah","Al-Anâ€˜Äm","Al-Aâ€˜rÄf","Al-AnfÄl","At-Tawbah","YÅ«nus","HÅ«d","YÅ«suf","Ar-Raâ€˜d","IbrÄhÄ«m","Al-á¸¤ijr","An-Naá¸¥l","Al-IsrÄâ€™","Al-Kahf","Maryam","á¹¬Ä HÄ","Al-AnbiyÄâ€™","Al-á¸¤ajj","Al-Muâ€™minÅ«n","An-NÅ«r","Al-FurqÄn","Ash-Shuâ€˜arÄâ€™","An-Naml","Al-Qaá¹£aá¹£","Al-â€˜AnkabÅ«t","Ar-RÅ«m","LuqmÄn","As-Sajdah","Al-Aá¸¥zÄb","Sabaâ€™","FÄá¹­ir","YÄ SÄ«n","Aá¹£-á¹¢ÄffÄt","á¹¢Äd","Az-Zumar","GhÄfir","Fuá¹£á¹£ilat","Ash-ShÅ«rÄ","Az-Zukhruf","Ad-DukhÄn","Al-JÄthiyah","Al-Aá¸¥qÄf","Muá¸¥ammad","Al-Fatá¸¥","Al-á¸¤ujurÄt","QÄf","Adh-DhÄriyÄt","Aá¹­-á¹¬Å«r","An-Najm","Al-Qamar","Ar-Raá¸¥mÄn","Al-WÄqiâ€˜ah","Al-á¸¤adÄ«d","Al-MujÄdilah","Al-á¸¤ashr","Al-Mumtaá¸¥anah","Aá¹£-á¹¢aff","Al-Jumuâ€˜ah","Al-MunÄfiqÅ«n","At-TaghÄbun","Aá¹­-á¹¬alÄq","At-Taá¸¥rÄ«m","Al-Mulk","Al-Qalam","Al-á¸¤Äqqah","Al-Maâ€˜Ärij","NÅ«á¸¥","Al-Jinn","Al-Muzzammil","Al-Muddaththir","Al-QiyÄmah","Al-InsÄn","Al-MursalÄt","An-Nabaâ€™","An-NÄziâ€˜Ät","â€˜Abasa","At-TakwÄ«r","Al-Infiá¹­Är","Al-Muá¹­affifÄ«n","Al-InshiqÄq","Al-BurÅ«j","Aá¹­-á¹¬Äriq","Al-Aâ€˜lÄ","Al-GhÄshiyah","Al-Fajr","Al-Balad","Ash-Shams","Al-Layl","Aá¸-á¸Œuá¸¥Ä","Ash-Shará¸¥","At-TÄ«n","Al-â€˜Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-â€˜Ä€diyÄt","Al-QÄriâ€˜ah","At-TakÄthur","Al-â€˜Aá¹£r","Al-Humazah","Al-FÄ«l","Quraysh","Al-MÄâ€˜Å«n","Al-Kawthar","Al-KÄfirÅ«n","An-Naá¹£r","Al-Masad","Al-IkhlÄá¹£","Al-Falaq","An-NÄs"];
// Reciters (stable mp3quran mirrors)
const RECITERS=[
  {id:"afs",  name:"Mishary Al-Afasy", base:"https://server8.mp3quran.net/afs/"},   // 001.mp3 ...
  {id:"hus",  name:"Al-Husary (Murattal)", base:"https://server8.mp3quran.net/husr/"},
  {id:"minsh",name:"Minshawi (Murattal)",  base:"https://server8.mp3quran.net/minsh/"},
  {id:"sds",  name:"Saad Al-Ghamdi",      base:"https://server8.mp3quran.net/sds/"}
];

function qKey(){return `qread_${todayKey()}_${CURR_LANG}`;}
function renderQuran(){
  const L=T[CURR_LANG];
  $("#qLabel1").textContent=L.q.s; $("#qLabel2").textContent=L.q.j;
  $("#openSurah").textContent=L.q.open; $("#markRead").textContent=L.q.mark; $("#resetRead").textContent=L.q.reset;
  $("#reciterLabel").textContent=L.q.reciter;

  const sSel=$("#surahSel"); sSel.innerHTML=""; SURAH_NAMES.forEach((n,i)=>{const o=document.createElement("option");o.value=String(i+1).padStart(3,"0");o.textContent=`${i+1}. ${n}`;sSel.appendChild(o);});
  const jSel=$("#juzSel"); jSel.innerHTML=""; for(let j=1;j<=30;j++){const o=document.createElement("option");o.value=String(j);o.textContent=`Juz ${j}`;jSel.appendChild(o);}
  const rSel=$("#reciterSel"); rSel.innerHTML=""; RECITERS.forEach(r=>{const o=document.createElement("option");o.value=r.id;o.textContent=r.name;rSel.appendChild(o);});

  const saved=localStorage.getItem(qKey()); $("#readStatus").textContent=saved?L.q.last(saved):"";
  $("#openSurah").onclick=()=>{
    const surahNum=parseInt(sSel.value,10);
    const url=`https://quran.com/${surahNum}?reading=false&locale=${CURR_LANG==='ar'?'ar':(CURR_LANG==='fr'?'fr':'en')}`;
    $("#qFrame").src=url;
  };
  $("#playAudio").onclick=()=>{
    const rec=RECITERS.find(r=>r.id===$("#reciterSel").value);
    const mp3=`${rec.base}${sSel.value}.mp3`;
    const a=$("#qAudio"); a.src=mp3; a.play().catch(()=>{});
  };
  $("#markRead").onclick=()=>{
    const label=`Surah ${parseInt(sSel.value,10)} / Juz ${jSel.value} â€“ ${$("#reciterSel").selectedOptions[0].text}`;
    localStorage.setItem(qKey(),label); $("#readStatus").textContent=L.q.last(label);
  };
  $("#resetRead").onclick=()=>{localStorage.removeItem(qKey());$("#readStatus").textContent="";};
}

/* =================== Qibla 3D =================== */
function computeQiblaBearing(lat,lon){const Ï†1=lat*Math.PI/180, Ï†2=21.4225*Math.PI/180;const Î”Î»=(39.8262-lon)*Math.PI/180;const y=Math.sin(Î”Î»)*Math.cos(Ï†2);const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);let Î¸=Math.atan2(y,x)*180/Math.PI;return (Î¸+360)%360;}
function startCompass(){const btn=$("#enableCompass");btn.onclick=async()=>{const need=typeof DeviceOrientationEvent!=="undefined"&&typeof DeviceOrientationEvent.requestPermission==="function";if(need){try{const r=await DeviceOrientationEvent.requestPermission();if(r!=="granted")return;}catch{return;}}window.addEventListener('deviceorientation', onOrient,true);};}
function onOrient(e){let heading;if(e.webkitCompassHeading!==undefined) heading=e.webkitCompassHeading; else if(e.absolute&&e.alpha!=null) heading=360-e.alpha; else return; const beta=e.beta??0,gamma=e.gamma??0; $("#needle3d").style.transform=`translate(-50%,-100%) rotateZ(${heading}deg)`; if(QIBLA_BRG!=null){const diff=((QIBLA_BRG-heading+540)%360)-180; $("#qArrow").style.transform=`translate(-50%,-100%) rotateZ(${diff}deg)`; $("#qiblaInfo").textContent=`Qibla : ${Math.round(QIBLA_BRG)}Â° â€¢ Cap : ${Math.round(heading)}Â°`; } const clamp=(v,min,max)=>Math.max(min,Math.min(max,v)); $("#q3dScene").style.transform=`rotateX(${-clamp(beta,-30,30)}deg) rotateY(${clamp(gamma,-30,30)}deg)`;}

/* =================== HORAIRES & ADHAN =================== */
const PRAYERS_ORDER=["Fajr","Dhuhr","Asr","Maghrib","Isha"];
const MUEZZINS=[
  {id:"azan1",name:"Madinah style",url:"https://cdn.islamic.network/audio/adhan/mp3/azan1.mp3"},
  {id:"azan2",name:"Makkah style", url:"https://cdn.islamic.network/audio/adhan/mp3/azan2.mp3"},
  {id:"azan3",name:"Misri",        url:"https://cdn.islamic.network/audio/adhan/mp3/azan3.mp3"},
  {id:"azan4",name:"Maghribi",     url:"https://cdn.islamic.network/audio/adhan/mp3/azan4.mp3"},
  {id:"azan5",name:"Short",        url:"https://cdn.islamic.network/audio/adhan/mp3/azan5.mp3"}
];
function adhanSettingKey(p){return `adhan_setting_${p}`;} // 'off' | 'sound' | 'vibrate'
function getAdhanSetting(p){return localStorage.getItem(adhanSettingKey(p))||"off";}
function setAdhanSetting(p,val){localStorage.setItem(adhanSettingKey(p),val);scheduleNextAdhan();}
function muezzinKey(p){return `adhan_muezzin_${p}`;}
function getMuezzin(p){return localStorage.getItem(muezzinKey(p))||MUEZZINS[0].id;}
function setMuezzin(p,id){localStorage.setItem(muezzinKey(p),id);}

async function ensureNotifPermission(){
  if(!('Notification' in window)) return false;
  if(Notification.permission==="granted") return true;
  if(Notification.permission==="denied") return false;
  const res=await Notification.requestPermission(); return res==="granted";
}
function renderAdhanPage(){
  const L=T[CURR_LANG];
  $("#legendAdhan").textContent=L.adhan.legend;
  $("#reqNotify").textContent=L.adhan.notifAsk;
  const rows=$("#adhanRows"); rows.innerHTML="";
  if(!PRAYER_TIMINGS){ rows.innerHTML=`<tr class="adhan-row"><td colspan="5" style="padding:14px">â€”</td></tr>`; return; }

  PRAYERS_ORDER.forEach(p=>{
    const time=PRAYER_TIMINGS[p]; const set=getAdhanSetting(p); const mz=getMuezzin(p);
    const tr=document.createElement("tr"); tr.className="adhan-row";
    tr.innerHTML=`<td><strong>${p}</strong></td>
      <td><span class="pill-small ltr">${time}</span></td>
      <td>
        <select id="sel-${p}" class="sel">
          <option value="off">${L.adhan.off}</option>
          <option value="sound">${L.adhan.sound}</option>
          <option value="vibrate">${L.adhan.vibrate}</option>
        </select>
      </td>
      <td>
        <select id="mue-${p}" class="sel">
          ${MUEZZINS.map(m=>`<option value="${m.id}">${m.name}</option>`).join("")}
        </select>
      </td>
      <td><button class="btn" id="test-${p}">Test</button></td>`;
    rows.appendChild(tr);
    $(`#sel-${p}`).value=set;
    $(`#mue-${p}`).value=mz;
    $(`#sel-${p}`).addEventListener("change",(e)=>setAdhanSetting(p,e.target.value));
    $(`#mue-${p}`).addEventListener("change",(e)=>setMuezzin(p,e.target.value));
    $(`#test-${p}`).onclick=()=>triggerAdhan(p,true);
    // si OFF, griser le muezzin
    const toggle=()=>{$(`#mue-${p}`).disabled=getAdhanSetting(p)!=="sound";$(`#mue-${p}`).classList.toggle("mute",$(`#mue-${p}`).disabled);};
    toggle(); $(`#sel-${p}`).addEventListener("change",toggle);
  });
}
function nextAdhanInfo(){
  if(!PRAYER_TIMINGS) return null;
  const now=new Date(); const nowM=now.getHours()*60+now.getMinutes();
  let bestDiff=1e9, label=null, at=null;
  for(const p of PRAYERS_ORDER){
    if(getAdhanSetting(p)==="off") continue;
    const [h,m]=PRAYER_TIMINGS[p].split(":").map(Number);
    let mins=h*60+m, diff=mins-nowM; if(diff<=0) diff+=1440;
    if(diff<bestDiff){bestDiff=diff;label=p;at=new Date(now.getTime()+diff*60000);}
  }
  if(!label) return null;
  return {label, when:at};
}
function clearAdhanTimer(){ if(ADHAN_TIMER){ clearTimeout(ADHAN_TIMER); ADHAN_TIMER=null; } }
function scheduleNextAdhan(){
  clearAdhanTimer();
  const info=nextAdhanInfo();
  if(!info){ $("#nextAdhanMsg").textContent=""; return; }
  $("#nextAdhanMsg").textContent=T[CURR_LANG].adhan.next(info.when.toLocaleTimeString());
  const delay=Math.max(0, info.when.getTime()-Date.now());
  ADHAN_TIMER=setTimeout(async()=>{ await triggerAdhan(info.label,false); scheduleNextAdhan(); }, delay);
}
function triggerAdhan(prayer, isTest=false){
  const setting=getAdhanSetting(prayer);
  if(setting==="off") return;
  if(Notification.permission==="granted"){
    new Notification(isTest?`Test AdhÃ¢n â€“ ${prayer}`:`AdhÃ¢n â€“ ${prayer}`, {body:isTest?"Essai de notification":`Câ€™est lâ€™heure de ${prayer}`});
  }
  if(setting==="vibrate" && navigator.vibrate){ navigator.vibrate([200,100,200,100,300]); }
  if(setting==="sound"){
    const mzId=getMuezzin(prayer);
    const src=(MUEZZINS.find(m=>m.id===mzId)||MUEZZINS[0]).url;
    const a=$("#adhanAudio"); a.src=src; a.currentTime=0; a.play().catch(()=>{});
  }
}

/* =================== Language & Tabs =================== */
function applyLanguage(){
  const L=T[CURR_LANG];
  document.documentElement.lang=CURR_LANG;
  document.documentElement.dir=(CURR_LANG==="ar")?"rtl":"ltr";
  $("#title").textContent=L.title; $("#langLabel").textContent=L.lang; $("#cityLabel").textContent=L.city;
  $("#status").textContent=L.statusGeo;
  $("#tab-home").textContent=L.tabs.home; $("#tab-plan").textContent=L.tabs.plan; $("#tab-adhkar").textContent=L.tabs.adhkar; $("#tab-quran").textContent=L.tabs.quran; $("#tab-qibla").textContent=L.tabs.qibla; $("#tab-adhan").textContent=L.tabs.adhan;
  $("#qiblaHint").textContent=L.qibla.hint; $("#qLabel").textContent=L.qibla.label;
  renderHome(); renderPlan(); renderAdhkar(); renderQuran(); renderAdhanPage();
}
function showPage(key){
  ["home","plan","adhkar","quran","qibla","adhan"].forEach(k=>{$(`#page-${k}`).style.display="none"; $(`#tab-${k}`).classList.remove("active");});
  $(`#page-${key}`).style.display="block"; $(`#tab-${key}`).classList.add("active");
  localStorage.setItem("last_page",key);
}

/* =================== Geolocation bootstrap (demande systÃ©matique) =================== */
async function locateAndBuild(){
  const L=T[CURR_LANG]; $("#status").textContent=L.statusGeo;
  if(!("geolocation" in navigator)){ $("#status").textContent="âŒ "+(L.geoNo||"GÃ©olocalisation non supportÃ©e"); return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude,longitude}=pos.coords;
    $("#status").textContent="ğŸ“ â€¦";
    try{
      const place=await reverseCity(latitude,longitude,CURR_LANG);
      const timings=await getTimings(latitude,longitude,place.city,place.country);
      $("#cityName").textContent=place.city;
      PRAYER_TIMINGS=timings; CURRENT_SLOTS=buildSlots(timings);
      QIBLA_BRG=computeQiblaBearing(latitude,longitude);
      $("#qiblaInfo").textContent=`Qibla : ${Math.round(QIBLA_BRG)}Â° â€¢ Cap : â€”Â°`;
      renderPlan(); renderAdhanPage(); scheduleNextAdhan();
      $("#status").textContent="âœ… OK";
      setInterval(renderPlan,60*1000);
    }catch(e){ console.error(e); $("#status").textContent="âš ï¸ Erreur de chargement des horaires"; }
  }, err=>{ console.warn(err); $("#status").textContent="âš ï¸ AccÃ¨s localisation refusÃ©"; $("#cityName").textContent="â€”"; }, {enableHighAccuracy:true, timeout:15000});
}

/* =================== Boot =================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  $("#lang").value=CURR_LANG;
  applyLanguage();
  showPage(localStorage.getItem("last_page")||"home");

  // gÃ©oloc demandÃ©e immÃ©diatement
  locateAndBuild();

  $("#lang").addEventListener("change", ()=>{ CURR_LANG=$("#lang").value; localStorage.setItem("pref_lang",CURR_LANG); applyLanguage(); locateAndBuild(); });

  $("#tab-home").onclick=()=>showPage("home");
  $("#tab-plan").onclick=()=>showPage("plan");
  $("#tab-adhkar").onclick=()=>showPage("adhkar");
  $("#tab-quran").onclick=()=>showPage("quran");
  $("#tab-qibla").onclick=()=>showPage("qibla");
  $("#tab-adhan").onclick=()=>showPage("adhan");

  $("#goPlan").onclick=()=>showPage("plan");
  $("#goAdhkar").onclick=()=>showPage("adhkar");
  $("#goQuran").onclick=()=>showPage("quran");
  $("#goQibla").onclick=()=>showPage("qibla");
  $("#goAdhan").onclick=()=>showPage("adhan");

  $("#retry").onclick=locateAndBuild;
  $("#resetDay").onclick=()=>{for(let i=0;i<9;i++) localStorage.removeItem(`done_${todayKey()}_${i}`); renderPlan();};

  $("#reqNotify").onclick=ensureNotifPermission;
  $("#resync").onclick=scheduleNextAdhan;

  startCompass();
});
</script>
</body>
</html>
