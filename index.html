<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Accueil â€¢ Planning â€¢ AdhkÃ¢r â€¢ Coran (gÃ©olocalisation)</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --text:#0f1a2b; --muted:#6b7280;
    --brand:#1e88e5; --now:#10b981; --shadow:0 1px 4px rgba(0,0,0,.12);
    --accent:#0ea5e9;
  }
  html,body{height:100%}
  body{
    margin:16px; background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
  }
  .wrap{max-width:1000px;margin:0 auto}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#eef6ff;border:1px solid #cfe0ff;color:#0f2a4a;border-radius:999px;padding:6px 12px}
  .status{color:var(--muted);font-size:14px;margin:6px 0}

  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid #cfd8e3;background:#fff;cursor:pointer}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

  .card{background:var(--card);box-shadow:var(--shadow);border-radius:12px;padding:12px;margin:12px 0}
  .legend{font-size:13px;color:var(--muted);margin-bottom:6px}

  /* Home */
  .hero{display:flex;flex-direction:column;gap:8px}
  .cta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{border:1px solid #cfd8e3;background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border:none}

  /* Planning */
  .task{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid #e7edf6;border-radius:10px;padding:10px;margin:8px 0}
  .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .time{font-weight:600}
  .badge{font-size:12px;background:#e8f1ff;border:1px solid #cfe0ff;border-radius:999px;padding:2px 8px}
  .ltr{direction:ltr; unicode-bidi:embed}
  .now{border-color:var(--now); box-shadow:0 0 0 2px rgba(16,185,129,.16)}
  .now .badge{background:#e9fff7; border-color:#b9f1df}
  .nowTag{font-size:12px;color:#0f8a6a;margin-left:6px}
  .done{text-decoration:line-through;color:#808a98}
  input[type="checkbox"]{width:20px;height:20px;accent-color:var(--brand)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:8px 0}

  /* AdhkÃ¢r */
  .adh-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .sectionHead{display:flex;align-items:center;justify-content:space-between;margin:10px 0 6px 0}
  .catTitle{font-weight:600}
  .sectionActions{display:flex;gap:6px}
  .dhk{border:1px solid #e6ebf2;border-radius:10px;padding:10px;margin:8px 0}
  .dhk .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .counter{min-width:46px;text-align:center;border-radius:8px;border:1px solid #cfd8e3;padding:4px 8px}
  .tag{display:inline-block;font-size:12px;background:#fafafa;border:1px solid #e8e8e8;border-radius:999px;padding:2px 8px;margin-inline-start:6px}
  .divider{height:1px;background:#e9eef5;margin:8px 0}

  /* Quran */
  .qrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  select,button,input[type="text"]{border:1px solid #cfd8e3;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
  iframe{width:100%;height:70vh;border:none;border-radius:12px;box-shadow:var(--shadow)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="title">ğŸ  Accueil â€¢ ğŸ•°ï¸ Planning â€¢ ğŸ•¯ï¸ AdhkÃ¢r â€¢ ğŸ“– Coran</h1>
    <div class="right">
      <label for="lang" id="langLabel">Langue :</label>
      <select id="lang">
        <option value="fr">FranÃ§ais</option>
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="en">English</option>
      </select>
      <div class="pill" title="Ville dÃ©tectÃ©e automatiquement">ğŸ™ï¸ <span id="cityLabel">Ville :</span> <strong id="cityName">â€”</strong></div>
    </div>
  </header>

  <div class="status" id="status">â³ Demande de gÃ©olocalisationâ€¦</div>

  <div class="tabs">
    <button class="tab active" id="tab-home">ğŸ  Accueil</button>
    <button class="tab" id="tab-plan">ğŸ“‹ Planning</button>
    <button class="tab" id="tab-adhkar">ğŸ•¯ï¸ AdhkÃ¢r</button>
    <button class="tab" id="tab-quran">ğŸ“– Coran</button>
  </div>

  <!-- HOME -->
  <section class="card" id="page-home">
    <div class="hero" id="homeHero">
      <!-- contenu injectÃ© selon la langue -->
    </div>
    <div class="cta">
      <button class="btn primary" id="goPlan">â¡ï¸ Aller au Planning</button>
      <button class="btn" id="goAdhkar">ğŸ•¯ï¸ Ouvrir AdhkÃ¢r</button>
      <button class="btn" id="goQuran">ğŸ“– Ouvrir Coran</button>
    </div>
  </section>

  <!-- PLANNING -->
  <section class="card" id="page-plan" style="display:none">
    <div class="legend" id="legend">
      CrÃ©neaux calculÃ©s depuis Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha (Aladhan, mÃ©thode 4 = Egypt). Mise Ã  jour de lâ€™indicateur Â« en cours Â» chaque minute.
    </div>
    <div class="toolbar">
      <button id="retry" class="btn">â†» Re-demander la gÃ©olocalisation</button>
      <button id="resetDay" class="btn">â†º RÃ©initialiser la progression du jour</button>
    </div>
    <div id="tasks"></div>
  </section>

  <!-- ADHKAR -->
  <section class="card" id="page-adhkar" style="display:none">
    <div class="adh-toolbar">
      <label for="slotSel" id="slotLabel">CrÃ©neau :</label>
      <select id="slotSel"></select>
      <input type="text" id="adhSearch" placeholder="Rechercheâ€¦" />
      <button id="resetAdhkar" class="btn primary">â†º RÃ©initialiser les compteurs</button>
    </div>
    <div id="adhkarList"></div>
    <p class="status" id="adhHint">Les compteurs sont sauvegardÃ©s localement, par jour et par crÃ©neau.</p>
  </section>

  <!-- QURAN -->
  <section class="card" id="page-quran" style="display:none">
    <div class="qrow">
      <label id="qLabel1">Sourate :</label>
      <select id="surahSel"></select>
      <label id="qLabel2">Juz :</label>
      <select id="juzSel"></select>
      <button id="openSurah" class="btn primary">Ouvrir</button>
      <button id="markRead" class="btn">âœ… Marquer lu</button>
      <button id="resetRead" class="btn">â†º RÃ©initialiser</button>
    </div>
    <div class="status" id="readStatus"></div>
    <iframe id="qFrame" title="Quran"></iframe>
    <p class="status" id="qHint">Lecteur intÃ©grÃ© depuis quran.com (peut demander lâ€™autorisation dâ€™intÃ©gration).</p>
  </section>
</div>

<script>
/* =================== I18N (inclut la page Accueil) =================== */
const T = {
  fr:{
    title:"ğŸ  Accueil â€¢ ğŸ•°ï¸ Planning â€¢ ğŸ•¯ï¸ AdhkÃ¢r â€¢ ğŸ“– Coran",
    lang:"Langue :", city:"Ville :", statusGeo:"â³ Demande de gÃ©olocalisationâ€¦",
    tabs:{home:"ğŸ  Accueil", plan:"ğŸ“‹ Planning", adhkar:"ğŸ•¯ï¸ AdhkÃ¢r", quran:"ğŸ“– Coran"},
    home:{
      h1:"Bienvenue !",
      p1:"Je mâ€™appelle <strong>Slimane Rahmoune</strong>. Je vous partage ici des crÃ©neaux dâ€™adorations inspirÃ©s de la sunnah du ProphÃ¨te ï·º.",
      p2:"Vous pouvez aussi lire le Coran, rÃ©citer les adhkÃ¢r, et suivre votre progression grÃ¢ce Ã  une checklist simple.",
      p3:"Faites de votre mieux, rÃ©guliÃ¨rement, avec sincÃ©ritÃ© â€” pour devenir, inchÃ¢â€™Allah, des musulman(e)s exemplaires.",
      note:"Les crÃ©neaux sâ€™adaptent automatiquement Ã  votre gÃ©olocalisation."
    },
    legend:"CrÃ©neaux calculÃ©s depuis Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha (Aladhan, mÃ©thode 4 = Egypt). Mise Ã  jour de lâ€™indicateur Â« en cours Â» chaque minute.",
    retry:"â†» Re-demander la gÃ©olocalisation", resetDay:"â†º RÃ©initialiser la progression du jour",
    now:"CrÃ©neau en cours",
    tasks:[
      {name:"Avant Fajr", action:"QiyÃ¢m & adhkÃ¢r"},
      {name:"Fajr â†’ +30 min aprÃ¨s lever", action:"Fajr + Coran & invocations"},
      {name:"Matin (aprÃ¨s lever+30)", action:"Travail/Ã‰tudes avec intention"},
      {name:"Duha", action:"2â€“4 unitÃ©s de priÃ¨re"},
      {name:"Dhuhr", action:"PriÃ¨re + sieste courte"},
      {name:"â€˜Asr â†’ Maghrib", action:"Travail/Savoir + Sport"},
      {name:"Maghrib â†’ â€˜Isha", action:"Famille + Coran"},
      {name:"â€˜Isha", action:"PriÃ¨re + Lecture/Repos"},
      {name:"Nuit", action:"Dormir tÃ´t + QiyÃ¢m"}
    ],
    adh:{slot:"CrÃ©neau :", reset:"â†º RÃ©initialiser les compteurs", hint:"Les compteurs sont sauvegardÃ©s localement, par jour et par crÃ©neau.",
         groups:{all:"Tous", morning:"Matin", afterPrayer:"AprÃ¨s les priÃ¨res", evening:"Soir", sleep:"Avant de dormir", home:"Maison"}},
    q:{s:"Sourate :", j:"Juz :", open:"Ouvrir", mark:"âœ… Marquer lu", reset:"â†º RÃ©initialiser", last:(s)=>`DerniÃ¨re lecture : ${s}`},
    geoOk:"âœ… CrÃ©neaux mis Ã  jour selon ta localisation.",
    geoDenied:"âš ï¸ AccÃ¨s Ã  la gÃ©olocalisation refusÃ©. Autorise la localisation puis clique Â« Re-demander la gÃ©olocalisation Â».",
    geoNo:"âŒ GÃ©olocalisation non supportÃ©e par ce navigateur.",
    loadErr:"âš ï¸ Erreur lors de la rÃ©cupÃ©ration des horaires. VÃ©rifie ta connexion et rÃ©essaie."
  },
  ar:{
    title:"ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€¢ ğŸ•°ï¸ Ø§Ù„ØªØ®Ø·ÙŠØ· â€¢ ğŸ•¯ï¸ Ø§Ù„Ø£Ø°ÙƒØ§Ø± â€¢ ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù†",
    lang:"Ø§Ù„Ù„ØºØ©:", city:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:", statusGeo:"â³ Ø¬Ø§Ø±Ù Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦",
    tabs:{home:"ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", plan:"ğŸ“‹ Ø§Ù„ØªØ®Ø·ÙŠØ·", adhkar:"ğŸ•¯ï¸ Ø§Ù„Ø£Ø°ÙƒØ§Ø±", quran:"ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù†"},
    home:{
      h1:"Ù…Ø±Ø­Ø¨Ù‹Ø§!",
      p1:"Ø£Ù†Ø§ <strong>Ø³Ù„ÙŠÙ…Ø§Ù† Ø±Ø­Ù…ÙˆÙ†</strong>ØŒ Ø£Ø´Ø§Ø±ÙƒÙƒÙ… Ù‡Ù†Ø§ ÙØªØ±Ø§ØªÙ Ù„Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ù†Ø© Ù„Ù„Ù†Ø¨ÙŠ ï·º.",
      p2:"ÙŠÙ…ÙƒÙ†ÙƒÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†ØŒ ÙˆØ°ÙƒØ± Ø§Ù„Ø£Ø°ÙƒØ§Ø±ØŒ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø¹Ø¨Ø± Ù‚Ø§Ø¦Ù…Ø© ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·Ø©.",
      p3:"Ø§Ø¨Ø°Ù„ÙˆØ§ Ø¬Ù‡Ø¯ÙƒÙ… Ø¨Ø§Ù†ØªØ¸Ø§Ù… ÙˆØ¥Ø®Ù„Ø§Øµ â€” Ù„ØªÙƒÙˆÙ†ÙˆØ§ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡ Ù…Ø³Ù„Ù…ÙŠÙ† ÙˆÙ…Ø³Ù„Ù…Ø§Øª Ù‚Ø¯ÙˆØ©.",
      note:"ØªØªÙƒÙŠÙ‘Ù Ø§Ù„ÙØªØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹ÙƒÙ… Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ."
    },
    legend:"ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØªØ±Ø§Øª Ù…Ù† Ø§Ù„ÙØ¬Ø±ØŒ Ø§Ù„Ø´Ø±ÙˆÙ‚ØŒ Ø§Ù„Ø¸Ù‡Ø±ØŒ Ø§Ù„Ø¹ØµØ±ØŒ Ø§Ù„Ù…ØºØ±Ø¨ØŒ Ø§Ù„Ø¹Ø´Ø§Ø¡ (AladhanØŒ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 4=Ù…ØµØ±). ÙŠÙØ­Ø¯Ù‘ÙØ« Ù…Ø¤Ø´Ø± Â«Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù‡Ù†Ø§Â» ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©.",
    retry:"â†» Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹", resetDay:"â†º ØªØµÙÙŠØ± Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…",
    now:"Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù‡Ù†Ø§",
    tasks:[
      {name:"Ù‚Ø¨Ù„ Ø§Ù„ÙØ¬Ø±", action:"Ù‚ÙŠØ§Ù… Ø§Ù„Ù„ÙŠÙ„ ÙˆØ°ÙƒØ± Ø§Ù„Ù„Ù‡"},
      {name:"Ø§Ù„ÙØ¬Ø± â†’ +30 Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±ÙˆÙ‚", action:"ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø± + Ù‚Ø±Ø¢Ù† ÙˆØ£Ø°ÙƒØ§Ø±"},
      {name:"Ø§Ù„ØµØ¨Ø§Ø­", action:"Ø¹Ù…Ù„/Ø¯Ø±Ø§Ø³Ø© Ø¨Ù†ÙŠØ© Ù„Ù„Ù‡"},
      {name:"Ø§Ù„Ø¶Ø­Ù‰", action:"Ø±ÙƒØ¹ØªØ§Ù† Ø¥Ù„Ù‰ Ø£Ø±Ø¨Ø¹"},
      {name:"Ø§Ù„Ø¸Ù‡Ø±", action:"ØµÙ„Ø§Ø© + Ù‚ÙŠÙ„ÙˆÙ„Ø©"},
      {name:"Ø§Ù„Ø¹ØµØ± â†’ Ø§Ù„Ù…ØºØ±Ø¨", action:"Ø¹Ù…Ù„/Ø¹Ù„Ù… + Ø±ÙŠØ§Ø¶Ø©"},
      {name:"Ø§Ù„Ù…ØºØ±Ø¨ â†’ Ø§Ù„Ø¹Ø´Ø§Ø¡", action:"Ø¬Ù„Ø³Ø© Ø¹Ø§Ø¦Ù„ÙŠØ© + Ù‚Ø±Ø¢Ù†"},
      {name:"Ø§Ù„Ø¹Ø´Ø§Ø¡", action:"ØµÙ„Ø§Ø© + Ù‚Ø±Ø§Ø¡Ø©/Ø±Ø§Ø­Ø©"},
      {name:"Ø§Ù„Ù„ÙŠÙ„", action:"Ù†ÙˆÙ… Ù…Ø¨ÙƒØ± + Ù‚ÙŠØ§Ù…"}
    ],
    adh:{slot:"Ø§Ù„ÙØªØ±Ø©:", reset:"â†º ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª", hint:"ÙŠÙØ­ÙØ¸ Ø§Ù„Ø¹Ø¯Ù‘ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„ÙƒÙ„ ÙØªØ±Ø© ÙˆÙŠÙˆÙ….",
         groups:{all:"Ø§Ù„ÙƒÙ„", morning:"Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­", afterPrayer:"Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„ÙˆØ§Øª", evening:"Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡", sleep:"Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…", home:"Ø§Ù„Ø¨ÙŠØª"}},
    q:{s:"Ø³ÙˆØ±Ø©:", j:"Ø¬Ø²Ø¡:", open:"ÙØªØ­", mark:"âœ… ØªÙ…Ù‘Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©", reset:"â†º ØªØµÙÙŠØ±", last:(s)=>`Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ÙÙˆØ¸Ø©: ${s}`},
    geoOk:"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØªØ±Ø§Øª Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ.",
    geoDenied:"âš ï¸ Ø±ÙÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø§Ø³Ù…Ø­ Ø¨Ù‡ Ø«Ù… Ø§Ø¶ØºØ· Â«Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹Â».",
    geoNo:"âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.",
    loadErr:"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."
  },
  en:{
    title:"ğŸ  Home â€¢ ğŸ•°ï¸ Plan â€¢ ğŸ•¯ï¸ Adhkar â€¢ ğŸ“– Quran",
    lang:"Language:", city:"City:", statusGeo:"â³ Requesting geolocationâ€¦",
    tabs:{home:"ğŸ  Home", plan:"ğŸ“‹ Plan", adhkar:"ğŸ•¯ï¸ Adhkar", quran:"ğŸ“– Quran"},
    home:{
      h1:"Welcome!",
      p1:"Iâ€™m <strong>Slimane Rahmoune</strong>. Iâ€™m sharing worship time slots inspired by the Prophetic ï·º way.",
      p2:"You can also read the Qurâ€™an, recite adhkÃ¢r, and track progress with a simple checklist.",
      p3:"Do your best, consistently and sincerely â€” to become exemplary Muslim(s), in shÃ¢â€™ AllÃ¢h.",
      note:"Slots adapt automatically to your geolocation."
    },
    legend:"Slots built from Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha (Aladhan, method 4 = Egypt). Current-slot indicator updates every minute.",
    retry:"â†» Request geolocation again", resetDay:"â†º Reset todayâ€™s progress",
    now:"You are here",
    tasks:[
      {name:"Before Fajr", action:"Qiyam & remembrances"},
      {name:"Fajr â†’ +30 after sunrise", action:"Fajr + Qurâ€™an & adhkar"},
      {name:"Morning", action:"Work/Study with sincere intention"},
      {name:"Duha", action:"2â€“4 units of prayer"},
      {name:"Dhuhr", action:"Prayer + short nap"},
      {name:"Asr â†’ Maghrib", action:"Work/Knowledge + Exercise"},
      {name:"Maghrib â†’ Isha", action:"Family time + Qurâ€™an"},
      {name:"Isha", action:"Prayer + Reading/Rest"},
      {name:"Night", action:"Sleep early + Qiyam"}
    ],
    adh:{slot:"Slot:", reset:"â†º Reset counters", hint:"Counters saved locally per slot/day.",
         groups:{all:"All", morning:"Morning", afterPrayer:"After prayers", evening:"Evening", sleep:"Before sleep", home:"Home"}},
    q:{s:"Surah:", j:"Juz:", open:"Open", mark:"âœ… Mark read", reset:"â†º Reset", last:(s)=>`Last reading: ${s}`},
    geoOk:"âœ… Slots updated based on your location.",
    geoDenied:"âš ï¸ Geolocation denied. Allow it, then click â€œRequest geolocation againâ€.",
    geoNo:"âŒ Geolocation not supported by this browser.",
    loadErr:"âš ï¸ Error fetching timings. Check your connection and retry."
  }
};

/* ====== Adhkar datasets ====== */
const ADH_DB={
  ar:{morning:[{txt:"Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ£ØµØ¨Ø­ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡â€¦",count:1,ref:"Ù…Ø³Ù„Ù…"},{txt:"Ø³ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØºÙØ§Ø±â€¦",count:1,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"},{txt:"Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡",count:100,ref:"Ù…Ø³Ù„Ù…"},{txt:"Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡â€¦",count:100,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"}],
      afterPrayer:[{txt:"Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡ (Ù£) Ø«Ù…: Ø§Ù„Ù„Ù‡Ù… Ø£Ù†Øª Ø§Ù„Ø³Ù„Ø§Ù…â€¦",count:1,ref:"Ù…Ø³Ù„Ù…"},{txt:"33 ØªØ³Ø¨ÙŠØ­ Ùˆ33 ØªØ­Ù…ÙŠØ¯ Ùˆ33 ØªÙƒØ¨ÙŠØ± + ØªÙ…Ø§Ù… Ø§Ù„Ù…Ø¦Ø©",count:1,ref:"Ù…Ø³Ù„Ù…"},{txt:"Ø¢ÙŠØ© Ø§Ù„ÙƒØ±Ø³ÙŠ",count:1,ref:"Ø­Ø³Ù†"}],
      evening:[{txt:"Ø£Ù…Ø³ÙŠÙ†Ø§ ÙˆØ£Ù…Ø³Ù‰ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡â€¦",count:1,ref:"Ù…Ø³Ù„Ù…"},{txt:"Ø§Ù„Ø¥Ø®Ù„Ø§Øµ ÙˆØ§Ù„ÙÙ„Ù‚ ÙˆØ§Ù„Ù†Ø§Ø³ (Ù£)",count:3,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},{txt:"Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡",count:100,ref:"Ù…Ø³Ù„Ù…"}],
      sleep:[{txt:"Ø¨Ø§Ø³Ù…Ùƒ Ø§Ù„Ù„Ù‡Ù… Ø£Ù…ÙˆØª ÙˆØ£Ø­ÙŠØ§",count:1,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"},{txt:"Ø¢ÙŠØ© Ø§Ù„ÙƒØ±Ø³ÙŠ",count:1,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"},{txt:"Ø§Ù„Ø¥Ø®Ù„Ø§Øµ ÙˆØ§Ù„ÙÙ„Ù‚ ÙˆØ§Ù„Ù†Ø§Ø³",count:1,ref:"Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ"}],
      home:[{txt:"Ø¯Ø¹Ø§Ø¡ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¨ÙŠØªâ€¦",count:1,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},{txt:"Ø°ÙƒØ± Ø§Ù„Ø·Ø¹Ø§Ù…â€¦",count:1,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},{txt:"Ù„Ø¨Ø³ Ø§Ù„Ø«ÙˆØ¨â€¦",count:1,ref:"Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯"},{txt:"Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø³ÙØ±â€¦",count:1,ref:"Ù…Ø³Ù„Ù…"}]},
  fr:{morning:[{txt:"Nous entrons au matinâ€¦",count:1,ref:"Muslim"},{txt:"Sayyid al-IstighfÃ¢r",count:1,ref:"Bukhari"},{txt:"SubhÃ¢nAllÃ¢h wa bihamdih",count:100,ref:"Muslim"},{txt:"LÃ¢ ilÃ¢ha illÃ¢ AllÃ¢hâ€¦",count:100,ref:"Bukhari"}],
      afterPrayer:[{txt:"Istighfar (3) puis Â« Allahumma anta as-SalÃ¢mâ€¦ Â»",count:1,ref:"Muslim"},{txt:"33/33/33 + 100",count:1,ref:"Muslim"},{txt:"Ã‚yat al-KursÃ®",count:1,ref:"Hasan"}],
      evening:[{txt:"Nous entrons au soirâ€¦",count:1,ref:"Muslim"},{txt:"IkhlÃ¢s + Falaq + NÃ¢s (Ã—3)",count:3,ref:"Abu Dawud"},{txt:"SubhÃ¢nAllÃ¢h wa bihamdih",count:100,ref:"Muslim"}],
      sleep:[{txt:"Bismika AllÃ¢humma amÃ»tu wa ahyÃ¢",count:1,ref:"Bukhari"},{txt:"Ã‚yat al-KursÃ®",count:1,ref:"Bukhari"},{txt:"IkhlÃ¢s + Falaq + NÃ¢s",count:1,ref:"Bukhari"}],
      home:[{txt:"Entrer Ã  la maison",count:1,ref:"Abu Dawud"},{txt:"Avant/aprÃ¨s le repas",count:1,ref:"Abu Dawud"},{txt:"Mettre un vÃªtement",count:1,ref:"Abu Dawud"},{txt:"Invocation du voyage",count:1,ref:"Muslim"}]},
  en:{morning:[{txt:"We enter the morningâ€¦",count:1,ref:"Muslim"},{txt:"Sayyid al-Istighfar",count:1,ref:"Bukhari"},{txt:"SubhanAllah wa bihamdih",count:100,ref:"Muslim"},{txt:"La ilaha illa Allahâ€¦",count:100,ref:"Bukhari"}],
      afterPrayer:[{txt:"Istighfar (3) then: Allahumma anta as-Salamâ€¦",count:1,ref:"Muslim"},{txt:"33/33/33 + completion to 100",count:1,ref:"Muslim"},{txt:"Ayat al-Kursi",count:1,ref:"Hasan"}],
      evening:[{txt:"We enter the eveningâ€¦",count:1,ref:"Muslim"},{txt:"Ikhlas + Falaq + Nas (Ã—3)",count:3,ref:"Abu Dawud"},{txt:"SubhanAllah wa bihamdih",count:100,ref:"Muslim"}],
      sleep:[{txt:"Bismika Allahumma amutu wa ahya",count:1,ref:"Bukhari"},{txt:"Ayat al-Kursi",count:1,ref:"Bukhari"},{txt:"Ikhlas + Falaq + Nas",count:1,ref:"Bukhari"}],
      home:[{txt:"Entering home",count:1,ref:"Abu Dawud"},{txt:"Before/after meal",count:1,ref:"Abu Dawud"},{txt:"Wearing a garment",count:1,ref:"Abu Dawud"},{txt:"Travel invocation",count:1,ref:"Muslim"}]}
};

/* =================== Utils & State =================== */
const $q = s => document.querySelector(s);
const toMin = s => { const [h,m] = s.split(":").map(Number); return h*60+m; };
const fromMin = m => { m=((m%1440)+1440)%1440; const h=Math.floor(m/60),mi=m%60; return `${String(h).padStart(2,"0")}:${String(mi).padStart(2,"0")}`; };
const addMin = (t,mins)=>fromMin(toMin(t)+mins);
const mid = (a,b)=>fromMin(Math.floor((toMin(a)+toMin(b))/2));
const todayKey = ()=>new Date().toISOString().slice(0,10);
const prefLangKey="pref_lang";

let CURRENT_SLOTS=null;
let CURR_LANG="fr";

/* =================== Geoloc + APIs =================== */
async function getCityName(lat, lon, lang){
  try{
    const resp=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=${lang==='ar'?'ar':lang==='fr'?'fr':'en'}`);
    const j=await resp.json();
    return j.city || j.locality || j.principalSubdivision || j.countryName || "â€”";
  }catch{return "â€”";}
}
async function getPrayerTimings(lat, lon){
  const r=await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=4`);
  const j=await r.json();
  const t=j?.data?.timings; if(!t) throw new Error("Invalid Aladhan response");
  const clean=v=>(v||"").split(" ")[0].slice(0,5);
  return {Fajr:clean(t.Fajr),Sunrise:clean(t.Sunrise),Dhuhr:clean(t.Dhuhr),Asr:clean(t.Asr),Maghrib:clean(t.Maghrib),Isha:clean(t.Isha)};
}
function buildSlots({Fajr,Sunrise,Dhuhr,Asr,Maghrib,Isha}){
  const fajrEnd=fromMin(Math.min(toMin(addMin(Fajr,60)), toMin(Sunrise)));
  const afterSunrise=addMin(Sunrise,30);
  const midMorning=mid(afterSunrise,Dhuhr);
  const midIshaFajr=mid(Isha, addMin(Fajr,24*60));
  return [
    {start:Fajr,end:fajrEnd},
    {start:fajrEnd,end:afterSunrise},
    {start:afterSunrise,end:midMorning},
    {start:midMorning,end:Dhuhr},
    {start:Dhuhr,end:Asr},
    {start:Asr,end:Maghrib},
    {start:Maghrib,end:Isha},
    {start:Isha,end:midIshaFajr},
    {start:midIshaFajr,end:addMin(Fajr,24*60)}
  ];
}
function nowIn(start,end){
  const cur=new Date(); let c=cur.getHours()*60+cur.getMinutes();
  let s=toMin(start),e=toMin(end); if(e<=s)e+=1440; if(c<s)c+=1440; return c>=s && c<e;
}

/* =================== Rendering: Home =================== */
function renderHome(){
  const L=T[CURR_LANG];
  const hero=$q("#homeHero");
  hero.innerHTML=`
    <h2>${L.home.h1}</h2>
    <p>${L.home.p1}</p>
    <p>${L.home.p2}</p>
    <p>${L.home.p3}</p>
    <p class="status">ğŸ’¡ ${L.home.note}</p>
  `;
  $q("#goPlan").textContent = (CURR_LANG==="ar")?"â¡ï¸ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ø·ÙŠØ·":(CURR_LANG==="fr")?"â¡ï¸ Aller au Planning":"â¡ï¸ Go to Planning";
  $q("#goAdhkar").textContent = (CURR_LANG==="ar")?"ğŸ•¯ï¸ ÙØªØ­ Ø§Ù„Ø£Ø°ÙƒØ§Ø±":(CURR_LANG==="fr")?"ğŸ•¯ï¸ Ouvrir AdhkÃ¢r":"ğŸ•¯ï¸ Open Adhkar";
  $q("#goQuran").textContent = (CURR_LANG==="ar")?"ğŸ“– ÙØªØ­ Ø§Ù„Ù‚Ø±Ø¢Ù†":(CURR_LANG==="fr")?"ğŸ“– Ouvrir Coran":"ğŸ“– Open Quran";
}

/* =================== Rendering: Planning =================== */
function renderPlan(){
  const L=T[CURR_LANG];
  $q("#tab-plan").textContent=L.tabs.plan;
  $q("#legend").textContent=L.legend;
  $q("#retry").textContent=L.retry; $q("#resetDay").textContent=L.resetDay;

  const tasksDef=L.tasks;
  const box=$q("#tasks"); box.innerHTML="";
  if(!CURRENT_SLOTS){ return; }

  CURRENT_SLOTS.forEach((slot,i)=>{
    const key=`done_${todayKey()}_${i}`;
    const checked=localStorage.getItem(key)==="1";
    const isNow=nowIn(slot.start,slot.end);

    const row=document.createElement("div");
    row.className="task"+(isNow?" now":"");
    row.innerHTML=`
      <div class="left">
        <input type="checkbox" id="chk-${i}" ${checked?"checked":""}/>
        <span class="time">${tasksDef[i].name}</span>
        <span id="txt-${i}" class="${checked?"done":""}">${tasksDef[i].action}</span>
        <span class="badge"><span class="ltr">${slot.start} â€“ ${slot.end}</span></span>
        ${isNow?`<span class="nowTag">â€¢ ${L.now}</span>`:""}
      </div>
      <div></div>`;
    box.appendChild(row);

    $q("#chk-"+i).addEventListener("change",e=>{
      localStorage.setItem(key, e.target.checked?"1":"0");
      $q("#txt-"+i).classList.toggle("done", e.target.checked);
    });
  });
}

/* =================== Rendering: Adhkar =================== */
function adhStoreKey(slot){ return `adh_${todayKey()}_${CURR_LANG}_${slot}`; }

function renderAdhkar(){
  const L=T[CURR_LANG];
  $q("#tab-adhkar").textContent=L.tabs.adhkar;
  $q("#slotLabel").textContent=L.adh.slot;
  $q("#resetAdhkar").textContent=L.adh.reset;
  $q("#adhHint").textContent=L.adh.hint;

  const groups = [
    {key:"all", name:L.adh.groups.all},
    {key:"morning", name:L.adh.groups.morning},
    {key:"afterPrayer", name:L.adh.groups.afterPrayer},
    {key:"evening", name:L.adh.groups.evening},
    {key:"sleep", name:L.adh.groups.sleep},
    {key:"home", name:L.adh.groups.home}
  ];
  const slotSel=$q("#slotSel");
  slotSel.innerHTML="";
  groups.forEach(g=>{ const o=document.createElement("option"); o.value=g.key; o.textContent=g.name; slotSel.appendChild(o); });
  slotSel.value=localStorage.getItem("adh_sel_"+CURR_LANG)||"all";

  const draw=(slot,query)=>{
    const db=ADH_DB[CURR_LANG];
    const box=$q("#adhkarList"); box.innerHTML="";
    const renderList=(key,title,list)=>{
      if(!list||!list.length)return;
      if(title){
        const head=document.createElement("div");
        head.className="sectionHead";
        head.innerHTML=`<div class="catTitle">${title}</div>
          <div class="sectionActions">
            <button class="btn primary" id="${key}-all">âœ…</button>
            <button class="btn" id="${key}-reset">${L.adh.reset}</button>
          </div>`;
        box.appendChild(head);
        const divi=document.createElement("div"); divi.className="divider"; box.appendChild(divi);
        head.querySelector(`#${key}-all`).onclick=()=>{
          const counts=JSON.parse(localStorage.getItem(adhStoreKey(key))||"{}");
          list.forEach((d,i)=>counts[i]=d.count||1);
          localStorage.setItem(adhStoreKey(key),JSON.stringify(counts));
          draw(slotSel.value, $q("#adhSearch").value.trim());
        };
        head.querySelector(`#${key}-reset`).onclick=()=>{
          localStorage.removeItem(adhStoreKey(key));
          draw(slotSel.value, $q("#adhSearch").value.trim());
        };
      }
      const counts=JSON.parse(localStorage.getItem(adhStoreKey(key))||"{}");
      list.forEach((d,idx)=>{
        if(query && !d.txt.toLowerCase().includes(query.toLowerCase())) return;
        const need=d.count||1, cur=counts[idx]||0;
        const div=document.createElement("div");
        div.className="dhk";
        div.innerHTML=`
          <div><strong>${d.txt}</strong></div>
          <div class="status">${d.ref?`<span class="tag">${d.ref}</span>`:""}<span class="tag">x${need}</span></div>
          <div class="controls">
            <button class="btn primary" id="${key}-plus-${idx}">+1</button>
            <button class="btn" id="${key}-minus-${idx}">-1</button>
            <span class="counter" id="${key}-count-${idx}">${cur}/${need}</span>
            <button class="btn" id="${key}-done-${idx}">âœ…</button>
            <button class="btn" id="${key}-clear-${idx}">â†º</button>
          </div>`;
        box.appendChild(div);
        const upd=(v)=>{
          const c=Math.max(0, Math.min(need, v));
          counts[idx]=c; localStorage.setItem(adhStoreKey(key),JSON.stringify(counts));
          $q(`#${key}-count-${idx}`).textContent=`${c}/${need}`;
        };
        $q(`#${key}-plus-${idx}`).onclick=()=>upd((counts[idx]||0)+1);
        $q(`#${key}-minus-${idx}`).onclick=()=>upd((counts[idx]||0)-1);
        $q(`#${key}-done-${idx}`).onclick=()=>upd(need);
        $q(`#${key}-clear-${idx}`).onclick=()=>upd(0);
      });
    };

    if(slot==="all"){
      renderList("morning",L.adh.groups.morning,db.morning);
      renderList("afterPrayer",L.adh.groups.afterPrayer,db.afterPrayer);
      renderList("evening",L.adh.groups.evening,db.evening);
      renderList("sleep",L.adh.groups.sleep,db.sleep);
      renderList("home",L.adh.groups.home,db.home);
    }else{
      const title = groups.find(g=>g.key===slot)?.name || "";
      renderList(slot,title,db[slot]);
    }
  };

  draw(slotSel.value,$q("#adhSearch").value.trim());
  slotSel.onchange=()=>{localStorage.setItem("adh_sel_"+CURR_LANG,slotSel.value);draw(slotSel.value,$q("#adhSearch").value.trim());};
  $q("#adhSearch").oninput=()=>draw(slotSel.value,$q("#adhSearch").value.trim());
  $q("#resetAdhkar").onclick=()=>{
    ["morning","afterPrayer","evening","sleep","home"].forEach(s=>localStorage.removeItem(adhStoreKey(s)));
    draw(slotSel.value,$q("#adhSearch").value.trim());
  };
}

/* =================== Rendering: Quran =================== */
const SURAH_NAMES=["Al-FÄtiá¸¥ah","Al-Baqarah","Ä€l â€˜ImrÄn","An-NisÄâ€™","Al-MÄâ€™idah","Al-Anâ€˜Äm","Al-Aâ€˜rÄf","Al-AnfÄl","At-Tawbah","YÅ«nus","HÅ«d","YÅ«suf","Ar-Raâ€˜d","IbrÄhÄ«m","Al-á¸¤ijr","An-Naá¸¥l","Al-IsrÄâ€™","Al-Kahf","Maryam","á¹¬Ä HÄ","Al-AnbiyÄâ€™","Al-á¸¤ajj","Al-Muâ€™minÅ«n","An-NÅ«r","Al-FurqÄn","Ash-Shuâ€˜arÄâ€™","An-Naml","Al-Qaá¹£aá¹£","Al-â€˜AnkabÅ«t","Ar-RÅ«m","LuqmÄn","As-Sajdah","Al-Aá¸¥zÄb","Sabaâ€™","FÄá¹­ir","YÄ SÄ«n","As-á¹¢ÄffÄt","á¹¢Äd","Az-Zumar","GhÄfir","Fuá¹£á¹£ilat","Ash-ShÅ«rÄ","Az-Zukhruf","Ad-DukhÄn","Al-JÄthiyah","Al-Aá¸¥qÄf","Muá¸¥ammad","Al-Fatá¸¥","Al-á¸¤ujurÄt","QÄf","Adh-DhÄriyÄt","Aá¹­-á¹¬Å«r","An-Najm","Al-Qamar","Ar-Raá¸¥mÄn","Al-WÄqiâ€˜ah","Al-á¸¤adÄ«d","Al-MujÄdilah","Al-á¸¤ashr","Al-Mumtaá¸¥anah","Aá¹£-á¹¢aff","Al-Jumuâ€˜ah","Al-MunÄfiqÅ«n","At-TaghÄbun","Aá¹­-á¹¬alÄq","At-Taá¸¥rÄ«m","Al-Mulk","Al-Qalam","Al-á¸¤Äqqah","Al-Maâ€˜Ärij","NÅ«á¸¥","Al-Jinn","Al-Muzzammil","Al-Muddaththir","Al-QiyÄmah","Al-InsÄn","Al-MursalÄt","An-Nabaâ€™","An-NÄziâ€˜Ät","â€˜Abasa","At-TakwÄ«Ø±","Al-Infiá¹­Är","Al-Muá¹­affifÄ«n","Al-InshiqÄq","Al-BurÅ«j","Aá¹­-á¹¬Äriq","Al-Aâ€˜lÄ","Al-GhÄshiyah","Al-Fajr","Al-Balad","Ash-Shams","Al-Layl","Aá¸-á¸Œuá¸¥Ä","Ash-Shará¸¥","At-TÄ«n","Al-â€˜Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-â€˜Ä€diyÄt","Al-QÄriâ€˜ah","At-TakÄthur","Al-â€˜Aá¹£r","Al-Humazah","Al-FÄ«Ù„","Quraysh","Al-MÄâ€˜Å«n","Al-Kawthar","Al-KÄfirÅ«n","An-Naá¹£r","Al-Masad","Al-IkhlÄá¹£","Al-Falaq","An-NÄs"];

function quranStoreKey(){ return `qread_${todayKey()}_${CURR_LANG}`; }

function renderQuran(){
  const L=T[CURR_LANG];
  $q("#tab-quran").textContent=L.tabs.quran;
  $q("#qLabel1").textContent=L.q.s; $q("#qLabel2").textContent=L.q.j;
  $q("#openSurah").textContent=L.q.open; $q("#markRead").textContent=L.q.mark; $q("#resetRead").textContent=L.q.reset;

  const sSel=$q("#surahSel"); sSel.innerHTML="";
  SURAH_NAMES.forEach((n,i)=>{const o=document.createElement("option");o.value=String(i+1);o.textContent=`${i+1}. ${n}`;sSel.appendChild(o);});

  const jSel=$q("#juzSel"); jSel.innerHTML="";
  for(let j=1;j<=30;j++){const o=document.createElement("option");o.value=String(j);o.textContent=`Juz ${j}`;jSel.appendChild(o);}

  const saved=localStorage.getItem(quranStoreKey());
  $q("#readStatus").textContent=saved?L.q.last(saved):"";

  $q("#openSurah").onclick=()=>{
    const s=sSel.value;
    const url=`https://quran.com/${s}?reading=false&locale=${CURR_LANG==='ar'?'ar':(CURR_LANG==='fr'?'fr':'en')}`;
    $q("#qFrame").src=url;
  };
  $q("#markRead").onclick=()=>{
    const label=`Surah ${sSel.value} / Juz ${jSel.value}`;
    localStorage.setItem(quranStoreKey(),label);
    $q("#readStatus").textContent=L.q.last(label);
  };
  $q("#resetRead").onclick=()=>{localStorage.removeItem(quranStoreKey());$q("#readStatus").textContent="";};
}

/* =================== Language & Layout =================== */
function applyLanguage(){
  const L=T[CURR_LANG];
  document.documentElement.lang=CURR_LANG;
  document.documentElement.dir = (CURR_LANG==="ar") ? "rtl" : "ltr";
  document.body.style.direction = (CURR_LANG==="ar") ? "rtl" : "ltr";

  $q("#title").textContent=L.title;
  $q("#langLabel").textContent=L.lang;
  $q("#cityLabel").textContent=L.city;
  $q("#status").textContent=L.statusGeo;

  // Tabs labels
  $q("#tab-home").textContent=L.tabs.home;
  $q("#tab-plan").textContent=L.tabs.plan;
  $q("#tab-adhkar").textContent=L.tabs.adhkar;
  $q("#tab-quran").textContent=L.tabs.quran;

  // Render pages
  renderHome();
  renderPlan();
  renderAdhkar();
  renderQuran();
}

/* =================== Page navigation =================== */
function showPage(key){
  ["page-home","page-plan","page-adhkar","page-quran"].forEach(id=>{$q("#"+id).style.display="none";});
  ["tab-home","tab-plan","tab-adhkar","tab-quran"].forEach(id=>$q("#"+id).classList.remove("active"));
  if(key==="home"){ $q("#page-home").style.display="block"; $q("#tab-home").classList.add("active"); }
  if(key==="plan"){ $q("#page-plan").style.display="block"; $q("#tab-plan").classList.add("active"); }
  if(key==="adhkar"){ $q("#page-adhkar").style.display="block"; $q("#tab-adhkar").classList.add("active"); }
  if(key==="quran"){ $q("#page-quran").style.display="block"; $q("#tab-quran").classList.add("active"); }
  localStorage.setItem("last_page", key);
}

/* =================== Geolocation bootstrap =================== */
async function locateAndBuild(){
  const L=T[CURR_LANG];
  $q("#status").textContent=L.statusGeo;
  if(!("geolocation" in navigator)){ $q("#status").textContent=L.geoNo; return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude,longitude}=pos.coords;
    $q("#status").textContent="ğŸ“ â€¦";
    try{
      const [city, timings]=await Promise.all([
        getCityName(latitude,longitude,CURR_LANG),
        getPrayerTimings(latitude,longitude)
      ]);
      $q("#cityName").textContent=city;
      CURRENT_SLOTS=buildSlots(timings);
      renderPlan();
      $q("#status").textContent=L.geoOk;
      // Refresh current-slot highlight every minute
      setInterval(renderPlan, 60*1000);
    }catch(e){
      console.error(e); $q("#status").textContent=L.loadErr;
    }
  }, err=>{
    console.warn(err); $q("#status").textContent=L.geoDenied; $q("#cityName").textContent="â€”";
  }, {enableHighAccuracy:true, timeout:15000});
}

/* =================== Events =================== */
document.addEventListener("DOMContentLoaded", ()=>{
  // lang init
  CURR_LANG = localStorage.getItem(prefLangKey) || "fr";
  $q("#lang").value = CURR_LANG;
  applyLanguage();

  // default to Home (or last page)
  showPage(localStorage.getItem("last_page") || "home");

  // geolocate immediately
  locateAndBuild();

  // language change
  $q("#lang").addEventListener("change", ()=>{
    CURR_LANG = $q("#lang").value;
    localStorage.setItem(prefLangKey, CURR_LANG);
    applyLanguage();
    // restart geoloc (city label language + quran locale)
    locateAndBuild();
  });

  // nav
  $q("#tab-home").onclick=()=>showPage("home");
  $q("#tab-plan").onclick=()=>showPage("plan");
  $q("#tab-adhkar").onclick=()=>showPage("adhkar");
  $q("#tab-quran").onclick=()=>showPage("quran");

  // home CTAs
  $q("#goPlan").onclick=()=>showPage("plan");
  $q("#goAdhkar").onclick=()=>showPage("adhkar");
  $q("#goQuran").onclick=()=>showPage("quran");

  // planning actions
  $q("#retry").onclick=locateAndBuild;
  $q("#resetDay").onclick=()=>{
    for(let i=0;i<9;i++) localStorage.removeItem(`done_${todayKey()}_${i}`);
    renderPlan();
  };
});
</script>
</body>
</html>
