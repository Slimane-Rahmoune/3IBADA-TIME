<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coran ‚Ä¢ Adhk√¢r ‚Ä¢ Planning ‚Ä¢ Qibla 3D ‚Ä¢ Adh√¢n</title>
<meta name="theme-color" content="#0ea5e9">
<style>
  /* ====== Theme (Light / Dark ready) ====== */
  :root{
    --bg:#0b1220;            /* deep night */
    --card:rgba(255,255,255,.08);
    --glass:rgba(255,255,255,.06);
    --text:#e6eefc;
    --muted:#9db0cc;
    --brand:#0ea5e9;         /* sky */
    --brand-2:#22d3ee;       /* cyan */
    --now:#10b981;           /* emerald */
    --warn:#f59e0b;          /* amber */
    --danger:#ef4444;
    --shadow:0 10px 25px rgba(0,0,0,.35);
    --ring:0 0 0 2px rgba(14,165,233,.25);
  }
  @media(prefers-color-scheme:light){
    :root{
      --bg:#f5f7fb; --card:#ffffffcc; --glass:#ffffffaa; --text:#0f1a2b; --muted:#6b7280;
      --shadow:0 10px 25px rgba(0,0,0,.12);
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% -10%, #233b65 0%, transparent 60%),
      radial-gradient(1200px 700px at 110% 10%, #0e2d49 0%, transparent 60%),
      linear-gradient(180deg, #0b1220 0%, #0b1220 100%);
    background-attachment: fixed;
  }

  .wrap{max-width:1100px;margin:0 auto;padding:18px}

  /* ====== Header ====== */
  header{
    position:sticky;top:0;z-index:30;margin-bottom:14px;
    background:linear-gradient(90deg, rgba(14,165,233,.2), rgba(34,211,238,.2));
    backdrop-filter: blur(8px);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    box-shadow:var(--shadow);
    padding:10px 14px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  }
  .title{
    display:flex;align-items:center;gap:10px;font-weight:700;
    letter-spacing:.2px;
  }
  .title .logo{
    width:36px;height:36px;border-radius:10px;
    background:conic-gradient(from 0deg at 50% 50%, #22d3ee, #0ea5e9, #22d3ee);
    box-shadow:0 0 0 3px rgba(14,165,233,.25);
  }
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,button,input[type="text"],input[type="range"]{
    color:var(--text);background:var(--glass);
    border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:9px 12px;cursor:pointer;
    transition:.2s border,.2s box-shadow;
  }
  select:focus,button:focus,input:focus{outline:none;box-shadow:var(--ring);border-color:var(--brand)}

  .pill{display:inline-flex;gap:8px;align-items:center;background:var(--glass);
    border:1px solid rgba(255,255,255,.18);color:var(--text);
    border-radius:999px;padding:6px 12px}

  /* ====== Tabs ====== */
  .tabs{
    position:sticky;top:72px;z-index:20;margin:14px 0 0;
    display:flex;gap:8px;flex-wrap:wrap;
  }
  .tab{
    padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);
    background:var(--glass);cursor:pointer;backdrop-filter:blur(6px);
    transition:.2s transform,.2s background;
  }
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:linear-gradient(90deg, rgba(14,165,233,.25), rgba(34,211,238,.25));}

  /* ====== Card ====== */
  .card{
    background:var(--card);backdrop-filter:blur(10px);
    box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.14);
    border-radius:16px;padding:14px;margin:14px 0;
  }
  .legend{font-size:13px;color:var(--muted);margin-bottom:6px}

  /* ====== Buttons ====== */
  .btn{border:1px solid rgba(255,255,255,.18);background:var(--glass);border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg, #0ea5e9, #22d3ee);color:#04121a;border:none}
  .btn.warn{background:linear-gradient(90deg, #f59e0b,#fbbf24);color:#1f1305;border:none}
  .btn.danger{background:linear-gradient(90deg, #ef4444,#f87171);color:#2a0b0b;border:none}

  /* ====== Status line ====== */
  .status{color:var(--muted);font-size:14px;margin:6px 0}

  /* ====== Planning ====== */
  .task{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid rgba(255,255,255,.16);border-radius:14px;padding:12px;margin:10px 0;background:rgba(255,255,255,.04)}
  .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .time{font-weight:700}
  .badge{font-size:12px;background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.35);border-radius:999px;padding:2px 8px}
  .ltr{direction:ltr;unicode-bidi:embed}
  .now{border-color:rgba(16,185,129,.5); box-shadow:0 0 0 2px rgba(16,185,129,.25)}
  .now .badge{background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.35)}
  .nowTag{font-size:12px;color:#34d399;margin-inline-start:6px}
  .done{text-decoration:line-through;color:#93a2b8}
  input[type="checkbox"]{width:22px;height:22px;accent-color:#0ea5e9}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:8px 0}

  /* ====== Adhk√¢r ====== */
  .adh-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .sectionHead{display:flex;align-items:center;justify-content:space-between;margin:10px 0 6px}
  .catTitle{font-weight:700}
  .sectionActions{display:flex;gap:6px}
  .dhk{border:1px solid rgba(255,255,255,.16);border-radius:14px;padding:12px;margin:10px 0;background:rgba(255,255,255,.04)}
  .dhk .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .counter{min-width:54px;text-align:center;border-radius:10px;border:1px solid rgba(255,255,255,.18);padding:5px 10px;background:rgba(255,255,255,.06)}
  .tag{display:inline-block;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);border-radius:999px;padding:2px 8px;margin-inline-start:6px}
  .divider{height:1px;background:rgba(255,255,255,.1);margin:8px 0}

  /* ====== Quran ====== */
  .qrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  iframe{width:100%;height:70vh;border:none;border-radius:16px;box-shadow:var(--shadow);background:#000}

  /* ====== Qibla 3D ====== */
  .q3d-top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .q3d-stage{perspective:900px;display:flex;justify-content:center;align-items:center}
  .q3d-scene{width:340px;height:340px;position:relative;transform-style:preserve-3d;transition:transform .15s ease-out}
  .q3d-disk{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:280px;height:280px;border-radius:50%;background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.9) 0 35%, rgba(255,255,255,.6) 36% 37%, rgba(255,255,255,.9) 38% 100%);border:12px solid rgba(255,255,255,.6);box-shadow:var(--shadow)}
  .q3d-ring::before,.q3d-ring::after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:280px;height:280px;border-radius:50%;box-shadow:inset 0 0 0 2px #c3d5ea,inset 0 0 0 18px transparent}
  .q3d-north{position:absolute;left:50%;top:22px;transform:translateX(-50%);font-weight:800;color:#0f2a4a}
  .q3d-needle{position:absolute;left:50%;top:50%;width:10px;height:150px;transform-origin:50% 100%;transform:translate(-50%,-100%) rotateZ(0deg)}
  .q3d-needle .shaft{width:10px;height:112px;background:#1e293b;border-radius:5px 5px 0 0;box-shadow:0 0 10px rgba(0,0,0,.08)}
  .q3d-needle .head{width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:30px solid #e11d48;margin-left:-8px}
  .q3d-qibla{position:absolute;left:50%;top:50%;width:0;height:0;transform-origin:50% 100%;transform:translate(-50%,-100%) rotateZ(0deg)}
  .q3d-qibla .body{width:12px;height:110px;background:#10b981;border-radius:7px 7px 0 0;margin-left:-6px;box-shadow:0 0 10px rgba(16,185,129,.35)}
  .q3d-qibla .tip{width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:32px solid #10b981;margin-left:-8px}
  .q3d-label{position:absolute;left:50%;top:50%;transform:translate(-50%,-160%);background:#e7f8f2;border:1px solid #b9f1df;color:#065f46;font-size:12px;border-radius:999px;padding:2px 8px}
  .q3d-hint{font-size:12px;color:var(--muted);margin-top:6px}

  /* ====== Adhan ====== */
  .adhan-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .adhan-table{width:100%;border-collapse:separate;border-spacing:0 10px}
  .adhan-table th{font-weight:700;color:var(--muted);text-align:left;padding:6px 8px}
  .adhan-row{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);border-radius:14px;box-shadow:var(--shadow)}
  .adhan-row td{padding:12px 10px;vertical-align:middle}
  .pill-small{font-size:12px;background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.35);border-radius:999px;padding:2px 8px;display:inline-block}
  .sel{min-width:190px}
  .mute{opacity:.5}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title"><div class="logo"></div><div id="title">üìñ Coran ‚Ä¢ üïØÔ∏è Adhk√¢r ‚Ä¢ üï∞Ô∏è Planning ‚Ä¢ üß≠ Qibla ‚Ä¢ üîî Adh√¢n</div></div>
    <div class="right">
      <label for="lang" id="langLabel">Langue :</label>
      <select id="lang">
        <option value="fr">Fran√ßais</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="en">English</option>
      </select>
      <div class="pill">üèôÔ∏è <span id="cityLabel">Ville :</span> <strong id="cityName">‚Äî</strong></div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" id="tab-home">üè† Accueil</button>
    <button class="tab" id="tab-plan">üìã Planning</button>
    <button class="tab" id="tab-adhkar">üïØÔ∏è Adhk√¢r</button>
    <button class="tab" id="tab-quran">üìñ Coran</button>
    <button class="tab" id="tab-qibla">üß≠ Qibla 3D</button>
    <button class="tab" id="tab-adhan">üîî Adh√¢n</button>
  </div>

  <div class="status" id="status">‚è≥ Demande de g√©olocalisation‚Ä¶</div>

  <!-- HOME -->
  <section class="card" id="page-home">
    <div class="legend" id="homeHero"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="goPlan">‚û°Ô∏è Planning</button>
      <button class="btn" id="goAdhkar">üïØÔ∏è Adhk√¢r</button>
      <button class="btn" id="goQuran">üìñ Coran</button>
      <button class="btn" id="goQibla">üß≠ Qibla</button>
      <button class="btn" id="goAdhan">üîî Adh√¢n</button>
    </div>
  </section>

  <!-- PLANNING -->
  <section class="card" id="page-plan" style="display:none">
    <div class="legend" id="legend"></div>
    <div class="toolbar">
      <button id="retry" class="btn warn">‚Üª Re-demander la g√©olocalisation</button>
      <button id="resetDay" class="btn">‚Ü∫ R√©initialiser la progression du jour</button>
    </div>
    <div id="tasks"></div>
  </section>

  <!-- ADHKAR -->
  <section class="card" id="page-adhkar" style="display:none">
    <div class="adh-toolbar">
      <label for="slotSel" id="slotLabel">Cr√©neau :</label>
      <select id="slotSel"></select>
      <input type="text" id="adhSearch" placeholder="Recherche‚Ä¶" />
      <button id="resetAdhkar" class="btn primary">‚Ü∫ R√©initialiser les compteurs</button>
    </div>
    <div id="adhkarList"></div>
    <p class="status" id="adhHint"></p>
  </section>

  <!-- QURAN -->
  <section class="card" id="page-quran" style="display:none">
    <div class="qrow">
      <label id="qLabel1">Sourate :</label>
      <select id="surahSel"></select>
      <label id="qLabel2">Juz :</label>
      <select id="juzSel"></select>
      <label id="reciterLabel">R√©citateur :</label>
      <select id="reciterSel"></select>
      <button id="playAudio" class="btn">‚ñ∂Ô∏è Audio</button>
      <button id="markRead" class="btn">‚úÖ</button>
      <button id="resetRead" class="btn">‚Ü∫</button>
    </div>
    <div class="status" id="readStatus"></div>
    <audio id="qAudio" preload="none" controls style="width:100%;margin:8px 0"></audio>
    <iframe id="qFrame" title="Quran"></iframe>
  </section>

  <!-- QIBLA 3D -->
  <section class="card" id="page-qibla" style="display:none">
    <div class="q3d-top">
      <button class="btn primary" id="enableCompass">üß≠ Activer la boussole</button>
      <button class="btn" id="lockTilt">üéØ Verrouiller inclinaison</button>
      <div class="status" id="qiblaInfo">Qibla : ‚Äî¬∞ ‚Ä¢ Cap : ‚Äî¬∞ ‚Ä¢ √âcart : ‚Äî¬∞</div>
    </div>
    <div class="q3d-top" style="gap:16px">
      <label for="calib" style="min-width:200px">‚öôÔ∏è Calibration (‚àí30¬∞ ‚Üí +30¬∞)</label>
      <input id="calib" type="range" min="-30" max="30" step="1" value="0" />
      <span id="calibVal" class="pill">0¬∞</span>
      <button class="btn" id="resetCalib">‚Ü∫ Reset</button>
    </div>
    <div class="q3d-stage">
      <div class="q3d-scene" id="q3dScene">
        <div class="q3d-disk q3d-ring"></div>
        <div class="q3d-north">N</div>
        <div class="q3d-needle" id="needle3d"><div class="shaft"></div><div class="head"></div></div>
        <div class="q3d-qibla" id="qArrow"><div class="body"></div><div class="tip"></div></div>
        <div class="q3d-label" id="qLabel">Kaaba</div>
      </div>
    </div>
    <div class="q3d-hint" id="qiblaHint"></div>
  </section>

  <!-- ADHAN -->
  <section class="card" id="page-adhan" style="display:none">
    <div class="adhan-bar">
      <button class="btn primary" id="reqNotify">üîî Autoriser les notifications</button>
      <button class="btn" id="resync">‚Üª Reprogrammer</button>
      <span class="status" id="nextAdhanMsg"></span>
    </div>
    <div class="legend" id="legendAdhan"></div>
    <table class="adhan-table">
      <thead><tr>
        <th>üìø Pri√®re</th><th>‚è∞ Horaire</th><th>üîî Mode</th><th>üó£Ô∏è Muezzin</th><th>‚ñ∂Ô∏è Test</th>
      </tr></thead>
      <tbody id="adhanRows"></tbody>
    </table>
    <audio id="adhanAudio" preload="auto"></audio>
  </section>
</div>

<script>
/* =================== I18N =================== */
const T={
  fr:{title:"üìñ Coran ‚Ä¢ üïØÔ∏è Adhk√¢r ‚Ä¢ üï∞Ô∏è Planning ‚Ä¢ üß≠ Qibla ‚Ä¢ üîî Adh√¢n",
      lang:"Langue :", city:"Ville :", statusGeo:"‚è≥ Demande de g√©olocalisation‚Ä¶",
      tabs:{home:"üè† Accueil",plan:"üìã Planning",adhkar:"üïØÔ∏è Adhk√¢r",quran:"üìñ Coran",qibla:"üß≠ Qibla 3D",adhan:"üîî Adh√¢n"},
      home:{h1:"Bienvenue !",
        p1:"Je m‚Äôappelle <strong>Slimane Rahmoune</strong>. Je partage des cr√©neaux d‚Äôadorations inspir√©s de la sunnah du Proph√®te Ô∑∫.",
        p2:"Lisez/√©coutez le Coran, r√©citez les adhk√¢r et suivez votre progression.",
        ded:"<strong>Cette page est une sadaqa j√¢riya d√©di√©e √† ma d√©funte et ch√®re tante BEN BOURENANE TOUNSIA</strong> ‚Äî qu‚ÄôAllah lui fasse mis√©ricorde. Merci de l‚Äôutiliser pour lire/√©couter le Coran, les adhk√¢r et suivre les adorations du Proph√®te Ô∑∫.",
        p3:"Faites de votre mieux, avec constance et sinc√©rit√©.",
        note:"Horaires et Qibla s‚Äôadaptent √† votre position."
      },
      legend:"Cr√©neaux calcul√©s via Aladhan (m√©thode 4 = Egypt). Actualisation de l‚Äôindicateur chaque minute.",
      retry:"‚Üª Re-demander la g√©olocalisation", resetDay:"‚Ü∫ R√©initialiser la progression du jour", now:"Cr√©neau en cours",
      tasks:[
        { name:"Avant Fajr", action:"Qiy√¢m & adhk√¢r" },
        { name:"Fajr ‚Üí +30 min", action:"Fajr + Coran & invocations" },
        { name:"Matin", action:"Travail/√âtudes avec intention" },
        { name:"Duha", action:"2‚Äì4 unit√©s de pri√®re" },
        { name:"Dhuhr", action:"Pri√®re + sieste courte" },
        { name:"‚ÄòAsr ‚Üí Maghrib", action:"Travail/Savoir + Sport" },
        { name:"Maghrib ‚Üí ‚ÄòIsha", action:"Famille + Coran" },
        { name:"‚ÄòIsha", action:"Pri√®re + Lecture/Repos" },
        { name:"Nuit", action:"Dormir t√¥t + Qiy√¢m" }
      ],
      adh:{slot:"Cr√©neau :",reset:"‚Ü∫ R√©initialiser les compteurs",hint:"Comptes sauvegard√©s localement (par jour et cr√©neau).",
           groups:{all:"Tous", morning:"Matin", afterPrayer:"Apr√®s-pri√®re", evening:"Soir", sleep:"Avant de dormir", home:"Maison"}},
      q:{s:"Sourate :",j:"Juz :",open:"Ouvrir",mark:"‚úÖ Marquer lu",reset:"‚Ü∫ R√©initialiser",last:s=>`Derni√®re lecture : ${s}`, reciter:"R√©citateur :"},
      qibla:{hint:"Si l‚Äôaiguille n‚Äôest pas exacte, ajustez la **calibration** (en degr√©s) et verrouillez l‚Äôinclinaison.", label:"Kaaba"},
      adhan:{legend:"Choisissez le mode (Off/Son/Vibreur) et le muezzin pour chaque pri√®re.",
             off:"D√©sactiv√©", sound:"Adh√¢n (son)", vibrate:"Vibreur",
             notifAsk:"üîî Autoriser les notifications", next:t=>`Prochain adh√¢n programm√© : ${t}`}
  },
  ar:{title:"üìñ ÿßŸÑŸÇÿ±ÿ¢ŸÜ ‚Ä¢ üïØÔ∏è ÿßŸÑÿ£ÿ∞ŸÉÿßÿ± ‚Ä¢ üï∞Ô∏è ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ‚Ä¢ üß≠ ÿßŸÑŸÇÿ®ŸÑÿ© ‚Ä¢ üîî ÿßŸÑÿ£ÿ∞ÿßŸÜ",
      lang:"ÿßŸÑŸÑÿ∫ÿ©:", city:"ÿßŸÑŸÖÿØŸäŸÜÿ©:", statusGeo:"‚è≥ ÿ¨ÿßÿ±Ÿç ÿ∑ŸÑÿ® ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ‚Ä¶",
      tabs:{home:"üè† ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",plan:"üìã ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑",adhkar:"üïØÔ∏è ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±",quran:"üìñ ÿßŸÑŸÇÿ±ÿ¢ŸÜ",qibla:"üß≠ ÿßŸÑŸÇÿ®ŸÑÿ© 3D",adhan:"üîî ÿßŸÑÿ£ÿ∞ÿßŸÜ"},
      home:{h1:"ŸÖÿ±ÿ≠ÿ®Ÿãÿß!",
        p1:"ÿ£ŸÜÿß <strong>ÿ≥ŸÑŸäŸÖÿßŸÜ ÿ±ÿ≠ŸÖŸàŸÜ</strong> ÿ£ÿ¥ÿßÿ±ŸÉ ŸÅÿ™ÿ±ÿßÿ™ ÿπÿ®ÿßÿØÿßÿ™ ÿπŸÑŸâ ŸáÿØŸä ÿßŸÑÿ≥ŸÜÿ©.",
        p2:"ÿßŸÇÿ±ÿ§Ÿàÿß/ÿßÿ≥ÿ™ŸÖÿπŸàÿß ŸÑŸÑŸÇÿ±ÿ¢ŸÜÿå Ÿàÿßÿ∞ŸÉÿ±Ÿàÿß ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±ÿå Ÿàÿ™ÿßÿ®ÿπŸàÿß ÿßŸÑÿ™ŸÇÿØŸëŸÖ.",
        ded:"<strong>Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ© ÿµÿØŸÇÿ© ÿ¨ÿßÿ±Ÿäÿ© ŸÑÿπŸÖŸëÿ™Ÿä ÿßŸÑÿ≠ÿ®Ÿäÿ®ÿ© ÿßŸÑŸÖÿ™ŸàŸÅÿßÿ© BEN BOURENANE TOUNSIA</strong> ‚Äî ŸÜÿ≥ÿ£ŸÑ ÿßŸÑŸÑŸá ÿ£ŸÜ Ÿäÿ±ÿ≠ŸÖŸáÿß. ÿßÿ≥ÿ™ÿÆÿØŸÖŸàŸáÿß ŸÑŸÇÿ±ÿßÿ°ÿ©/ÿ≥ŸÖÿßÿπ ÿßŸÑŸÇÿ±ÿ¢ŸÜ ŸàÿßŸÑÿ£ÿ∞ŸÉÿßÿ± Ÿàÿßÿ™ÿ®ÿßÿπ ÿπÿ®ÿßÿØÿßÿ™ ÿßŸÑŸÜÿ®Ÿä Ô∑∫.",
        p3:"ÿßÿ®ÿ∞ŸÑŸàÿß ÿ¨ŸáÿØŸÉŸÖ ÿ®ÿ•ÿÆŸÑÿßÿµ ŸàÿßŸÜÿ™ÿ∏ÿßŸÖ.",
        note:"ÿßŸÑÿ£ŸàŸÇÿßÿ™ ŸàÿßŸÑŸÇÿ®ŸÑÿ© ÿ™ÿ™ŸÉŸäŸëŸÅ ŸÖÿπ ŸÖŸàŸÇÿπŸÉŸÖ."
      },
      legend:"ÿ™ŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿπÿ®ÿ± Aladhan (ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© Ÿ§). Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ§ÿ¥ÿ± ŸÉŸÑ ÿØŸÇŸäŸÇÿ©.",
      retry:"‚Üª ÿ•ÿπÿßÿØÿ© ÿ∑ŸÑÿ® ÿßŸÑŸÖŸàŸÇÿπ", resetDay:"‚Ü∫ ÿ™ÿµŸÅŸäÿ± ÿ•ŸÜÿ¨ÿßÿ≤ ÿßŸÑŸäŸàŸÖ", now:"ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸáŸÜÿß",
      tasks:[
        { name:"ŸÇÿ®ŸÑ ÿßŸÑŸÅÿ¨ÿ±", action:"ŸÇŸäÿßŸÖ ÿßŸÑŸÑŸäŸÑ Ÿàÿ∞ŸÉÿ± ÿßŸÑŸÑŸá" },
        { name:"ÿßŸÑŸÅÿ¨ÿ± ‚Üí +30ÿØ", action:"ŸÅÿ¨ÿ± + ŸÇÿ±ÿ¢ŸÜ ŸàÿØÿπÿßÿ°" },
        { name:"ÿßŸÑÿµÿ®ÿßÿ≠", action:"ÿπŸÖŸÑ/ÿØÿ±ÿßÿ≥ÿ© ÿ®ŸÜŸäÿ©" },
        { name:"ÿßŸÑÿ∂ÿ≠Ÿâ", action:"ÿ±ŸÉÿπÿ™ÿßŸÜ ÿ•ŸÑŸâ ÿ£ÿ±ÿ®ÿπ" },
        { name:"ÿßŸÑÿ∏Ÿáÿ±", action:"ÿµŸÑÿßÿ© + ŸÇŸäŸÑŸàŸÑÿ©" },
        { name:"ÿßŸÑÿπÿµÿ± ‚Üí ÿßŸÑŸÖÿ∫ÿ±ÿ®", action:"ÿπŸÖŸÑ/ÿπŸÑŸÖ + ÿ±Ÿäÿßÿ∂ÿ©" },
        { name:"ÿßŸÑŸÖÿ∫ÿ±ÿ® ‚Üí ÿßŸÑÿπÿ¥ÿßÿ°", action:"ÿ¨ŸÑÿ≥ÿ© ÿπÿßÿ¶ŸÑŸäÿ© + ŸÇÿ±ÿ¢ŸÜ" },
        { name:"ÿßŸÑÿπÿ¥ÿßÿ°", action:"ÿµŸÑÿßÿ© + ŸÇÿ±ÿßÿ°ÿ©/ÿ±ÿßÿ≠ÿ©" },
        { name:"ÿßŸÑŸÑŸäŸÑ", action:"ŸÜŸàŸÖ ŸÖÿ®ŸÉÿ± + ŸÇŸäÿßŸÖ" }
      ],
      adh:{slot:"ÿßŸÑŸÅÿ™ÿ±ÿ©:",reset:"‚Ü∫ ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿπÿØÿßÿØÿßÿ™",hint:"ŸäŸèÿ≠ŸÅÿ∏ ÿßŸÑÿπÿØŸë ŸÖÿ≠ŸÑŸäŸãÿß.",
           groups:{all:"ÿßŸÑŸÉŸÑ", morning:"ÿßŸÑÿµÿ®ÿßÿ≠", afterPrayer:"ÿ®ÿπÿØ ÿßŸÑÿµŸÑÿßÿ©", evening:"ÿßŸÑŸÖÿ≥ÿßÿ°", sleep:"ŸÇÿ®ŸÑ ÿßŸÑŸÜŸàŸÖ", home:"ÿßŸÑÿ®Ÿäÿ™"}},
      q:{s:"ÿ≥Ÿàÿ±ÿ©:",j:"ÿ¨ÿ≤ÿ°:",open:"ŸÅÿ™ÿ≠",mark:"‚úÖ ÿ™ŸÖŸëÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©",reset:"‚Ü∫ ÿ™ÿµŸÅŸäÿ±",last:s=>`ÿ¢ÿÆÿ± ŸÇÿ±ÿßÿ°ÿ©: ${s}`, reciter:"ÿßŸÑŸÇÿßÿ±ÿ¶:"},
      qibla:{hint:"ÿßÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿπÿßŸäÿ±ÿ© ÿ•ŸÜ ŸÑŸÖ ÿ™ŸÉŸÜ ÿßŸÑÿ•ÿ®ÿ±ÿ© ÿØŸÇŸäŸÇÿ© Ÿàÿ´ÿ®Ÿëÿ™ ÿßŸÑŸÖŸäŸÑ.", label:"ÿßŸÑŸÉÿπÿ®ÿ©"},
      adhan:{legend:"ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ∂ÿπ ŸàÿßŸÑŸÖÿ§ÿ∞ŸëŸÜ ŸÑŸÉŸÑ ÿµŸÑÿßÿ©.",
             off:"ÿ•ŸäŸÇÿßŸÅ", sound:"ÿµŸàÿ™ ÿßŸÑÿ£ÿ∞ÿßŸÜ", vibrate:"ÿßŸáÿ™ÿ≤ÿßÿ≤", notifAsk:"üîî ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™", next:t=>`ÿßŸÑÿ£ÿ∞ÿßŸÜ ÿßŸÑŸÇÿßÿØŸÖ: ${t}`}
  },
  en:{title:"üìñ Quran ‚Ä¢ üïØÔ∏è Adhkar ‚Ä¢ üï∞Ô∏è Plan ‚Ä¢ üß≠ Qibla ‚Ä¢ üîî Adhan",
      lang:"Language:", city:"City:", statusGeo:"‚è≥ Requesting geolocation‚Ä¶",
      tabs:{home:"üè† Home",plan:"üìã Plan",adhkar:"üïØÔ∏è Adhkar",quran:"üìñ Quran",qibla:"üß≠ Qibla 3D",adhan:"üîî Adhan"},
      home:{h1:"Welcome!",
        p1:"I‚Äôm <strong>Slimane Rahmoune</strong>. Worship time slots inspired by the Prophetic Ô∑∫ way.",
        p2:"Read/listen to Qur‚Äôan, recite adhkƒÅr, and track progress.",
        ded:"<strong>This page is a sadaqah jariyah dedicated to my beloved late aunt BEN BOURENANE TOUNSIA</strong>. Please use it to read/listen to the Qur‚Äôan, adhkƒÅr, and the Prophetic worship plan.",
        p3:"Do your best with sincerity.",
        note:"Timings and Qibla adapt to your location."
      },
      legend:"Slots via Aladhan (method 4). Indicator refreshes every minute.",
      retry:"‚Üª Request geolocation again", resetDay:"‚Ü∫ Reset today‚Äôs progress", now:"You are here",
      tasks:[
        { name:"Before Fajr", action:"Qiyam & adhkar" },
        { name:"Fajr ‚Üí +30 min", action:"Fajr + Qur‚Äôan & dua" },
        { name:"Morning", action:"Work/Study with intention" },
        { name:"Duha", action:"2‚Äì4 rak‚ÄòƒÅt" },
        { name:"Dhuhr", action:"Prayer + short nap" },
        { name:"‚ÄòAsr ‚Üí Maghrib", action:"Work/Knowledge + Exercise" },
        { name:"Maghrib ‚Üí ‚ÄòIsha", action:"Family + Qur‚Äôan" },
        { name:"‚ÄòIsha", action:"Prayer + Reading/Rest" },
        { name:"Night", action:"Sleep early + QiyƒÅm" }
      ],
      adh:{slot:"Slot:",reset:"‚Ü∫ Reset counters",hint:"Saved locally (per day & slot).",
           groups:{all:"All", morning:"Morning", afterPrayer:"After prayers", evening:"Evening", sleep:"Before sleep", home:"Home"}},
      q:{s:"Surah:",j:"Juz:",open:"Open",mark:"‚úÖ Mark read",reset:"‚Ü∫ Reset",last:s=>`Last reading: ${s}`, reciter:"Reciter:"},
      qibla:{hint:"Adjust calibration if needed and lock tilt.", label:"Kaaba"},
      adhan:{legend:"Set mode & muezzin per prayer.",
             off:"Off", sound:"Adhan (sound)", vibrate:"Vibrate", notifAsk:"üîî Allow notifications", next:t=>`Next adhan scheduled: ${t}`}
  }
};

/* ====== Adhk√¢r (r√©sum√©s utiles) ====== */
const ADH_DB={ /* identique √† la version pr√©c√©dente compl√®te pour les 3 langues (abr√©g√© ici pour la lisibilit√©) */
  ar:{morning:[{txt:"ÿ£ÿµÿ®ÿ≠ŸÜÿß Ÿàÿ£ÿµÿ®ÿ≠ ÿßŸÑŸÖŸÑŸÉ ŸÑŸÑŸá...",count:1,ref:"ŸÖÿ≥ŸÑŸÖ"},{txt:"ÿ≥ŸäÿØ ÿßŸÑÿßÿ≥ÿ™ÿ∫ŸÅÿßÿ±...",count:1,ref:"ÿßŸÑÿ®ÿÆÿßÿ±Ÿä"},{txt:"ÿ≠ÿ≥ÿ®Ÿä ÿßŸÑŸÑŸá...",count:7,ref:"ÿ£ÿ®Ÿà ÿØÿßŸàÿØ"},{txt:"ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá Ÿàÿ®ÿ≠ŸÖÿØŸá",count:100,ref:"ŸÖÿ≥ŸÑŸÖ"},{txt:"ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá Ÿàÿ≠ÿØŸá...",count:100,ref:"ÿßŸÑÿ®ÿÆÿßÿ±Ÿä"}],
      afterPrayer:[{txt:"ÿ£ÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá (Ÿ£)...",count:1,ref:"ŸÖÿ≥ŸÑŸÖ"},{txt:"33/33/33 + ÿ™ŸÖÿßŸÖ ÿßŸÑŸÖÿ¶ÿ©",count:1,ref:"ŸÖÿ≥ŸÑŸÖ"},{txt:"ÿ¢Ÿäÿ© ÿßŸÑŸÉÿ±ÿ≥Ÿä",count:1,ref:"ÿµÿ≠Ÿäÿ≠"}],
      evening:[{txt:"ÿ£ŸÖÿ≥ŸäŸÜÿß...",count:1,ref:"ŸÖÿ≥ŸÑŸÖ"},{txt:"ÿßŸÑÿ•ÿÆŸÑÿßÿµ ŸàÿßŸÑŸÅŸÑŸÇ ŸàÿßŸÑŸÜÿßÿ≥ √ó3",count:3,ref:"ÿ£ÿ®Ÿà ÿØÿßŸàÿØ"},{txt:"ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá Ÿàÿ®ÿ≠ŸÖÿØŸá",count:100,ref:"ŸÖÿ≥ŸÑŸÖ"}],
      sleep:[{txt:"ÿ®ÿßÿ≥ŸÖŸÉ ÿßŸÑŸÑŸáŸÖ ÿ£ŸÖŸàÿ™ Ÿàÿ£ÿ≠Ÿäÿß",count:1,ref:"ÿßŸÑÿ®ÿÆÿßÿ±Ÿä"},{txt:"ÿ¢Ÿäÿ© ÿßŸÑŸÉÿ±ÿ≥Ÿä",count:1,ref:"ÿßŸÑÿ®ÿÆÿßÿ±Ÿä"},{txt:"ÿ¢ÿÆÿ± ÿ¢Ÿäÿ™ŸäŸÜ ŸÖŸÜ ÿßŸÑÿ®ŸÇÿ±ÿ©",count:1,ref:"ÿßŸÑÿ®ÿÆÿßÿ±Ÿä"}],
      home:[{txt:"ÿØÿπÿßÿ° ÿØÿÆŸàŸÑ ÿßŸÑÿ®Ÿäÿ™...",count:1,ref:"ÿ£ÿ®Ÿà ÿØÿßŸàÿØ"},{txt:"ÿØÿπÿßÿ° ÿßŸÑÿ∑ÿπÿßŸÖ...",count:1,ref:"ÿ£ÿ®Ÿà ÿØÿßŸàÿØ"},{txt:"ŸÑÿ®ÿ≥ ÿßŸÑÿ´Ÿàÿ®...",count:1,ref:"ÿ£ÿ®Ÿà ÿØÿßŸàÿØ"},{txt:"ÿØÿπÿßÿ° ÿßŸÑÿ≥ŸÅÿ±...",count:1,ref:"ŸÖÿ≥ŸÑŸÖ"}]},
  fr:{morning:[{txt:"Nous entrons au matin...",count:1,ref:"Muslim"},{txt:"Sayyid al-Istighf√¢r...",count:1,ref:"Bukhari"},{txt:"Hasbiyall√¢h...",count:7,ref:"Abu Dawud"},{txt:"Subh√¢nAll√¢h wa bihamdih",count:100,ref:"Muslim"},{txt:"L√¢ il√¢ha ill√¢ All√¢h...",count:100,ref:"Bukhari"}],
      afterPrayer:[{txt:"Istighfar (3) + Allahumma anta as-Sal√¢m...",count:1,ref:"Muslim"},{txt:"33/33/33 + 100",count:1,ref:"Muslim"},{txt:"√Çyat al-Kurs√Æ",count:1,ref:"Sah√Æh"}],
      evening:[{txt:"Nous entrons au soir...",count:1,ref:"Muslim"},{txt:"Ikhl√¢s + Falaq + N√¢s √ó3",count:3,ref:"Abu Dawud"},{txt:"Subh√¢nAll√¢h wa bihamdih",count:100,ref:"Muslim"}],
      sleep:[{txt:"Bismika All√¢humma...",count:1,ref:"Bukhari"},{txt:"√Çyat al-Kurs√Æ",count:1,ref:"Bukhari"},{txt:"Deux derniers versets d‚ÄôAl-Baqarah",count:1,ref:"Bukhari"}],
      home:[{txt:"Entrer √† la maison...",count:1,ref:"Abu Dawud"},{txt:"Avant/apr√®s le repas...",count:1,ref:"Abu Dawud"},{txt:"Mettre un v√™tement...",count:1,ref:"Abu Dawud"},{txt:"Invocation du voyage...",count:1,ref:"Muslim"}]},
  en:{morning:[{txt:"We enter the morning...",count:1,ref:"Muslim"},{txt:"Sayyid al-Istighfar...",count:1,ref:"Bukhari"},{txt:"HasbiyallƒÅh...",count:7,ref:"Abu Dawud"},{txt:"SubhanAllƒÅh wa bihamdih",count:100,ref:"Muslim"},{txt:"LƒÅ ilƒÅha illƒÅ AllƒÅh...",count:100,ref:"Bukhari"}],
      afterPrayer:[{txt:"Istighfar (3) + Allahumma anta as-SalƒÅm...",count:1,ref:"Muslim"},{txt:"33/33/33 + 100",count:1,ref:"Muslim"},{txt:"Ayat al-Kursi",count:1,ref:"Sahih"}],
      evening:[{txt:"We enter the evening...",count:1,ref:"Muslim"},{txt:"IkhlƒÅs + Falaq + NƒÅs √ó3",count:3,ref:"Abu Dawud"},{txt:"SubhanAllƒÅh wa bihamdih",count:100,ref:"Muslim"}],
      sleep:[{txt:"Bismika AllƒÅhumma...",count:1,ref:"Bukhari"},{txt:"Ayat al-Kursi",count:1,ref:"Bukhari"},{txt:"Last two verses of Al-Baqarah",count:1,ref:"Bukhari"}],
      home:[{txt:"Entering home dhikr...",count:1,ref:"Abu Dawud"},{txt:"Before/after meal...",count:1,ref:"Abu Dawud"},{txt:"Wearing a garment...",count:1,ref:"Abu Dawud"},{txt:"Travel supplication...",count:1,ref:"Muslim"}]}
};

/* =================== Utils / Time =================== */
const $=s=>document.querySelector(s);
const todayKey=()=>new Date().toISOString().slice(0,10);
const toMin=s=>{const [h,m]=s.split(":").map(Number);return h*60+m;}
const fromMin=m=>{m=((m%1440)+1440)%1440;const h=Math.floor(m/60),mi=m%60;return `${String(h).padStart(2,"0")}:${String(mi).padStart(2,"0")}`;}
const addMin=(t,mins)=>fromMin(toMin(t)+mins);
const mid=(a,b)=>fromMin(Math.floor((toMin(a)+toMin(b))/2));
function nowIn(start,end){const d=new Date();let c=d.getHours()*60+d.getMinutes();let s=toMin(start),e=toMin(end);if(e<=s)e+=1440;if(c<s)c+=1440;return c>=s&&c<e;}

/* =================== State =================== */
let CURR_LANG=localStorage.getItem("pref_lang")||"fr";
let CURRENT_SLOTS=null;
let QIBLA_BRG=null;
let PRAYER_TIMINGS=null;
let ADHAN_TIMER=null;
let LOCK_TILT=false;

/* =================== APIs =================== */
async function reverseCity(lat, lon, lang){
  try{
    const u=`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=${lang==='ar'?'ar':lang==='fr'?'fr':'en'}`;
    const r=await fetch(u,{cache:"no-store"}); const j=await r.json();
    return {city:j.city||j.locality||j.principalSubdivision||j.countryName||"‚Äî", country:j.countryName||""};
  }catch{return {city:"‚Äî", country:""};}
}
async function getTimings(lat, lon, cityGuess=null, countryGuess=null){
  const clean=v=>(v||"").split(" ")[0].slice(0,5);
  const tryCoords=async()=>{
    const r=await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=4`,{cache:"no-store"});
    const j=await r.json(); const t=j?.data?.timings; if(!t) throw 0;
    return {Fajr:clean(t.Fajr),Sunrise:clean(t.Sunrise),Dhuhr:clean(t.Dhuhr),Asr:clean(t.Asr),Maghrib:clean(t.Maghrib),Isha:clean(t.Isha)};
  };
  const tryCity=async()=>{
    if(!cityGuess) throw 0;
    const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(cityGuess)}${countryGuess?`&country=${encodeURIComponent(countryGuess)}`:''}&method=4`,{cache:"no-store"});
    const j=await r.json(); const t=j?.data?.timings; if(!t) throw 0;
    return {Fajr:clean(t.Fajr),Sunrise:clean(t.Sunrise),Dhuhr:clean(t.Dhuhr),Asr:clean(t.Asr),Maghrib:clean(t.Maghrib),Isha:clean(t.Isha)};
  };
  try{ return await tryCoords(); } catch{ return await tryCity(); }
}
function buildSlots({Fajr,Sunrise,Dhuhr,Asr,Maghrib,Isha}){
  const fajrEnd=fromMin(Math.min(toMin(addMin(Fajr,60)),toMin(Sunrise)));
  const afterSunrise=addMin(Sunrise,30);
  const midMorning=mid(afterSunrise,Dhuhr);
  const midIshaFajr=mid(Isha,addMin(Fajr,24*60));
  return [
    {start:Fajr,end:fajrEnd},
    {start:fajrEnd,end:afterSunrise},
    {start:afterSunrise,end:midMorning},
    {start:midMorning,end:Dhuhr},
    {start:Dhuhr,end:Asr},
    {start:Asr,end:Maghrib},
    {start:Maghrib,end:Isha},
    {start:Isha,end:midIshaFajr},
    {start:midIshaFajr,end:addMin(Fajr,24*60)}
  ];
}

/* =================== Home =================== */
function renderHome(){
  const L=T[CURR_LANG];
  const hero = `
    <h2 style="margin:0 0 6px">${L.home.h1}</h2>
    <p>${L.home.p1}</p>
    <p>${L.home.p2}</p>
    <p>${L.home.ded}</p>
    <p>${L.home.p3}</p>
    <p class="status">üí° ${L.home.note}</p>
  `;
  $("#homeHero").innerHTML=hero;
}

/* =================== Planning =================== */
function renderPlan(){
  const L=T[CURR_LANG];
  $("#legend").textContent=L.legend; $("#retry").textContent=L.retry; $("#resetDay").textContent=L.resetDay;
  const tasks=L.tasks; const box=$("#tasks"); box.innerHTML="";
  if(!CURRENT_SLOTS) return;
  CURRENT_SLOTS.forEach((slot,i)=>{
    const key=`done_${todayKey()}_${i}`; const checked=localStorage.getItem(key)==="1"; const active=nowIn(slot.start,slot.end);
    const row=document.createElement("div"); row.className="task"+(active?" now":"");
    row.innerHTML=`<div class="left">
      <input type="checkbox" id="chk-${i}" ${checked?"checked":""}/>
      <span class="time">${tasks[i].name}</span>
      <span id="txt-${i}" class="${checked?"done":""}">${tasks[i].action}</span>
      <span class="badge"><span class="ltr">${slot.start} ‚Äì ${slot.end}</span></span>
      ${active?`<span class="nowTag">‚Ä¢ ${L.now}</span>`:""}</div>`;
    box.appendChild(row);
    row.querySelector(`#chk-${i}`).addEventListener("change",e=>{
      localStorage.setItem(key,e.target.checked?"1":"0");
      row.querySelector(`#txt-${i}`).classList.toggle("done",e.target.checked);
    });
  });
}

/* =================== Adhk√¢r =================== */
function adhKey(slot){return `adh_${todayKey()}_${CURR_LANG}_${slot}`;}
function renderAdhkar(){
  const L=T[CURR_LANG];
  $("#slotLabel").textContent=L.adh.slot; $("#resetAdhkar").textContent=L.adh.reset; $("#adhHint").textContent=L.adh.hint;
  const groups=[{key:"all",name:L.adh.groups.all},{key:"morning",name:L.adh.groups.morning},{key:"afterPrayer",name:L.adh.groups.afterPrayer},{key:"evening",name:L.adh.groups.evening},{key:"sleep",name:L.adh.groups.sleep},{key:"home",name:L.adh.groups.home}];
  const sel=$("#slotSel"); sel.innerHTML=""; groups.forEach(g=>{const o=document.createElement("option");o.value=g.key;o.textContent=g.name;sel.appendChild(o);});
  sel.value=localStorage.getItem("adh_sel_"+CURR_LANG)||"all";

  const draw=(slot,q)=>{
    const db=ADH_DB[CURR_LANG]; const box=$("#adhkarList"); box.innerHTML="";
    const render=(key,title,list)=>{
      if(!list?.length)return;
      const head=document.createElement("div"); head.className="sectionHead";
      head.innerHTML=`<div class="catTitle">${title}</div>
      <div class="sectionActions"><button class="btn primary" id="${key}-all">‚úÖ</button><button class="btn" id="${key}-reset">${L.adh.reset}</button></div>`;
      box.appendChild(head); const hr=document.createElement("div"); hr.className="divider"; box.appendChild(hr);
      head.querySelector(`#${key}-all`).onclick=()=>{const c=JSON.parse(localStorage.getItem(adhKey(key))||"{}");list.forEach((d,i)=>c[i]=d.count||1);localStorage.setItem(adhKey(key),JSON.stringify(c));draw(sel.value,$("#adhSearch").value.trim());}
      head.querySelector(`#${key}-reset`).onclick=()=>{localStorage.removeItem(adhKey(key));draw(sel.value,$("#adhSearch").value.trim());}
      const counts=JSON.parse(localStorage.getItem(adhKey(key))||"{}");
      list.forEach((d,i)=>{if(q && !d.txt.toLowerCase().includes(q.toLowerCase()))return;
        const need=d.count||1,cur=counts[i]||0;
        const div=document.createElement("div"); div.className="dhk";
        div.innerHTML=`<div><strong>${d.txt}</strong></div>
        <div class="status">${d.ref?`<span class="tag">${d.ref}</span>`:""}<span class="tag">x${need}</span></div>
        <div class="controls"><button class="btn primary" id="${key}-p-${i}">+1</button><button class="btn" id="${key}-m-${i}">-1</button>
        <span class="counter" id="${key}-c-${i}">${cur}/${need}</span><button class="btn" id="${key}-d-${i}">‚úÖ</button><button class="btn" id="${key}-z-${i}">‚Ü∫</button></div>`;
        box.appendChild(div);
        const upd=v=>{const nv=Math.max(0,Math.min(need,v));counts[i]=nv;localStorage.setItem(adhKey(key),JSON.stringify(counts));$(`#${key}-c-${i}`).textContent=`${nv}/${need}`;}
        $(`#${key}-p-${i}`).onclick=()=>upd((counts[i]||0)+1);
        $(`#${key}-m-${i}`).onclick=()=>upd((counts[i]||0)-1);
        $(`#${key}-d-${i}`).onclick=()=>upd(need);
        $(`#${key}-z-${i}`).onclick=()=>upd(0);
      });
    };
    if(slot==="all"){render("morning",L.adh.groups.morning,db.morning);render("afterPrayer",L.adh.groups.afterPrayer,db.afterPrayer);render("evening",L.adh.groups.evening,db.evening);render("sleep",L.adh.groups.sleep,db.sleep);render("home",L.adh.groups.home,db.home);}
    else{const title=groups.find(g=>g.key===slot)?.name||"";render(slot,title,db[slot]);}
  };
  draw(sel.value,$("#adhSearch").value.trim());
  sel.onchange=()=>{localStorage.setItem("adh_sel_"+CURR_LANG,sel.value);draw(sel.value,$("#adhSearch").value.trim());};
  $("#adhSearch").oninput=()=>draw(sel.value,$("#adhSearch").value.trim());
  $("#resetAdhkar").onclick=()=>{["morning","afterPrayer","evening","sleep","home"].forEach(s=>localStorage.removeItem(adhKey(s)));draw(sel.value,$("#adhSearch").value.trim());};
}

/* =================== Quran (auto open) =================== */
const SURAH_NAMES=["Al-FƒÅti·∏•ah","Al-Baqarah","ƒÄl ‚ÄòImrƒÅn","An-NisƒÅ‚Äô","Al-MƒÅ‚Äôidah","Al-An‚ÄòƒÅm","Al-A‚ÄòrƒÅf","Al-AnfƒÅl","At-Tawbah","Y≈´nus","H≈´d","Y≈´suf","Ar-Ra‚Äòd","IbrƒÅhƒ´m","Al-·∏§ijr","An-Na·∏•l","Al-IsrƒÅ‚Äô","Al-Kahf","Maryam","·π¨ƒÅ HƒÅ","Al-AnbiyƒÅ‚Äô","Al-·∏§ajj","Al-Mu‚Äômin≈´n","An-N≈´r","Al-FurqƒÅn","Ash-Shu‚ÄòarƒÅ‚Äô","An-Naml","Al-Qa·π£a·π£","Al-‚ÄòAnkab≈´t","Ar-R≈´m","LuqmƒÅn","As-Sajdah","Al-A·∏•zƒÅb","Saba‚Äô","FƒÅ·π≠ir","YƒÅ Sƒ´n","A·π£-·π¢ƒÅffƒÅt","·π¢ƒÅd","Az-Zumar","GhƒÅfir","Fu·π£·π£ilat","Ash-Sh≈´rƒÅ","Az-Zukhruf","Ad-DukhƒÅn","Al-JƒÅthiyah","Al-A·∏•qƒÅf","Mu·∏•ammad","Al-Fat·∏•","Al-·∏§ujurƒÅt","QƒÅf","Adh-DhƒÅriyƒÅt","A·π≠-·π¨≈´r","An-Najm","Al-Qamar","Ar-Ra·∏•mƒÅn","Al-WƒÅqi‚Äòah","Al-·∏§adƒ´d","Al-MujƒÅdilah","Al-·∏§ashr","Al-Mumta·∏•anah","A·π£-·π¢aff","Al-Jumu‚Äòah","Al-MunƒÅfiq≈´n","At-TaghƒÅbun","A·π≠-·π¨alƒÅq","At-Ta·∏•rƒ´m","Al-Mulk","Al-Qalam","Al-·∏§ƒÅqqah","Al-Ma‚ÄòƒÅrij","N≈´·∏•","Al-Jinn","Al-Muzzammil","Al-Muddaththir","Al-QiyƒÅmah","Al-InsƒÅn","Al-MursalƒÅt","An-Naba‚Äô","An-NƒÅzi‚ÄòƒÅt","‚ÄòAbasa","At-Takwƒ´r","Al-Infi·π≠ƒÅr","Al-Mu·π≠affifƒ´n","Al-InshiqƒÅq","Al-Bur≈´j","A·π≠-·π¨ƒÅriq","Al-A‚ÄòlƒÅ","Al-GhƒÅshiyah","Al-Fajr","Al-Balad","Ash-Shams","Al-Layl","A·∏ç-·∏åu·∏•ƒÅ","Ash-Shar·∏•","At-Tƒ´n","Al-‚ÄòAlaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-‚ÄòƒÄdiyƒÅt","Al-QƒÅri‚Äòah","At-TakƒÅthur","Al-‚ÄòA·π£r","Al-Humazah","Al-Fƒ´l","Quraysh","Al-MƒÅ‚Äò≈´n","Al-Kawthar","Al-KƒÅfir≈´n","An-Na·π£r","Al-Masad","Al-IkhlƒÅ·π£","Al-Falaq","An-NƒÅs"];
const RECITERS=[
  {id:"afs",  name:"Mishary Al-Afasy", base:"https://server8.mp3quran.net/afs/"},
  {id:"hus",  name:"Al-Husary (Murattal)", base:"https://server8.mp3quran.net/husr/"},
  {id:"minsh",name:"Minshawi (Murattal)",  base:"https://server8.mp3quran.net/minsh/"},
  {id:"sds",  name:"Saad Al-Ghamdi",      base:"https://server8.mp3quran.net/sds/"}
];
function qKey(){return `qread_${todayKey()}_${CURR_LANG}`;}
function renderQuran(){
  const L=T[CURR_LANG];
  $("#qLabel1").textContent=L.q.s; $("#qLabel2").textContent=L.q.j; $("#reciterLabel").textContent=L.q.reciter;
  $("#markRead").textContent=L.q.mark; $("#resetRead").textContent=L.q.reset;

  const sSel=$("#surahSel"); sSel.innerHTML=""; SURAH_NAMES.forEach((n,i)=>{const o=document.createElement("option");o.value=String(i+1).padStart(3,"0");o.textContent=`${i+1}. ${n}`;sSel.appendChild(o);});
  const jSel=$("#juzSel"); jSel.innerHTML=""; for(let j=1;j<=30;j++){const o=document.createElement("option");o.value=String(j);o.textContent=`Juz ${j}`;jSel.appendChild(o);}
  const rSel=$("#reciterSel"); rSel.innerHTML=""; RECITERS.forEach(r=>{const o=document.createElement("option");o.value=r.id;o.textContent=r.name;rSel.appendChild(o);});

  const openSurah=()=>{ const surahNum=parseInt(sSel.value,10); const url=`https://quran.com/${surahNum}?reading=false&locale=${CURR_LANG==='ar'?'ar':(CURR_LANG==='fr'?'fr':'en')}`; $("#qFrame").src=url; };
  sSel.onchange=openSurah; // auto
  openSurah();             // affich√©e directement

  $("#playAudio").onclick=()=>{
    const rec=RECITERS.find(r=>r.id===$("#reciterSel").value);
    const mp3=`${rec.base}${sSel.value}.mp3`;
    const a=$("#qAudio"); a.src=mp3; a.play().catch(()=>{});
  };
  const saved=localStorage.getItem(qKey()); $("#readStatus").textContent=saved?L.q.last(saved):"";
  $("#markRead").onclick=()=>{const label=`Surah ${parseInt(sSel.value,10)} / Juz ${jSel.value} ‚Äì ${$("#reciterSel").selectedOptions[0].text}`;localStorage.setItem(qKey(),label);$("#readStatus").textContent=L.q.last(label);};
  $("#resetRead").onclick=()=>{localStorage.removeItem(qKey());$("#readStatus").textContent="";};
}

/* =================== Qibla 3D + Calibration =================== */
function computeQiblaBearing(lat,lon){const œÜ1=lat*Math.PI/180, œÜ2=21.4225*Math.PI/180;const ŒîŒª=(39.8262-lon)*Math.PI/180;const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);const x=Math.cos(œÜ1)*sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);let Œ∏=Math.atan2(y,x)*180/Math.PI;return (Œ∏+360)%360;}
function sin(x){return Math.sin(x);}
function startCompass(){
  const btn=$("#enableCompass");
  btn.onclick=async()=>{
    const need=typeof DeviceOrientationEvent!=="undefined"&&typeof DeviceOrientationEvent.requestPermission==="function";
    if(need){try{const r=await DeviceOrientationEvent.requestPermission();if(r!=="granted") return;}catch{return;}}
    window.addEventListener('deviceorientation', onOrient,true);
  };
  $("#lockTilt").onclick=()=>{LOCK_TILT=!LOCK_TILT; $("#lockTilt").classList.toggle("primary",LOCK_TILT);};
  const calib=getCalib(); $("#calib").value=calib; $("#calibVal").textContent=`${calib}¬∞`;
  $("#calib").oninput=()=>{setCalib(parseInt($("#calib").value,10)); $("#calibVal").textContent=`${getCalib()}¬∞`;};
  $("#resetCalib").onclick=()=>{setCalib(0); $("#calib").value=0; $("#calibVal").textContent="0¬∞";};
}
function getCalib(){return parseInt(localStorage.getItem("qibla_calib")||"0",10);}
function setCalib(v){localStorage.setItem("qibla_calib",String(v));}
function onOrient(e){
  let heading;
  if(e.webkitCompassHeading!==undefined) heading=e.webkitCompassHeading;
  else if(e.absolute && e.alpha!=null) heading=360-e.alpha;
  else return;

  const calib=getCalib();
  const corrected=(heading+calib+360)%360;

  const beta=e.beta??0,gamma=e.gamma??0;
  $("#needle3d").style.transform=`translate(-50%,-100%) rotateZ(${corrected}deg)`;
  if(QIBLA_BRG!=null){
    const diff=((QIBLA_BRG-corrected+540)%360)-180;
    $("#qArrow").style.transform=`translate(-50%,-100%) rotateZ(${diff}deg)`;
    $("#qiblaInfo").textContent=`Qibla : ${Math.round(QIBLA_BRG)}¬∞ ‚Ä¢ Cap : ${Math.round(corrected)}¬∞ ‚Ä¢ √âcart : ${Math.round(diff)}¬∞`;
  }
  if(!LOCK_TILT){
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    $("#q3dScene").style.transform=`rotateX(${-clamp(beta,-30,30)}deg) rotateY(${clamp(gamma,-30,30)}deg)`;
  }
}

/* =================== Adhan =================== */
const PRAYERS_ORDER=["Fajr","Dhuhr","Asr","Maghrib","Isha"];
const MUEZZINS=[
  {id:"azan1",name:"Madinah style",url:"https://cdn.islamic.network/audio/adhan/mp3/azan1.mp3"},
  {id:"azan2",name:"Makkah style", url:"https://cdn.islamic.network/audio/adhan/mp3/azan2.mp3"},
  {id:"azan3",name:"Misri",        url:"https://cdn.islamic.network/audio/adhan/mp3/azan3.mp3"},
  {id:"azan4",name:"Maghribi",     url:"https://cdn.islamic.network/audio/adhan/mp3/azan4.mp3"},
  {id:"azan5",name:"Short",        url:"https://cdn.islamic.network/audio/adhan/mp3/azan5.mp3"}
];
function adhanSettingKey(p){return `adhan_setting_${p}`;}
function getAdhanSetting(p){return localStorage.getItem(adhanSettingKey(p))||"off";}
function setAdhanSetting(p,val){localStorage.setItem(adhanSettingKey(p),val);scheduleNextAdhan();}
function muezzinKey(p){return `adhan_muezzin_${p}`;}
function getMuezzin(p){return localStorage.getItem(muezzinKey(p))||MUEZZINS[0].id;}
function setMuezzin(p,id){localStorage.setItem(muezzinKey(p),id);}

async function ensureNotifPermission(){
  if(!('Notification' in window)) return false;
  if(Notification.permission==="granted") return true;
  if(Notification.permission==="denied") return false;
  const res=await Notification.requestPermission(); return res==="granted";
}
function renderAdhanPage(){
  const L=T[CURR_LANG];
  $("#legendAdhan").textContent=L.adhan.legend;
  $("#reqNotify").textContent=L.adhan.notifAsk;
  const rows=$("#adhanRows"); rows.innerHTML="";
  if(!PRAYER_TIMINGS){ rows.innerHTML=`<tr class="adhan-row"><td colspan="5" style="padding:14px">‚Äî</td></tr>`; return; }

  PRAYERS_ORDER.forEach(p=>{
    const time=PRAYER_TIMINGS[p]; const set=getAdhanSetting(p); const mz=getMuezzin(p);
    const tr=document.createElement("tr"); tr.className="adhan-row";
    tr.innerHTML=`<td><strong>${p}</strong></td>
      <td><span class="pill-small ltr">${time}</span></td>
      <td>
        <select id="sel-${p}" class="sel">
          <option value="off">${L.adhan.off}</option>
          <option value="sound">${L.adhan.sound}</option>
          <option value="vibrate">${L.adhan.vibrate}</option>
        </select>
      </td>
      <td>
        <select id="mue-${p}" class="sel">
          ${MUEZZINS.map(m=>`<option value="${m.id}">${m.name}</option>`).join("")}
        </select>
      </td>
      <td><button class="btn" id="test-${p}">Test</button></td>`;
    rows.appendChild(tr);
    $(`#sel-${p}`).value=set; $(`#mue-${p}`).value=mz;
    $(`#sel-${p}`).addEventListener("change",(e)=>setAdhanSetting(p,e.target.value));
    $(`#mue-${p}`).addEventListener("change",(e)=>setMuezzin(p,e.target.value));
    $(`#test-${p}`).onclick=()=>triggerAdhan(p,true);
    const toggle=()=>{$(`#mue-${p}`).disabled=getAdhanSetting(p)!=="sound";$(`#mue-${p}`).classList.toggle("mute",$(`#mue-${p}`).disabled);};
    toggle(); $(`#sel-${p}`).addEventListener("change",toggle);
  });
}
function nextAdhanInfo(){
  if(!PRAYER_TIMINGS) return null;
  const now=new Date(); const nowM=now.getHours()*60+now.getMinutes();
  let bestDiff=1e9, label=null, at=null;
  for(const p of PRAYERS_ORDER){
    if(getAdhanSetting(p)==="off") continue;
    const [h,m]=PRAYER_TIMINGS[p].split(":").map(Number);
    let mins=h*60+m, diff=mins-nowM; if(diff<=0) diff+=1440;
    if(diff<bestDiff){bestDiff=diff;label=p;at=new Date(now.getTime()+diff*60000);}
  }
  if(!label) return null;
  return {label, when:at};
}
function clearAdhanTimer(){ if(ADHAN_TIMER){ clearTimeout(ADHAN_TIMER); ADHAN_TIMER=null; } }
function scheduleNextAdhan(){
  clearAdhanTimer();
  const info=nextAdhanInfo();
  if(!info){ $("#nextAdhanMsg").textContent=""; return; }
  $("#nextAdhanMsg").textContent=T[CURR_LANG].adhan.next(info.when.toLocaleTimeString());
  const delay=Math.max(0, info.when.getTime()-Date.now());
  ADHAN_TIMER=setTimeout(async()=>{ await triggerAdhan(info.label,false); scheduleNextAdhan(); }, delay);
}
function triggerAdhan(prayer, isTest=false){
  const setting=getAdhanSetting(prayer);
  if(setting==="off") return;
  if(Notification.permission==="granted"){
    new Notification(isTest?`Test Adh√¢n ‚Äì ${prayer}`:`Adh√¢n ‚Äì ${prayer}`, {body:isTest?"Essai de notification":`C‚Äôest l‚Äôheure de ${prayer}`});
  }
  if(setting==="vibrate" && navigator.vibrate){ navigator.vibrate([200,100,200,100,300]); }
  if(setting==="sound"){
    const mzId=getMuezzin(prayer);
    const src=(MUEZZINS.find(m=>m.id===mzId)||MUEZZINS[0]).url;
    const a=$("#adhanAudio"); a.src=src; a.currentTime=0; a.play().catch(()=>{});
  }
}

/* =================== Language & Tabs =================== */
function applyLanguage(){
  const L=T[CURR_LANG];
  document.documentElement.lang=CURR_LANG;
  document.documentElement.dir=(CURR_LANG==="ar")?"rtl":"ltr";
  $("#title").textContent=L.title; $("#langLabel").textContent=L.lang; $("#cityLabel").textContent=L.city;
  $("#status").textContent=L.statusGeo;
  $("#tab-home").textContent=L.tabs.home; $("#tab-plan").textContent=L.tabs.plan; $("#tab-adhkar").textContent=L.tabs.adhkar; $("#tab-quran").textContent=L.tabs.quran; $("#tab-qibla").textContent=L.tabs.qibla; $("#tab-adhan").textContent=L.tabs.adhan;
  $("#qiblaHint").innerHTML=L.qibla.hint; $("#qLabel").textContent=L.qibla.label;
  renderHome(); renderPlan(); renderAdhkar(); renderQuran(); renderAdhanPage();
}
function showPage(key){
  ["home","plan","adhkar","quran","qibla","adhan"].forEach(k=>{$(`#page-${k}`).style.display="none"; $(`#tab-${k}`).classList.remove("active");});
  $(`#page-${key}`).style.display="block"; $(`#tab-${key}`).classList.add("active");
  localStorage.setItem("last_page",key);
}

/* =================== Geolocation (auto) =================== */
async function locateAndBuild(){
  const L=T[CURR_LANG]; $("#status").textContent=L.statusGeo;
  if(!("geolocation" in navigator)){ $("#status").textContent="‚ùå "+(L.geoNo||"G√©olocalisation non support√©e"); return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude,longitude}=pos.coords;
    $("#status").textContent="üìç ‚Ä¶";
    try{
      const place=await reverseCity(latitude,longitude,CURR_LANG);
      const timings=await getTimings(latitude,longitude,place.city,place.country);
      $("#cityName").textContent=place.city;
      PRAYER_TIMINGS=timings; CURRENT_SLOTS=buildSlots(timings);
      QIBLA_BRG=(function(){ // calcul propre
        const œÜ1=latitude*Math.PI/180, œÜ2=21.4225*Math.PI/180, ŒîŒª=(39.8262-longitude)*Math.PI/180;
        const y=Math.sin(ŒîŒª)*Math.cos(œÜ2), x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
        return (Math.atan2(y,x)*180/Math.PI+360)%360;
      })();
      $("#qiblaInfo").textContent=`Qibla : ${Math.round(QIBLA_BRG)}¬∞ ‚Ä¢ Cap : ‚Äî¬∞ ‚Ä¢ √âcart : ‚Äî¬∞`;
      renderPlan(); renderAdhanPage(); scheduleNextAdhan();
      $("#status").textContent="‚úÖ OK";
      setInterval(renderPlan,60*1000);
    }catch(e){ console.error(e); $("#status").textContent="‚ö†Ô∏è Erreur de chargement des horaires"; }
  }, err=>{ console.warn(err); $("#status").textContent="‚ö†Ô∏è Acc√®s localisation refus√©"; $("#cityName").textContent="‚Äî"; }, {enableHighAccuracy:true, timeout:15000});
}

/* =================== Boot =================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  $("#lang").value=CURR_LANG;
  applyLanguage();
  showPage(localStorage.getItem("last_page")||"home");
  locateAndBuild(); // demande syst√©matique

  // Lang switch
  $("#lang").addEventListener("change", ()=>{ CURR_LANG=$("#lang").value; localStorage.setItem("pref_lang",CURR_LANG); applyLanguage(); locateAndBuild(); });

  // Nav
  $("#tab-home").onclick=()=>showPage("home");
  $("#tab-plan").onclick=()=>showPage("plan");
  $("#tab-adhkar").onclick=()=>showPage("adhkar");
  $("#tab-quran").onclick=()=>showPage("quran");
  $("#tab-qibla").onclick=()=>showPage("qibla");
  $("#tab-adhan").onclick=()=>showPage("adhan");

  // CTA
  $("#goPlan").onclick=()=>showPage("plan");
  $("#goAdhkar").onclick=()=>showPage("adhkar");
  $("#goQuran").onclick=()=>showPage("quran");
  $("#goQibla").onclick=()=>showPage("qibla");
  $("#goAdhan").onclick=()=>showPage("adhan");

  // Planning
  $("#retry").onclick=locateAndBuild;
  $("#resetDay").onclick=()=>{for(let i=0;i<9;i++) localStorage.removeItem(`done_${todayKey()}_${i}`); renderPlan();};

  // Adhan
  $("#reqNotify").onclick=ensureNotifPermission;
  $("#resync").onclick=scheduleNextAdhan;

  // Qibla
  startCompass();
});
</script>
</body>
</html>
